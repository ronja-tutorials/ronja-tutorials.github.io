<!DOCTYPE html>
<html lang="en">

  <head>

    <!-- Non social metatags -->
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <meta name="theme-color" content="#157878">

    

    <title>Flowing River</title>

    
      <!-- Update your html tag to include the itemscope and itemtype attributes. -->
<html itemscope itemtype="http://schema.org/Article">












<!-- Place this data between the <head> tags of your website -->

  <meta name="author" content="Ronja Böhringer">

<meta name="description" content="This tutorial is a case study on how to make a river via a shader. My inspiration for the look was this post by Eris https://twitter.com/Erisdraw3D/s..." />





<!-- Schema.org markup for Google+ -->
<meta itemprop="name" content="Flowing River">
<meta itemprop="description" content="This tutorial is a case study on how to make a river via a shader. My inspiration for the look was this post by Eris https://twitter.com/Erisdraw3D/s...">

  <meta itemprop="image" content="https://www.ronja-tutorials.com/assets/images/posts/033/Result.gif">


<!-- Twitter Card data -->
<meta name="twitter:card" content="summary_large_image">



<meta name="twitter:title" content="Flowing River">
<meta name="twitter:description" content="This tutorial is a case study on how to make a river via a shader. My inspiration for the look was this post by Eris https://twitter.com/Erisdraw3D/s...">


  <meta name="twitter:creator" content="@TotallyRonja">


<!-- Twitter summary card with large image must be at least 280x150px -->

  <meta name="twitter:image:src" content="https://www.ronja-tutorials.com/assets/images/posts/033/Result.gif">
  <meta property="twitter:image" content="https://www.ronja-tutorials.com/assets/images/posts/033/Result.gif">

<meta property="twitter:url" content="https://www.ronja-tutorials.com/2018/11/03/river.html">

<!-- Open Graph data -->
<meta property="og:title" content="Flowing River" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://www.ronja-tutorials.com/2018/11/03/river.html" />

  <meta property="og:image" content="https://www.ronja-tutorials.com/assets/images/posts/033/Result.gif" />

<meta property="og:description" content="This tutorial is a case study on how to make a river via a shader. My inspiration for the look was this post by Eris https://twitter.com/Erisdraw3D/s..." />
<meta property="og:site_name" content="Ronja's Shader Tutorials" />

  <meta property="article:published_time" content="2018-11-03T00:00:00+01:00" />














  





  




    

    <link rel="canonical" href="https://www.ronja-tutorials.com/2018/11/03/river.html">

    

    <!-- <link rel="shortcut icon" href="https://www.ronja-tutorials.com/favicon.ico"> -->
    <meta name="robots" content="noarchive">

    <!-- <link rel="alternate" media="only screen and (max-width: 640px)" href="">
    <link rel="alternate" media="handheld" href=""> -->


    <link href='https://fonts.googleapis.com/css?family=Open+Sans:400,700' rel='stylesheet' type='text/css'>
    <script async defer data-website-id="fb34d410-ef67-4a3a-8fdc-01a05f5e22b2" src="https://stats.ruby0x1.ca/umami.js" ></script>
    <link rel="stylesheet" href="/assets/css/style.css?v=">
  </head>
  <body>

    <header class="site-header" role="banner">

  <div class="wrapper">
    
    

    
      <a class="site-title" href="/">Ronja&#39;s Shader Tutorials</a>
    
    <!-- SVG icons from https://iconmonstr.com -->

    <!-- Twitter icon -->
    <span class="my-span-icon">
        <a href="https://twitter.com/TotallyRonja" aria-label="'s Twitter" title="'s Twitter">
          <svg class="my-svg-icon" xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24" style="margin-top: 12px;margin-left: 13px;"><path d="M12 0c-6.627 0-12 5.373-12 12s5.373 12 12 12 12-5.373 12-12-5.373-12-12-12zm6.066 9.645c.183 4.04-2.83 8.544-8.164 8.544-1.622 0-3.131-.476-4.402-1.291 1.524.18 3.045-.244 4.252-1.189-1.256-.023-2.317-.854-2.684-1.995.451.086.895.061 1.298-.049-1.381-.278-2.335-1.522-2.304-2.853.388.215.83.344 1.301.359-1.279-.855-1.641-2.544-.889-3.835 1.416 1.738 3.533 2.881 5.92 3.001-.419-1.796.944-3.527 2.799-3.527.825 0 1.572.349 2.096.907.654-.128 1.27-.368 1.824-.697-.215.671-.67 1.233-1.263 1.589.581-.07 1.135-.224 1.649-.453-.384.578-.87 1.084-1.433 1.489z"/></svg>
        </a>
      </span>

      <!-- RSS icon -->
      
        <span class="my-span-icon">
          <a href="/feed.xml" aria-label="RSS feed" title="'s RSS feed">
            <svg class="my-svg-icon" xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24"><path d="M12 0c-6.627 0-12 5.373-12 12s5.373 12 12 12 12-5.373 12-12-5.373-12-12-12zm-3.374 17c-.897 0-1.626-.727-1.626-1.624s.729-1.624 1.626-1.624 1.626.727 1.626 1.624-.729 1.624-1.626 1.624zm3.885 0c-.03-3.022-2.485-5.474-5.511-5.504v-2.406c4.361.03 7.889 3.555 7.92 7.91h-2.409zm4.081 0c-.016-5.297-4.303-9.571-9.592-9.594v-2.406c6.623.023 11.985 5.384 12 12h-2.408z"/></svg>
          </a>
        </span>
      
      <!-- Contact icon -->
      
      
        <span class="my-span-icon">
          <a href="/about.html" aria-label="Contact" title="Contact ">
            <svg class="my-svg-icon" xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24"><path d="M12 .02c-6.627 0-12 5.373-12 12s5.373 12 12 12 12-5.373 12-12-5.373-12-12-12zm6.99 6.98l-6.99 5.666-6.991-5.666h13.981zm.01 10h-14v-8.505l7 5.673 7-5.672v8.504z"/></svg>
          </a>
        </span>
      

    
      <nav class="site-nav">
        <input type="checkbox" id="nav-trigger" class="nav-trigger" />
        <label for="nav-trigger">
          <span class="menu-icon">
            <svg viewBox="0 0 18 15" width="18px" height="15px">
              <path fill="#424242" d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.031C17.335,0,18,0.665,18,1.484L18,1.484z"/>
              <path fill="#424242" d="M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0c0-0.82,0.665-1.484,1.484-1.484 h15.031C17.335,6.031,18,6.696,18,7.516L18,7.516z"/>
              <path fill="#424242" d="M18,13.516C18,14.335,17.335,15,16.516,15H1.484C0.665,15,0,14.335,0,13.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.031C17.335,12.031,18,12.696,18,13.516L18,13.516z"/>
            </svg>
          </span>
        </label>

        <div class="trigger">
          
            
            
              
              
            
          
            
            
          
            
            
              
                <a class="page-link" href="/about.html">About</a>
              
            
          
            
            
          
            
            
          
            
            
          
            
            
          
            
            
              
                <a class="page-link" href="/2018/03/20/hlsl-basics.html"></a>
              
            
          
            
            
              
                <a class="page-link" href="/2018/03/20/hlsl-basics.html"></a>
              
            
          
            
            
              
                <a class="page-link" href="/2018/03/20/hlsl-basics.html"></a>
              
            
          
            
            
              
                <a class="page-link" href="/2018/03/20/hlsl-basics.html"></a>
              
            
          
            
            
          
            
            
          
        </div>
      </nav>
    
  </div>
</header>


    
    
    

    <section class="page-header">
      <h1 class="project-name">Flowing River</h1>
      <h2 class="project-tagline"></h2>
      
      <!-- Post tagline -->
      
        <h2 class="project-date">
        <time datetime="2018-11-03T00:00:00+01:00" itemprop="datePublished">
          
          Nov 3, 2018
        </time>
        
        
          • <span itemprop="author" itemscope itemtype="http://schema.org/Person"><span itemprop="name">Ronja Böhringer</span></span>
        
        </h2>
      
      <!-- End: Post tagline -->
    </section>

    <section class="main-content">

      <article itemscope itemtype="http://schema.org/BlogPosting">

  <!-- <header class="post-header">
    <h1 class="post-title" itemprop="name headline">Flowing River</h1>
    <p class="post-meta">
      <time datetime="2018-11-03T00:00:00+01:00" itemprop="datePublished">
        
        Nov 3, 2018
      </time>
      </p>
  </header> -->

  
<ul>
  <li><a href="#transparent-surface-shader">Transparent Surface Shader</a></li>
  <li><a href="#scrolling-uvs">Scrolling UVs</a></li>
  <li><a href="#multiple-scrolling-textures">Multiple scrolling textures</a></li>
  <li><a href="#foam">Foam</a></li>
  <li><a href="#source">Source</a></li>
</ul>

  <div itemprop="articleBody">
    <p>This tutorial is a case study on how to make a river via a shader. My inspiration for the look was this post by Eris <a href="https://twitter.com/Erisdraw3D/status/1056931358185086976">https://twitter.com/Erisdraw3D/status/1056931358185086976</a>.</p>

<p>The Tutorial is done via a surface shader, so if you don’t know how they work it’s best to read the <a href="/2018/03/30/simple-surface.html">tutorial on surface shaders</a> first.</p>

<p><img src="/assets/images/posts/033/Result.gif" alt="" /></p>

<h2 id="transparent-surface-shader">Transparent Surface Shader</h2>

<p>We’ll start with a transparent surface shader, for that we’ll have to add the <code class="language-plaintext highlighter-rouge">alpha</code> attribute to our surface shader declaration. Then we’ll change the tags so the rendertype is <code class="language-plaintext highlighter-rouge">"Transparent"</code>, it uses the <code class="language-plaintext highlighter-rouge">"Transparent"</code> Queue index and we’ll disable shadows for the material by setting <code class="language-plaintext highlighter-rouge">"ForceNoShadowCasting"</code> to <code class="language-plaintext highlighter-rouge">"True"</code>. Last we set the shader target to 4.0, that will allow us to use more interpolators(variables in the vertex to fragment struct) later that we’ll need.</p>

<div class="language-glsl highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">//in subshader</span>
<span class="n">Tags</span> <span class="p">{</span> <span class="s">"RenderType"</span><span class="o">=</span><span class="s">"Transparent"</span> <span class="s">"Queue"</span><span class="o">=</span><span class="s">"Transparent"</span> <span class="s">"ForceNoShadowCasting"</span><span class="o">=</span><span class="s">"True"</span><span class="p">}</span>

<span class="c1">//in CGPROGRAM</span>
<span class="cp">#pragma surface surf Standard fullforwardshadows alpha
#pragma target 4.0
</span></code></pre></div></div>

<p>Then we’ll just render the base color of the river. We’ll set up a property for it. Then in the surface function we’ll apply the value to a color variable and write the rgb values to the albedo variable of the output struct and the alpha to the alpha variable of the output struct. We won’t touch the metallic or smoothness values, simply because changing them won’t fit the style I’m trying to archieve, but I encourage you to change them and see how result looks with different values.</p>

<div class="language-glsl highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">Properties</span> <span class="p">{</span>
    <span class="n">_Color</span> <span class="p">(</span><span class="s">"Base Color"</span><span class="p">,</span> <span class="n">Color</span><span class="p">)</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
<span class="p">}</span>
</code></pre></div></div>

<div class="language-glsl highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">//shader variables</span>
<span class="n">fixed4</span> <span class="n">_Color</span><span class="p">;</span>
</code></pre></div></div>

<div class="language-glsl highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">void</span> <span class="nf">surf</span> <span class="p">(</span><span class="n">Input</span> <span class="n">IN</span><span class="p">,</span> <span class="k">inout</span> <span class="n">SurfaceOutputStandard</span> <span class="n">o</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">float4</span> <span class="n">col</span> <span class="o">=</span> <span class="n">_Color</span><span class="p">;</span>
    <span class="n">o</span><span class="p">.</span><span class="n">Albedo</span> <span class="o">=</span> <span class="n">col</span><span class="p">.</span><span class="n">rgb</span><span class="p">;</span>
    <span class="n">o</span><span class="p">.</span><span class="n">Alpha</span> <span class="o">=</span> <span class="n">col</span><span class="p">.</span><span class="n">a</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>

<p><img src="/assets/images/posts/033/PlainTransparent.png" alt="" /></p>

<h2 id="scrolling-uvs">Scrolling UVs</h2>

<p>Next we’ll add a scrolling texture to the shader. First we’ll add the properties we need. The texture itself, the tint of the texture, and the direction it scrolls in. Above those variables we add a header to show to the user that those variables are to regulate the first layer of specs. For the uv coordinates of the texture we’ll add a variable that’s called <code class="language-plaintext highlighter-rouge">uv</code>+<code class="language-plaintext highlighter-rouge">TextureName</code> to our input struct.</p>

<div class="language-glsl highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">Properties</span> <span class="p">{</span>
    <span class="n">_Color</span> <span class="p">(</span><span class="s">"Base Color"</span><span class="p">,</span> <span class="n">Color</span><span class="p">)</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>

    <span class="p">[</span><span class="n">Header</span><span class="p">(</span><span class="n">Spec</span> <span class="n">Layer</span> <span class="mi">1</span><span class="p">)]</span>
    <span class="n">_Specs1</span> <span class="p">(</span><span class="s">"Specs"</span><span class="p">,</span> <span class="mi">2</span><span class="n">D</span><span class="p">)</span> <span class="o">=</span> <span class="s">"white"</span> <span class="p">{}</span>
    <span class="n">_SpecColor1</span> <span class="p">(</span><span class="s">"Spec Color"</span><span class="p">,</span> <span class="n">Color</span><span class="p">)</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">_SpecDirection1</span> <span class="p">(</span><span class="s">"Spec Direction"</span><span class="p">,</span> <span class="n">Vector</span><span class="p">)</span> <span class="o">=</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
<span class="p">}</span>
</code></pre></div></div>

<div class="language-glsl highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">struct</span> <span class="n">Input</span> <span class="p">{</span>
    <span class="n">float2</span> <span class="n">uv_Specs1</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>

<div class="language-glsl highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">//shader variables</span>
<span class="kt">sampler2D</span> <span class="n">_Specs1</span><span class="p">;</span>
<span class="n">fixed4</span> <span class="n">_SpecColor1</span><span class="p">;</span>
<span class="n">float2</span> <span class="n">_SpecDirection1</span><span class="p">;</span>
</code></pre></div></div>

<p>Then after we set that up, we can use the scrolling in the surface shader. First we calculate the spec coordinates by adding the direction of the scrolling multiplied by the time to the base coordinates of the texture. We get the time by accessing the <code class="language-plaintext highlighter-rouge">_Time.y</code> variable. In the y parameter is the unscaled time while the x, z, and w paramters store the time scaled by different factors.</p>

<p>Then we access the specs texture at the calculated coordinates and multiply it by the tint. After we did that we can use mix it with the existing color. First we interpolate from the rgb components of the color so far to the rgb components of the specs based on the alpha channel of the specs and apply it to the rgb components of the color. Then we interpolate from the alpha value of the color so far to 1 based on the alpha channel of the spec color and apply the result to the alpha channel of our color. By interpolating from the base color to the new color based on the alpha value we make it so when the new texture has a alpha value of 0 (is completely transparent), it doesn’t change the color at all. If it’s completely visible(alpha of 1), we use the new color. The reason that we do the alpha value separately is that if we would interpolate the whole color based on the alpha of the spec color, it could lower the alpha value at some parts, making the surface more see-through, but we always want add to the alpha, so interpolating from the existing value to being completely opaque gives us the results we want.</p>

<div class="language-glsl highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">void</span> <span class="nf">surf</span> <span class="p">(</span><span class="n">Input</span> <span class="n">IN</span><span class="p">,</span> <span class="k">inout</span> <span class="n">SurfaceOutputStandard</span> <span class="n">o</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">fixed4</span> <span class="n">col</span> <span class="o">=</span> <span class="n">_Color</span><span class="p">;</span>

    <span class="n">float2</span> <span class="n">specCoordinates1</span> <span class="o">=</span> <span class="n">IN</span><span class="p">.</span><span class="n">uv_Specs1</span> <span class="o">+</span> <span class="n">_SpecDirection1</span> <span class="o">*</span> <span class="n">_Time</span><span class="p">.</span><span class="n">y</span><span class="p">;</span>
    <span class="n">fixed4</span> <span class="n">specLayer1</span> <span class="o">=</span> <span class="n">tex2D</span><span class="p">(</span><span class="n">_Specs1</span><span class="p">,</span> <span class="n">specCoordinates1</span><span class="p">)</span> <span class="o">*</span> <span class="n">_SpecColor1</span><span class="p">;</span>
    <span class="n">col</span><span class="p">.</span><span class="n">rgb</span> <span class="o">=</span> <span class="n">lerp</span><span class="p">(</span><span class="n">col</span><span class="p">.</span><span class="n">rgb</span><span class="p">,</span> <span class="n">specLayer1</span><span class="p">.</span><span class="n">rgb</span><span class="p">,</span> <span class="n">specLayer1</span><span class="p">.</span><span class="n">a</span><span class="p">);</span>
    <span class="n">col</span><span class="p">.</span><span class="n">a</span> <span class="o">=</span> <span class="n">lerp</span><span class="p">(</span><span class="n">col</span><span class="p">.</span><span class="n">a</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">specLayer1</span><span class="p">.</span><span class="n">a</span><span class="p">);</span>

    <span class="cm">/*fixed4 specLayer2 = tex2D(_Specs2, IN.uv_Specs2 + _SpecDirection2 * _Time.y);
    col.rgb = lerp(col.rgb, specLayer2.rgb * _SpecColor2, specLayer2.a);
    col.a = col.a + specLayer2.a;

    float4 projCoords = UNITY_PROJ_COORD(IN.screenPos);
    float rawZ = SAMPLE_DEPTH_TEXTURE_PROJ(_CameraDepthTexture, projCoords);
    float sceneZ = LinearEyeDepth(rawZ);
    float partZ = IN.eyeDepth;

    float foam = 1-saturate((sceneZ - partZ) / _FoamAmount);
    float foamNoise = tex2D(_FoamNoise, IN.uv_FoamNoise + _FoamDirection * _Time.y);
    foam = saturate(foam - foamNoise);

    col.rgb = lerp(col.rgb, _FoamColor, foam);
    col.a += foam;*/</span>

    <span class="n">o</span><span class="p">.</span><span class="n">Albedo</span> <span class="o">=</span> <span class="n">col</span><span class="p">.</span><span class="n">rgb</span><span class="p">;</span>
    <span class="n">o</span><span class="p">.</span><span class="n">Alpha</span> <span class="o">=</span> <span class="n">col</span><span class="p">.</span><span class="n">a</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>

<p><img src="/assets/images/posts/033/ScrollingSpecs.gif" alt="" /></p>

<p>For this to word it’s important to set up your river mesh the correct way! The coordinates have to be continous and along the flow of the river. I use blender for modelling and my unwrapping workflow is to autounwrap the whole river once automatically, then I choose a random quad and scale the right and left edge in the x direction to 0 so they’re completely vertical, then I scale the upper and lower edge in the y direction so they’re completely horizonal. After that I select the corrected quad and unwrap the whole river again with the “follow active quads” mode. You can make the river move faster in some places by changing it so the uv coordinates of the vertices are closer together at those places. (I did that where the water goes down a bit)</p>

<p><img src="/assets/images/posts/033/RiverUnwrap.gif" alt="" /></p>

<p>For the specs texture, I did a cutoff on a perlin noise and baked that into a texture via my <a href="/2018/10/13/baking_shaders.html">material baking tool</a>. Here is the texture:</p>

<p><img src="/assets/images/posts/033/RiverSpecs1.png" alt="" /></p>

<p>And here are the other values I used:</p>

<p><img src="/assets/images/posts/033/SpecLayer1Settings.png" alt="" /></p>

<h2 id="multiple-scrolling-textures">Multiple scrolling textures</h2>

<p>We can simply repeat this process to add another scrolling texture to the river. This new texture will override the color of the old one where it’s visible. So we’ll add a new specs texture, tint and scrolling direction as well as a uv set in the input struct.</p>

<div class="language-glsl highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">//in properties</span>
<span class="p">[</span><span class="n">Header</span><span class="p">(</span><span class="n">Spec</span> <span class="n">Layer</span> <span class="mi">2</span><span class="p">)]</span>
<span class="n">_Specs2</span> <span class="p">(</span><span class="s">"Specs"</span><span class="p">,</span> <span class="mi">2</span><span class="n">D</span><span class="p">)</span> <span class="o">=</span> <span class="s">"white"</span> <span class="p">{}</span>
<span class="n">_SpecColor2</span> <span class="p">(</span><span class="s">"Spec Color"</span><span class="p">,</span> <span class="n">Color</span><span class="p">)</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
<span class="n">_SpecDirection2</span> <span class="p">(</span><span class="s">"Spec Direction"</span><span class="p">,</span> <span class="n">Vector</span><span class="p">)</span> <span class="o">=</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
</code></pre></div></div>

<div class="language-glsl highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">//in shader variables</span>
<span class="kt">sampler2D</span> <span class="n">_Specs2</span><span class="p">;</span>
<span class="n">fixed4</span> <span class="n">_SpecColor2</span><span class="p">;</span>
<span class="n">float2</span> <span class="n">_SpecDirection2</span><span class="p">;</span>
</code></pre></div></div>

<div class="language-glsl highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">//input struct</span>
<span class="k">struct</span> <span class="n">Input</span> <span class="p">{</span>
    <span class="n">float2</span> <span class="n">uv_Specs1</span><span class="p">;</span>
    <span class="n">float2</span> <span class="n">uv_Specs2</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>

<div class="language-glsl highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">//in surface function</span>
<span class="n">float2</span> <span class="n">specCoordinates2</span> <span class="o">=</span> <span class="n">IN</span><span class="p">.</span><span class="n">uv_Specs2</span> <span class="o">+</span> <span class="n">_SpecDirection2</span> <span class="o">*</span> <span class="n">_Time</span><span class="p">.</span><span class="n">y</span><span class="p">;</span>
<span class="n">fixed4</span> <span class="n">specLayer2</span> <span class="o">=</span> <span class="n">tex2D</span><span class="p">(</span><span class="n">_Specs2</span><span class="p">,</span> <span class="n">specCoordinates2</span><span class="p">)</span> <span class="o">*</span> <span class="n">_SpecColor2</span><span class="p">;</span>
<span class="n">col</span><span class="p">.</span><span class="n">rgb</span> <span class="o">=</span> <span class="n">lerp</span><span class="p">(</span><span class="n">col</span><span class="p">.</span><span class="n">rgb</span><span class="p">,</span> <span class="n">specLayer2</span><span class="p">.</span><span class="n">rgb</span><span class="p">,</span> <span class="n">specLayer2</span><span class="p">.</span><span class="n">a</span><span class="p">);</span>
<span class="n">col</span><span class="p">.</span><span class="n">a</span> <span class="o">=</span> <span class="n">lerp</span><span class="p">(</span><span class="n">col</span><span class="p">.</span><span class="n">a</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">specLayer2</span><span class="p">.</span><span class="n">a</span><span class="p">);</span>
</code></pre></div></div>

<p><img src="/assets/images/posts/033/TwoLayerScrollingSpecs.gif" alt="" /></p>

<p>To make the new specs texture I also used a cutoff perlin noise, but with a higher frequency and lower cutoff value. It’s this texture:</p>

<p><img src="/assets/images/posts/033/RiverSpecs2.png" alt="" /></p>

<p>And the other settings for the second specs layer look like this:</p>

<p><img src="/assets/images/posts/033/SpecLayer2Settings.png" alt="" /></p>

<h2 id="foam">Foam</h2>

<p>As a last detail to the shader we will add foam near objects in the water. For this we will use a very common technique where we’ll compare the depth of the object behind the water with the depth of the water surface.</p>

<p>Before we start, we set up the properties of the foam. We’ll use a noise texture to make the foam vary over time, it’ll also need a custom uv parameter in the input struct. Then we’ll use a direction to make the noise move, just like we did with the specs earlier. And we add a color for the foam and a variable to regulate how visible in the water the shader will check for objects.</p>

<div class="language-glsl highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">//in properties</span>
<span class="p">[</span><span class="n">Header</span><span class="p">(</span><span class="n">Foam</span><span class="p">)]</span>
<span class="n">_FoamNoise</span><span class="p">(</span><span class="s">"Foam Noise"</span><span class="p">,</span> <span class="mi">2</span><span class="n">D</span><span class="p">)</span> <span class="o">=</span> <span class="s">"white"</span> <span class="p">{}</span>
<span class="n">_FoamDirection</span> <span class="p">(</span><span class="s">"Foam Direction"</span><span class="p">,</span> <span class="n">Vector</span><span class="p">)</span> <span class="o">=</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
<span class="n">_FoamColor</span> <span class="p">(</span><span class="s">"Foam Color"</span><span class="p">,</span> <span class="n">Color</span><span class="p">)</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
<span class="n">_FoamAmount</span> <span class="p">(</span><span class="s">"Foam Amount"</span><span class="p">,</span> <span class="n">Range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span> <span class="o">=</span> <span class="mi">1</span>
</code></pre></div></div>

<div class="language-glsl highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">//in shader variables</span>
<span class="kt">sampler2D</span> <span class="n">_FoamNoise</span><span class="p">;</span>
<span class="n">fixed4</span> <span class="n">_FoamColor</span><span class="p">;</span>
<span class="kt">float</span> <span class="n">_FoamAmount</span><span class="p">;</span>
<span class="n">float2</span> <span class="n">_FoamDirection</span><span class="p">;</span>
</code></pre></div></div>

<div class="language-glsl highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">//input struct</span>
<span class="k">struct</span> <span class="n">Input</span> <span class="p">{</span>
    <span class="n">float2</span> <span class="n">uv_Specs1</span><span class="p">;</span>
    <span class="n">float2</span> <span class="n">uv_Specs2</span><span class="p">;</span>
    <span class="n">float2</span> <span class="n">uv_FoamNoise</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>

<p>We start by getting the depth of the surface. Because surface shaders don’t have a function that can generate them for us, we have to write our own vertex function. First we add it to our surface shader declaration, then we write it. In it we just initialize the input struct for the surface function, then we write the depth to it via the COMPUTE_EYEDEPTH macro. To save it into the input struct we’ll extend it to also hold a eyedepth variable.</p>

<div class="language-glsl highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">//surface shader declaration</span>
<span class="cp">#pragma surface surf Standard vertex:vert fullforwardshadows alpha
</span></code></pre></div></div>

<div class="language-glsl highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">//input struct</span>
<span class="k">struct</span> <span class="n">Input</span> <span class="p">{</span>
    <span class="n">float2</span> <span class="n">uv_Specs1</span><span class="p">;</span>
    <span class="n">float2</span> <span class="n">uv_Specs2</span><span class="p">;</span>
    <span class="n">float2</span> <span class="n">uv_FoamNoise</span><span class="p">;</span>
    <span class="kt">float</span> <span class="n">eyeDepth</span><span class="p">;</span>
<span class="p">};</span>
</code></pre></div></div>

<div class="language-glsl highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">void</span> <span class="nf">vert</span> <span class="p">(</span><span class="k">inout</span> <span class="n">appdata_full</span> <span class="n">v</span><span class="p">,</span> <span class="k">out</span> <span class="n">Input</span> <span class="n">o</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">UNITY_INITIALIZE_OUTPUT</span><span class="p">(</span><span class="n">Input</span><span class="p">,</span> <span class="n">o</span><span class="p">);</span>
    <span class="n">COMPUTE_EYEDEPTH</span><span class="p">(</span><span class="n">o</span><span class="p">.</span><span class="n">eyeDepth</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div></div>

<p>Then we get the depth behind the surface by reading from the depth texture. So we add a new texture variable called _CameraDepthTexture. By adding it to our shader it will be automatically assigned. To read from it we have to get the screen coordinates, luckily we can get them easily by adding a variable called <code class="language-plaintext highlighter-rouge">screenPos</code> to our input struct.</p>

<p>In the surface function we can then get the projection coordinate by passing the screenPos to the <code class="language-plaintext highlighter-rouge">UNITY_PROJ_COORD</code> macro. With it we can sample the depth texture by passing the depth texture as well as the projection coordinates to the <code class="language-plaintext highlighter-rouge">SAMPLE_DEPTH_TEXTURE_PROJ</code> macro to get the raw depth. The last step to get the scene depth from that is to simply pass it to the <code class="language-plaintext highlighter-rouge">LinearEyeDepth</code> function.</p>

<div class="language-glsl highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">//input struct</span>
<span class="k">struct</span> <span class="n">Input</span> <span class="p">{</span>
    <span class="n">float2</span> <span class="n">uv_Specs1</span><span class="p">;</span>
    <span class="n">float2</span> <span class="n">uv_Specs2</span><span class="p">;</span>
    <span class="n">float2</span> <span class="n">uv_FoamNoise</span><span class="p">;</span>
    <span class="kt">float</span> <span class="n">eyeDepth</span><span class="p">;</span>
    <span class="n">float4</span> <span class="n">screenPos</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>

<div class="language-glsl highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">//shader variables</span>
<span class="n">sampler2D_float</span> <span class="n">_CameraDepthTexture</span><span class="p">;</span>
</code></pre></div></div>

<div class="language-glsl highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">//in surface function</span>
<span class="n">float4</span> <span class="n">projCoords</span> <span class="o">=</span> <span class="n">UNITY_PROJ_COORD</span><span class="p">(</span><span class="n">IN</span><span class="p">.</span><span class="n">screenPos</span><span class="p">);</span>
<span class="kt">float</span> <span class="n">rawZ</span> <span class="o">=</span> <span class="n">SAMPLE_DEPTH_TEXTURE_PROJ</span><span class="p">(</span><span class="n">_CameraDepthTexture</span><span class="p">,</span> <span class="n">projCoords</span><span class="p">);</span>
<span class="kt">float</span> <span class="n">sceneZ</span> <span class="o">=</span> <span class="n">LinearEyeDepth</span><span class="p">(</span><span class="n">rawZ</span><span class="p">);</span>
<span class="kt">float</span> <span class="n">surfaceZ</span> <span class="o">=</span> <span class="n">IN</span><span class="p">.</span><span class="n">eyeDepth</span><span class="p">;</span>
</code></pre></div></div>

<p>Now that we have this data we can compare it. We simply subtract the depth of the surface from the depth of the scene. Then we divide it by the amount of foam, so the more foam we have, the slower the value grows. This value will start at 0 when the surface below is very close and grow the further away it is. Instead we want the foam to start at full opacity and become less visible the further away the ground gets, so we subtract it from one. Then as a last step before rendering the foam we’ll clamp it between 0 and 1 to avoid weird interpolation artefacts.</p>

<div class="language-glsl highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">float</span> <span class="n">foam</span> <span class="o">=</span> <span class="mi">1</span><span class="o">-</span><span class="p">((</span><span class="n">sceneZ</span> <span class="o">-</span> <span class="n">surfaceZ</span><span class="p">)</span> <span class="o">/</span> <span class="n">_FoamAmount</span><span class="p">);</span>
<span class="n">foam</span> <span class="o">=</span> <span class="n">saturate</span><span class="p">(</span><span class="n">foam</span><span class="p">);</span>

<span class="n">o</span><span class="p">.</span><span class="n">Albedo</span> <span class="o">=</span> <span class="n">foam</span><span class="p">;</span>
<span class="n">o</span><span class="p">.</span><span class="n">Alpha</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<span class="k">return</span><span class="p">;</span>
</code></pre></div></div>

<p><img src="/assets/images/posts/033/FoamVis.png" alt="" /></p>

<p>Then that we have the foam we can mix it into the color just the we did with the specs. Because the foam is just a simple value and not a color, we multiply it with the foam color alpha manually, this allows us to make the foam factor in less by lessening the alpha of it’s color.</p>

<div class="language-glsl highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">float</span> <span class="n">foam</span> <span class="o">=</span> <span class="mi">1</span><span class="o">-</span><span class="p">((</span><span class="n">sceneZ</span> <span class="o">-</span> <span class="n">surfaceZ</span><span class="p">)</span> <span class="o">/</span> <span class="n">_FoamAmount</span><span class="p">);</span>
<span class="n">foam</span> <span class="o">=</span> <span class="n">saturate</span><span class="p">(</span><span class="n">foam</span><span class="p">);</span>
<span class="n">col</span><span class="p">.</span><span class="n">rgb</span> <span class="o">=</span> <span class="n">lerp</span><span class="p">(</span><span class="n">col</span><span class="p">.</span><span class="n">rgb</span><span class="p">,</span> <span class="n">_FoamColor</span><span class="p">.</span><span class="n">rgb</span><span class="p">,</span> <span class="n">foam</span><span class="p">);</span>
<span class="n">col</span><span class="p">.</span><span class="n">a</span> <span class="o">=</span> <span class="n">lerp</span><span class="p">(</span><span class="n">col</span><span class="p">.</span><span class="n">a</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">foam</span> <span class="o">*</span> <span class="n">_FoamColor</span><span class="p">.</span><span class="n">a</span><span class="p">);</span>
</code></pre></div></div>

<p><img src="/assets/images/posts/033/StraightFoam.gif" alt="" /></p>

<p>To make the foam more interresting and lively, we then subtract a noise texture from it. We calculate the uv coordinates for it just like before - by adding the direction multiplied by the time to the base coordinates. Then we read the texture, but only use the red channel because the foam is a simple value without color. The subtraction of of the texture from the foam is just before the clamping.</p>

<div class="language-glsl highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">float2</span> <span class="n">foamCoords</span> <span class="o">=</span> <span class="n">IN</span><span class="p">.</span><span class="n">uv_FoamNoise</span> <span class="o">+</span> <span class="n">_FoamDirection</span> <span class="o">*</span> <span class="n">_Time</span><span class="p">.</span><span class="n">y</span><span class="p">;</span>
<span class="kt">float</span> <span class="n">foamNoise</span> <span class="o">=</span> <span class="n">tex2D</span><span class="p">(</span><span class="n">_FoamNoise</span><span class="p">,</span> <span class="n">foamCoords</span><span class="p">).</span><span class="n">r</span><span class="p">;</span>
<span class="kt">float</span> <span class="n">foam</span> <span class="o">=</span> <span class="mi">1</span><span class="o">-</span><span class="p">((</span><span class="n">sceneZ</span> <span class="o">-</span> <span class="n">surfaceZ</span><span class="p">)</span> <span class="o">/</span> <span class="n">_FoamAmount</span><span class="p">);</span>
<span class="n">foam</span> <span class="o">=</span> <span class="n">saturate</span><span class="p">(</span><span class="n">foam</span> <span class="o">-</span> <span class="n">foamNoise</span><span class="p">);</span>
<span class="n">col</span><span class="p">.</span><span class="n">rgb</span> <span class="o">=</span> <span class="n">lerp</span><span class="p">(</span><span class="n">col</span><span class="p">.</span><span class="n">rgb</span><span class="p">,</span> <span class="n">_FoamColor</span><span class="p">.</span><span class="n">rgb</span><span class="p">,</span> <span class="n">foam</span><span class="p">);</span>
<span class="n">col</span><span class="p">.</span><span class="n">a</span> <span class="o">=</span> <span class="n">lerp</span><span class="p">(</span><span class="n">col</span><span class="p">.</span><span class="n">a</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">foam</span> <span class="o">*</span> <span class="n">_FoamColor</span><span class="p">.</span><span class="n">a</span><span class="p">);</span>
</code></pre></div></div>

<p>With this we have a complete river shader.</p>

<p><img src="/assets/images/posts/033/Result.gif" alt="" /></p>

<p>For the foam noise I used a normal tiling perlin noise baked into a texture. This is the texture:</p>

<p><img src="/assets/images/posts/033/FoamNoise.png" alt="" /></p>

<p>And those are all settings I used for the material:</p>

<p><img src="/assets/images/posts/033/AllSettings.png" alt="" /></p>

<h2 id="source">Source</h2>

<ul>
  <li><a href="https://github.com/ronja-tutorials/ShaderTutorials/blob/master/Assets/033_River/FlowingRiver.shader">https://github.com/ronja-tutorials/ShaderTutorials/blob/master/Assets/033_River/FlowingRiver.shader</a></li>
</ul>

<div class="language-glsl highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">Shader</span> <span class="s">"Tutorial/033_River"</span> <span class="p">{</span>
    <span class="n">Properties</span> <span class="p">{</span>
        <span class="n">_Color</span> <span class="p">(</span><span class="s">"Base Color"</span><span class="p">,</span> <span class="n">Color</span><span class="p">)</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>

        <span class="p">[</span><span class="n">Header</span><span class="p">(</span><span class="n">Spec</span> <span class="n">Layer</span> <span class="mi">1</span><span class="p">)]</span>
        <span class="n">_Specs1</span> <span class="p">(</span><span class="s">"Specs"</span><span class="p">,</span> <span class="mi">2</span><span class="n">D</span><span class="p">)</span> <span class="o">=</span> <span class="s">"white"</span> <span class="p">{}</span>
        <span class="n">_SpecColor1</span> <span class="p">(</span><span class="s">"Spec Color"</span><span class="p">,</span> <span class="n">Color</span><span class="p">)</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">_SpecDirection1</span> <span class="p">(</span><span class="s">"Spec Direction"</span><span class="p">,</span> <span class="n">Vector</span><span class="p">)</span> <span class="o">=</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>

        <span class="p">[</span><span class="n">Header</span><span class="p">(</span><span class="n">Spec</span> <span class="n">Layer</span> <span class="mi">2</span><span class="p">)]</span>
        <span class="n">_Specs2</span> <span class="p">(</span><span class="s">"Specs"</span><span class="p">,</span> <span class="mi">2</span><span class="n">D</span><span class="p">)</span> <span class="o">=</span> <span class="s">"white"</span> <span class="p">{}</span>
        <span class="n">_SpecColor2</span> <span class="p">(</span><span class="s">"Spec Color"</span><span class="p">,</span> <span class="n">Color</span><span class="p">)</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">_SpecDirection2</span> <span class="p">(</span><span class="s">"Spec Direction"</span><span class="p">,</span> <span class="n">Vector</span><span class="p">)</span> <span class="o">=</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>

        <span class="p">[</span><span class="n">Header</span><span class="p">(</span><span class="n">Foam</span><span class="p">)]</span>
        <span class="n">_FoamNoise</span><span class="p">(</span><span class="s">"Foam Noise"</span><span class="p">,</span> <span class="mi">2</span><span class="n">D</span><span class="p">)</span> <span class="o">=</span> <span class="s">"white"</span> <span class="p">{}</span>
        <span class="n">_FoamDirection</span> <span class="p">(</span><span class="s">"Foam Direction"</span><span class="p">,</span> <span class="n">Vector</span><span class="p">)</span> <span class="o">=</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="n">_FoamColor</span> <span class="p">(</span><span class="s">"Foam Color"</span><span class="p">,</span> <span class="n">Color</span><span class="p">)</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">_FoamAmount</span> <span class="p">(</span><span class="s">"Foam Amount"</span><span class="p">,</span> <span class="n">Range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="p">}</span>
    <span class="n">SubShader</span> <span class="p">{</span>
        <span class="n">Tags</span> <span class="p">{</span> <span class="s">"RenderType"</span><span class="o">=</span><span class="s">"Transparent"</span> <span class="s">"Queue"</span><span class="o">=</span><span class="s">"Transparent"</span> <span class="s">"ForceNoShadowCasting"</span><span class="o">=</span><span class="s">"True"</span><span class="p">}</span>
        <span class="n">LOD</span> <span class="mi">200</span>

        <span class="n">CGPROGRAM</span>
        <span class="c1">// Physically based Standard lighting model, and enable shadows on all light types, then set it to render transparent</span>
        <span class="cp">#pragma surface surf Standard vertex:vert fullforwardshadows alpha
</span>
        <span class="cp">#pragma target 4.0
</span>
        <span class="k">struct</span> <span class="n">Input</span> <span class="p">{</span>
            <span class="n">float2</span> <span class="n">uv_Specs1</span><span class="p">;</span>
            <span class="n">float2</span> <span class="n">uv_Specs2</span><span class="p">;</span>
            <span class="n">float2</span> <span class="n">uv_FoamNoise</span><span class="p">;</span>
            <span class="kt">float</span> <span class="n">eyeDepth</span><span class="p">;</span>
            <span class="n">float4</span> <span class="n">screenPos</span><span class="p">;</span>
        <span class="p">};</span>

        <span class="n">sampler2D_float</span> <span class="n">_CameraDepthTexture</span><span class="p">;</span>

        <span class="n">fixed4</span> <span class="n">_Color</span><span class="p">;</span>

        <span class="kt">sampler2D</span> <span class="n">_Specs1</span><span class="p">;</span>
        <span class="n">fixed4</span> <span class="n">_SpecColor1</span><span class="p">;</span>
        <span class="n">float2</span> <span class="n">_SpecDirection1</span><span class="p">;</span>

        <span class="kt">sampler2D</span> <span class="n">_Specs2</span><span class="p">;</span>
        <span class="n">fixed4</span> <span class="n">_SpecColor2</span><span class="p">;</span>
        <span class="n">float2</span> <span class="n">_SpecDirection2</span><span class="p">;</span>

        <span class="kt">sampler2D</span> <span class="n">_FoamNoise</span><span class="p">;</span>
        <span class="n">fixed4</span> <span class="n">_FoamColor</span><span class="p">;</span>
        <span class="kt">float</span> <span class="n">_FoamAmount</span><span class="p">;</span>
        <span class="n">float2</span> <span class="n">_FoamDirection</span><span class="p">;</span>

        <span class="kt">void</span> <span class="n">vert</span> <span class="p">(</span><span class="k">inout</span> <span class="n">appdata_full</span> <span class="n">v</span><span class="p">,</span> <span class="k">out</span> <span class="n">Input</span> <span class="n">o</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="n">UNITY_INITIALIZE_OUTPUT</span><span class="p">(</span><span class="n">Input</span><span class="p">,</span> <span class="n">o</span><span class="p">);</span>
            <span class="n">COMPUTE_EYEDEPTH</span><span class="p">(</span><span class="n">o</span><span class="p">.</span><span class="n">eyeDepth</span><span class="p">);</span>
        <span class="p">}</span>

        <span class="kt">void</span> <span class="n">surf</span> <span class="p">(</span><span class="n">Input</span> <span class="n">IN</span><span class="p">,</span> <span class="k">inout</span> <span class="n">SurfaceOutputStandard</span> <span class="n">o</span><span class="p">)</span> <span class="p">{</span>
            <span class="c1">//set river base color</span>
            <span class="n">fixed4</span> <span class="n">col</span> <span class="o">=</span> <span class="n">_Color</span><span class="p">;</span>

            <span class="c1">//add first layer of moving specs</span>
            <span class="n">float2</span> <span class="n">specCoordinates1</span> <span class="o">=</span> <span class="n">IN</span><span class="p">.</span><span class="n">uv_Specs1</span> <span class="o">+</span> <span class="n">_SpecDirection1</span> <span class="o">*</span> <span class="n">_Time</span><span class="p">.</span><span class="n">y</span><span class="p">;</span>
            <span class="n">fixed4</span> <span class="n">specLayer1</span> <span class="o">=</span> <span class="n">tex2D</span><span class="p">(</span><span class="n">_Specs1</span><span class="p">,</span> <span class="n">specCoordinates1</span><span class="p">)</span> <span class="o">*</span> <span class="n">_SpecColor1</span><span class="p">;</span>
            <span class="n">col</span><span class="p">.</span><span class="n">rgb</span> <span class="o">=</span> <span class="n">lerp</span><span class="p">(</span><span class="n">col</span><span class="p">.</span><span class="n">rgb</span><span class="p">,</span> <span class="n">specLayer1</span><span class="p">.</span><span class="n">rgb</span><span class="p">,</span> <span class="n">specLayer1</span><span class="p">.</span><span class="n">a</span><span class="p">);</span>
            <span class="n">col</span><span class="p">.</span><span class="n">a</span> <span class="o">=</span> <span class="n">lerp</span><span class="p">(</span><span class="n">col</span><span class="p">.</span><span class="n">a</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">specLayer1</span><span class="p">.</span><span class="n">a</span><span class="p">);</span>

            <span class="c1">//add second layer of moving specs</span>
            <span class="n">float2</span> <span class="n">specCoordinates2</span> <span class="o">=</span> <span class="n">IN</span><span class="p">.</span><span class="n">uv_Specs2</span> <span class="o">+</span> <span class="n">_SpecDirection2</span> <span class="o">*</span> <span class="n">_Time</span><span class="p">.</span><span class="n">y</span><span class="p">;</span>
            <span class="n">fixed4</span> <span class="n">specLayer2</span> <span class="o">=</span> <span class="n">tex2D</span><span class="p">(</span><span class="n">_Specs2</span><span class="p">,</span> <span class="n">specCoordinates2</span><span class="p">)</span> <span class="o">*</span> <span class="n">_SpecColor2</span><span class="p">;</span>
            <span class="n">col</span><span class="p">.</span><span class="n">rgb</span> <span class="o">=</span> <span class="n">lerp</span><span class="p">(</span><span class="n">col</span><span class="p">.</span><span class="n">rgb</span><span class="p">,</span> <span class="n">specLayer2</span><span class="p">.</span><span class="n">rgb</span><span class="p">,</span> <span class="n">specLayer2</span><span class="p">.</span><span class="n">a</span><span class="p">);</span>
            <span class="n">col</span><span class="p">.</span><span class="n">a</span> <span class="o">=</span> <span class="n">lerp</span><span class="p">(</span><span class="n">col</span><span class="p">.</span><span class="n">a</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">specLayer2</span><span class="p">.</span><span class="n">a</span><span class="p">);</span>

            <span class="c1">//get scene and surface depth</span>
            <span class="n">float4</span> <span class="n">projCoords</span> <span class="o">=</span> <span class="n">UNITY_PROJ_COORD</span><span class="p">(</span><span class="n">IN</span><span class="p">.</span><span class="n">screenPos</span><span class="p">);</span>
            <span class="kt">float</span> <span class="n">rawZ</span> <span class="o">=</span> <span class="n">SAMPLE_DEPTH_TEXTURE_PROJ</span><span class="p">(</span><span class="n">_CameraDepthTexture</span><span class="p">,</span> <span class="n">projCoords</span><span class="p">);</span>
            <span class="kt">float</span> <span class="n">sceneZ</span> <span class="o">=</span> <span class="n">LinearEyeDepth</span><span class="p">(</span><span class="n">rawZ</span><span class="p">);</span>
            <span class="kt">float</span> <span class="n">surfaceZ</span> <span class="o">=</span> <span class="n">IN</span><span class="p">.</span><span class="n">eyeDepth</span><span class="p">;</span>

            <span class="c1">//add foam</span>
            <span class="n">float2</span> <span class="n">foamCoords</span> <span class="o">=</span> <span class="n">IN</span><span class="p">.</span><span class="n">uv_FoamNoise</span> <span class="o">+</span> <span class="n">_FoamDirection</span> <span class="o">*</span> <span class="n">_Time</span><span class="p">.</span><span class="n">y</span><span class="p">;</span>
            <span class="kt">float</span> <span class="n">foamNoise</span> <span class="o">=</span> <span class="n">tex2D</span><span class="p">(</span><span class="n">_FoamNoise</span><span class="p">,</span> <span class="n">foamCoords</span><span class="p">).</span><span class="n">r</span><span class="p">;</span>
            <span class="kt">float</span> <span class="n">foam</span> <span class="o">=</span> <span class="mi">1</span><span class="o">-</span><span class="p">((</span><span class="n">sceneZ</span> <span class="o">-</span> <span class="n">surfaceZ</span><span class="p">)</span> <span class="o">/</span> <span class="n">_FoamAmount</span><span class="p">);</span>
            <span class="n">foam</span> <span class="o">=</span> <span class="n">saturate</span><span class="p">(</span><span class="n">foam</span> <span class="o">-</span> <span class="n">foamNoise</span><span class="p">);</span>
            <span class="n">col</span><span class="p">.</span><span class="n">rgb</span> <span class="o">=</span> <span class="n">lerp</span><span class="p">(</span><span class="n">col</span><span class="p">.</span><span class="n">rgb</span><span class="p">,</span> <span class="n">_FoamColor</span><span class="p">.</span><span class="n">rgb</span><span class="p">,</span> <span class="n">foam</span><span class="p">);</span>
            <span class="n">col</span><span class="p">.</span><span class="n">a</span> <span class="o">=</span> <span class="n">lerp</span><span class="p">(</span><span class="n">col</span><span class="p">.</span><span class="n">a</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">foam</span> <span class="o">*</span> <span class="n">_FoamColor</span><span class="p">.</span><span class="n">a</span><span class="p">);</span>

            <span class="c1">//apply values to output struct</span>
            <span class="n">o</span><span class="p">.</span><span class="n">Albedo</span> <span class="o">=</span> <span class="n">col</span><span class="p">.</span><span class="n">rgb</span><span class="p">;</span>
            <span class="n">o</span><span class="p">.</span><span class="n">Alpha</span> <span class="o">=</span> <span class="n">col</span><span class="p">.</span><span class="n">a</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="n">ENDCG</span>
    <span class="p">}</span>
    <span class="n">FallBack</span> <span class="s">"Diffuse"</span>
<span class="p">}</span>
</code></pre></div></div>

<p>I hope this tutorial helped you to create a nice looking river. If you have any questions about existing tutorials or requests for new ones, just write me.</p>


    <p>
        You can also find me on twitter at <a href="https://www.twitter.com/totallyRonja">@totallyRonja</a>. If you liked my tutorial and want to support me you can do that on Patreon (<a href="https://www.patreon.com/RonjaTutorials">patreon.com/RonjaTutorials</a>) or Ko-Fi (<a href="https://ko-fi.com/RonjaTutorials">ko-fi.com/RonjaTutorials</a>).
    </p>
  </div>

  
    <div id="disqus_thread"></div>
<script>

/**
*  RECOMMENDED CONFIGURATION VARIABLES: EDIT AND UNCOMMENT THE SECTION BELOW TO INSERT DYNAMIC VALUES FROM YOUR PLATFORM OR CMS.
*  LEARN WHY DEFINING THESE VARIABLES IS IMPORTANT: https://disqus.com/admin/universalcode/#configuration-variables*/
/*
var disqus_config = function () {
this.page.url = PAGE_URL;  // Replace PAGE_URL with your page's canonical URL variable
this.page.identifier = PAGE_IDENTIFIER; // Replace PAGE_IDENTIFIER with your page's unique identifier variable
};
*/
(function() { // DON'T EDIT BELOW THIS LINE
var d = document, s = d.createElement('script');
s.src = 'https://ronja-tutorials.disqus.com/embed.js';
s.setAttribute('data-timestamp', +new Date());
(d.head || d.body).appendChild(s);
})();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
                            
  
</article>


      <!-- SVG icons from https://iconmonstr.com -->

      <!-- Twitter icon -->
      <span class="my-span-icon">
          <a href="https://twitter.com/TotallyRonja" aria-label="'s Twitter" title="'s Twitter">
            <svg class="my-svg-icon" xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24" style="margin-top: 12px;margin-left: 13px;"><path d="M12 0c-6.627 0-12 5.373-12 12s5.373 12 12 12 12-5.373 12-12-5.373-12-12-12zm6.066 9.645c.183 4.04-2.83 8.544-8.164 8.544-1.622 0-3.131-.476-4.402-1.291 1.524.18 3.045-.244 4.252-1.189-1.256-.023-2.317-.854-2.684-1.995.451.086.895.061 1.298-.049-1.381-.278-2.335-1.522-2.304-2.853.388.215.83.344 1.301.359-1.279-.855-1.641-2.544-.889-3.835 1.416 1.738 3.533 2.881 5.92 3.001-.419-1.796.944-3.527 2.799-3.527.825 0 1.572.349 2.096.907.654-.128 1.27-.368 1.824-.697-.215.671-.67 1.233-1.263 1.589.581-.07 1.135-.224 1.649-.453-.384.578-.87 1.084-1.433 1.489z"/></svg>
          </a>
        </span>

        <!-- RSS icon -->
        
          <span class="my-span-icon">
            <a href="/feed.xml" aria-label="RSS feed" title="'s RSS feed">
              <svg class="my-svg-icon" xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24"><path d="M12 0c-6.627 0-12 5.373-12 12s5.373 12 12 12 12-5.373 12-12-5.373-12-12-12zm-3.374 17c-.897 0-1.626-.727-1.626-1.624s.729-1.624 1.626-1.624 1.626.727 1.626 1.624-.729 1.624-1.626 1.624zm3.885 0c-.03-3.022-2.485-5.474-5.511-5.504v-2.406c4.361.03 7.889 3.555 7.92 7.91h-2.409zm4.081 0c-.016-5.297-4.303-9.571-9.592-9.594v-2.406c6.623.023 11.985 5.384 12 12h-2.408z"/></svg>
            </a>
          </span>
        
        <!-- Contact icon -->
        
        
          <span class="my-span-icon">
            <a href="/about.html" aria-label="Contact" title="Contact ">
              <svg class="my-svg-icon" xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24"><path d="M12 .02c-6.627 0-12 5.373-12 12s5.373 12 12 12 12-5.373 12-12-5.373-12-12-12zm6.99 6.98l-6.99 5.666-6.991-5.666h13.981zm.01 10h-14v-8.505l7 5.673 7-5.672v8.504z"/></svg>
            </a>
          </span>
        
    </section>

    
      <script type="text/javascript">
        (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
        (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
        m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
        })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

        ga('create', 'UA-124040112-1', 'auto');
        ga('send', 'pageview');
      </script>
    
  </body>
</html>
