<!DOCTYPE html>
<html lang="en">

  <head>

    <!-- Non social metatags -->
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <meta name="theme-color" content="#157878">

    

    <title>Stencil Buffers</title>

    
      <!-- Update your html tag to include the itemscope and itemtype attributes. -->
<html itemscope itemtype="http://schema.org/Article">












<!-- Place this data between the <head> tags of your website -->

  <meta name="author" content="Ronja Böhringer">

<meta name="description" content="Summary" />





<!-- Schema.org markup for Google+ -->
<meta itemprop="name" content="Stencil Buffers">
<meta itemprop="description" content="Summary">

  <meta itemprop="image" content="https://www.ronja-tutorials.com/assets/images/posts/022/Result.gif">


<!-- Twitter Card data -->
<meta name="twitter:card" content="summary_large_image">



<meta name="twitter:title" content="Stencil Buffers">
<meta name="twitter:description" content="Summary">


  <meta name="twitter:creator" content="@TotallyRonja">


<!-- Twitter summary card with large image must be at least 280x150px -->

  <meta name="twitter:image:src" content="https://www.ronja-tutorials.com/assets/images/posts/022/Result.gif">
  <meta property="twitter:image" content="https://www.ronja-tutorials.com/assets/images/posts/022/Result.gif">

<meta property="twitter:url" content="https://www.ronja-tutorials.com/2018/08/18/stencil-buffers.html">

<!-- Open Graph data -->
<meta property="og:title" content="Stencil Buffers" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://www.ronja-tutorials.com/2018/08/18/stencil-buffers.html" />

  <meta property="og:image" content="https://www.ronja-tutorials.com/assets/images/posts/022/Result.gif" />

<meta property="og:description" content="Summary" />
<meta property="og:site_name" content="Ronja's Shader Tutorials" />

  <meta property="article:published_time" content="2018-08-18T00:00:00+02:00" />














  





  




    

    <link rel="canonical" href="https://www.ronja-tutorials.com/2018/08/18/stencil-buffers.html">

    

    <!-- <link rel="shortcut icon" href="https://www.ronja-tutorials.com/favicon.ico"> -->
    <meta name="robots" content="noarchive">

    <!-- <link rel="alternate" media="only screen and (max-width: 640px)" href="">
    <link rel="alternate" media="handheld" href=""> -->


    <link href='https://fonts.googleapis.com/css?family=Open+Sans:400,700' rel='stylesheet' type='text/css'>
    <script async defer data-website-id="fb34d410-ef67-4a3a-8fdc-01a05f5e22b2" src="https://stats.ruby0x1.ca/umami.js" ></script>
    <link rel="stylesheet" href="/assets/css/style.css?v=">
  </head>
  <body>

    <header class="site-header" role="banner">

  <div class="wrapper">
    
    

    
      <a class="site-title" href="/">Ronja&#39;s Shader Tutorials</a>
    
    <!-- SVG icons from https://iconmonstr.com -->

    <!-- Twitter icon -->
    <span class="my-span-icon">
        <a href="https://twitter.com/TotallyRonja" aria-label="'s Twitter" title="'s Twitter">
          <svg class="my-svg-icon" xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24" style="margin-top: 12px;margin-left: 13px;"><path d="M12 0c-6.627 0-12 5.373-12 12s5.373 12 12 12 12-5.373 12-12-5.373-12-12-12zm6.066 9.645c.183 4.04-2.83 8.544-8.164 8.544-1.622 0-3.131-.476-4.402-1.291 1.524.18 3.045-.244 4.252-1.189-1.256-.023-2.317-.854-2.684-1.995.451.086.895.061 1.298-.049-1.381-.278-2.335-1.522-2.304-2.853.388.215.83.344 1.301.359-1.279-.855-1.641-2.544-.889-3.835 1.416 1.738 3.533 2.881 5.92 3.001-.419-1.796.944-3.527 2.799-3.527.825 0 1.572.349 2.096.907.654-.128 1.27-.368 1.824-.697-.215.671-.67 1.233-1.263 1.589.581-.07 1.135-.224 1.649-.453-.384.578-.87 1.084-1.433 1.489z"/></svg>
        </a>
      </span>

      <!-- RSS icon -->
      
        <span class="my-span-icon">
          <a href="/feed.xml" aria-label="RSS feed" title="'s RSS feed">
            <svg class="my-svg-icon" xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24"><path d="M12 0c-6.627 0-12 5.373-12 12s5.373 12 12 12 12-5.373 12-12-5.373-12-12-12zm-3.374 17c-.897 0-1.626-.727-1.626-1.624s.729-1.624 1.626-1.624 1.626.727 1.626 1.624-.729 1.624-1.626 1.624zm3.885 0c-.03-3.022-2.485-5.474-5.511-5.504v-2.406c4.361.03 7.889 3.555 7.92 7.91h-2.409zm4.081 0c-.016-5.297-4.303-9.571-9.592-9.594v-2.406c6.623.023 11.985 5.384 12 12h-2.408z"/></svg>
          </a>
        </span>
      
      <!-- Contact icon -->
      
      
        <span class="my-span-icon">
          <a href="/about.html" aria-label="Contact" title="Contact ">
            <svg class="my-svg-icon" xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24"><path d="M12 .02c-6.627 0-12 5.373-12 12s5.373 12 12 12 12-5.373 12-12-5.373-12-12-12zm6.99 6.98l-6.99 5.666-6.991-5.666h13.981zm.01 10h-14v-8.505l7 5.673 7-5.672v8.504z"/></svg>
          </a>
        </span>
      

    
      <nav class="site-nav">
        <input type="checkbox" id="nav-trigger" class="nav-trigger" />
        <label for="nav-trigger">
          <span class="menu-icon">
            <svg viewBox="0 0 18 15" width="18px" height="15px">
              <path fill="#424242" d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.031C17.335,0,18,0.665,18,1.484L18,1.484z"/>
              <path fill="#424242" d="M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0c0-0.82,0.665-1.484,1.484-1.484 h15.031C17.335,6.031,18,6.696,18,7.516L18,7.516z"/>
              <path fill="#424242" d="M18,13.516C18,14.335,17.335,15,16.516,15H1.484C0.665,15,0,14.335,0,13.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.031C17.335,12.031,18,12.696,18,13.516L18,13.516z"/>
            </svg>
          </span>
        </label>

        <div class="trigger">
          
            
            
              
              
            
          
            
            
          
            
            
              
                <a class="page-link" href="/about.html">About</a>
              
            
          
            
            
          
            
            
          
            
            
          
            
            
          
            
            
              
                <a class="page-link" href="/2018/03/20/hlsl-basics.html"></a>
              
            
          
            
            
              
                <a class="page-link" href="/2018/03/20/hlsl-basics.html"></a>
              
            
          
            
            
              
                <a class="page-link" href="/2018/03/20/hlsl-basics.html"></a>
              
            
          
            
            
              
                <a class="page-link" href="/2018/03/20/hlsl-basics.html"></a>
              
            
          
            
            
          
            
            
          
        </div>
      </nav>
    
  </div>
</header>


    
    
    

    <section class="page-header">
      <h1 class="project-name">Stencil Buffers</h1>
      <h2 class="project-tagline"></h2>
      
      <!-- Post tagline -->
      
        <h2 class="project-date">
        <time datetime="2018-08-18T00:00:00+02:00" itemprop="datePublished">
          
          Aug 18, 2018
        </time>
        
        
          • <span itemprop="author" itemscope itemtype="http://schema.org/Person"><span itemprop="name">Ronja Böhringer</span></span>
        
        </h2>
      
      <!-- End: Post tagline -->
    </section>

    <section class="main-content">

      <article itemscope itemtype="http://schema.org/BlogPosting">

  <!-- <header class="post-header">
    <h1 class="post-title" itemprop="name headline">Stencil Buffers</h1>
    <p class="post-meta">
      <time datetime="2018-08-18T00:00:00+02:00" itemprop="datePublished">
        
        Aug 18, 2018
      </time>
      </p>
  </header> -->

  
<ul>
  <li><a href="#summary">Summary</a></li>
  <li><a href="#reading-from-the-stencil-buffer">Reading from the Stencil Buffer</a></li>
  <li><a href="#writing-to-the-stencil-buffer">Writing to the Stencil Buffer</a></li>
  <li><a href="#source">Source</a></li>
</ul>

  <div itemprop="articleBody">
    <h2 id="summary">Summary</h2>

<p>The depth buffer helps us compare depths of objects to ensure they occlude each other properly. But theres also a part of the stencil buffer reserved for “stencil operations”. This part of the depth buffer is commonly referred to as stencil buffer. Stencil buffers are mostly used to only render parts of objects while discarding others.</p>

<p>The stencil buffer is also used by unity internally for the deferred graphics pipeline, so if you do deferred rendering, some limitations apply. For those limitations and other more indepth information on how to use the stencil buffer in unity you can read here: <a href="https://docs.unity3d.com/Manual/SL-Stencil.html">https://docs.unity3d.com/Manual/SL-Stencil.html</a>.</p>

<p>This tutorial will go into some of the basics of the stencil buffer and show read and write from it. We will start with the <a href="/2018/03/30/simple-surface.html">basic surface shader</a>) but it works just as well with all other types of shaders including unlit and postprocessing ones. In any case you should understand <a href="/basics.html">basics shaders</a> before getting into manipulating stencil buffers.</p>

<p><img src="/assets/images/posts/022/Result.gif" alt="" /></p>

<h2 id="reading-from-the-stencil-buffer">Reading from the Stencil Buffer</h2>

<p>The shader which will read from the stencil buffer will draw itself, but only where the buffer has a specific value, everywhere else it will be discarded.</p>

<p>All stencil operations are done via a small stencil code block outside of our hlsl code. Like most shaderlab things we can write them in our subshader to use them for the whole subshader or in the shader pass to use them only in that one shader pass. Because in surface shaders our shader passes are generated automatically by unity, we’ll write it in the subshader in this case.</p>

<div class="language-glsl highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">SubShader</span> <span class="p">{</span>
    <span class="n">Tags</span><span class="p">{</span> <span class="s">"RenderType"</span><span class="o">=</span><span class="s">"Opaque"</span> <span class="s">"Queue"</span><span class="o">=</span><span class="s">"Geometry"</span><span class="p">}</span>

    <span class="n">Stencil</span><span class="p">{</span>
        <span class="c1">//stencil operation</span>
    <span class="p">}</span>

    <span class="c1">//surface shader code...</span>
</code></pre></div></div>

<p>The most important parameter of the stencil operation is <code class="language-plaintext highlighter-rouge">Ref</code> which marks the reference value we operate on. The default value is 0 which is the default value the buffer has before anything writes to it. We’ll set it to 0 at first which doesn’t change anything, but having it typed out explicitely makes the code a bit clearer and let’s us change it easily later.</p>

<p>Another parameter of the stencil operation we need is <code class="language-plaintext highlighter-rouge">Comp</code> which defines when the stencil operation passes. The default value is <code class="language-plaintext highlighter-rouge">Always</code>, which means that no matter what reference value we use, the object will always be drawn. For this shader reading from the stencil buffer we’ll use <code class="language-plaintext highlighter-rouge">Equal</code> which results in the object only being drawn when the stencil buffer at that position is at the value we mark as <code class="language-plaintext highlighter-rouge">Ref</code>.</p>

<div class="language-glsl highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">Stencil</span><span class="p">{</span>
    <span class="n">Ref</span> <span class="mi">0</span>
    <span class="n">Comp</span> <span class="n">Equal</span>
<span class="p">}</span>
</code></pre></div></div>

<p><img src="/assets/images/posts/022/NormalMaterial.png" alt="" /></p>

<p>With this our material looks just like before, that’s because the value of the stencil buffer is 0 everywhere and that’s the value we compare to. If we change the reference value to any other number our material will be completely invisible because the comparison fails.</p>

<div class="language-glsl highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">Stencil</span><span class="p">{</span>
    <span class="n">Ref</span> <span class="mi">1</span>
    <span class="n">Comp</span> <span class="n">Equal</span>
<span class="p">}</span>
</code></pre></div></div>

<p><img src="/assets/images/posts/022/Invisible.png" alt="" /></p>

<p>Before we start writing a new shader I’d like to add the possibility to change the reference value from the inspector. For that we first add a property with a range going from 0 to 255, that includes all values the stencil buffer can have. Then we add the <code class="language-plaintext highlighter-rouge">[IntRange]</code> attribute to the property to ensure we can only choose whole values.</p>

<div class="language-glsl highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">Properties</span> <span class="p">{</span>
    <span class="n">_Color</span> <span class="p">(</span><span class="s">"Tint"</span><span class="p">,</span> <span class="n">Color</span><span class="p">)</span> <span class="o">=</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">_MainTex</span> <span class="p">(</span><span class="s">"Texture"</span><span class="p">,</span> <span class="mi">2</span><span class="n">D</span><span class="p">)</span> <span class="o">=</span> <span class="s">"white"</span> <span class="p">{}</span>
    <span class="n">_Smoothness</span> <span class="p">(</span><span class="s">"Smoothness"</span><span class="p">,</span> <span class="n">Range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">_Metallic</span> <span class="p">(</span><span class="s">"Metalness"</span><span class="p">,</span> <span class="n">Range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="p">[</span><span class="n">HDR</span><span class="p">]</span> <span class="n">_Emission</span> <span class="p">(</span><span class="s">"Emission"</span><span class="p">,</span> <span class="n">color</span><span class="p">)</span> <span class="o">=</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span>

    <span class="p">[</span><span class="n">IntRange</span><span class="p">]</span> <span class="n">_StencilRef</span> <span class="p">(</span><span class="s">"Stencil Reference Value"</span><span class="p">,</span> <span class="n">Range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">255</span><span class="p">))</span> <span class="o">=</span> <span class="mi">0</span>
<span class="p">}</span>
</code></pre></div></div>

<p>Then to use the reference value in the stencil operation, we put it behind the <code class="language-plaintext highlighter-rouge">Ref</code>, but put it in square brackets. In this context the square brackets tell unity to parse the value as a property. With this in place we still only have the choice between visible (0) and invisible (all other values), but we can easily switch between the values.</p>

<div class="language-glsl highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">Stencil</span><span class="p">{</span>
    <span class="n">Ref</span> <span class="p">[</span><span class="n">_StencilRef</span><span class="p">]</span>
    <span class="n">Comp</span> <span class="n">Equal</span>
<span class="p">}</span>
</code></pre></div></div>

<h2 id="writing-to-the-stencil-buffer">Writing to the Stencil Buffer</h2>

<p>To make real use from our shader which reads from the stencil buffer, we’ll write a second one which reads from it. This second shader will not write to the screen itself and will render before the first shader, so we make sure the stencil buffer already has the correct values written to it when we read from it.</p>

<p>For this shader we start with a basic unlit shader, like in <a href="/basics.html">the basics</a> because it’s so simple and we don’t need much. For it to not render to the screen at all and just manipulate the stencil buffer we’ll add a few other small detail to it though.</p>

<p>First we let the fragment shader just return 0, because we don’t care about the return value anyways. Then we set the blending to <code class="language-plaintext highlighter-rouge">Zero One</code>, which means that the the color that is returned by the shader will be completely ignored and the color that was rendered before will be preserved completely. Another change to make the shader not render is that we’ll tell it to not write to the Z buffer. Otherwise it would occlude objects behind it and because we want to see other things though the surface we don’t want that at all. And the last change is to ensure the material renders before the materials which might read from the stencil buffer: We change the queue from <code class="language-plaintext highlighter-rouge">geometry</code> to <code class="language-plaintext highlighter-rouge">geomety-1</code> which puts it earlier in the render queue.</p>

<p>Then we also delete the color variable and property because they became obsolete.</p>

<div class="language-glsl highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">fixed4</span> <span class="n">frag</span><span class="p">(</span><span class="n">v2f</span> <span class="n">i</span><span class="p">)</span> <span class="o">:</span> <span class="n">SV_TARGET</span><span class="p">{</span>
    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>

<div class="language-glsl highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">Blend</span> <span class="n">Zero</span> <span class="n">One</span>
<span class="n">ZWrite</span> <span class="n">Off</span>
</code></pre></div></div>

<div class="language-glsl highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="s">"Queue"</span><span class="o">=</span><span class="s">"Geometry-1"</span>
</code></pre></div></div>

<div class="language-glsl highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">//show values to edit in inspector</span>
<span class="n">Properties</span><span class="p">{</span>

<span class="p">}</span>
</code></pre></div></div>

<p><img src="/assets/images/posts/022/Invisible.png" alt="" /></p>

<p>With this we’ve made another completely invisible shader, but with the advantage that it stays invisble no matter what the stencil buffer value is and that it actually draws something so we can stick a stencil operation to it.</p>

<p>We start by copying the stencil block and the ref property from the first shader. Then we change the comparison operation to <code class="language-plaintext highlighter-rouge">Always</code> this means the material won’t compare the ref value to the buffer and just draw the output of the shader. Then we add a new attribute called <code class="language-plaintext highlighter-rouge">Pass</code>, it declares what will happen when the comparison with the zbuffer is successful, so what happens if the object isn’t occluded. And we set it to the value of <code class="language-plaintext highlighter-rouge">Replace</code>, which means it’ll take the ref value and write it to the stencil buffer. Theres also a attribute called <code class="language-plaintext highlighter-rouge">Fail</code> if you want to specify what will happen when the object is occluded, but it’s set to not do anything by default so we won’t touch it.</p>

<div class="language-glsl highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">Stencil</span><span class="p">{</span>
    <span class="n">Ref</span> <span class="p">[</span><span class="n">_StencilRef</span><span class="p">]</span>
    <span class="n">Comp</span> <span class="n">Always</span>
    <span class="n">Pass</span> <span class="n">Replace</span>
<span class="p">}</span>
</code></pre></div></div>

<p><img src="/assets/images/posts/022/SphereAndQuad.png" alt="" /></p>

<p>Now you can see the first material when it is at the same pixel on the screen as the second and has the same reference value.</p>

<p>And with those two shaders you already know the basics on how to use stencil buffers in unity. If you want to learn more, you can look at the official documentation of stencil buffers here <a href="https://docs.unity3d.com/Manual/SL-Stencil.html">https://docs.unity3d.com/Manual/SL-Stencil.html</a> or just experiment with them to see what possibilities they open.</p>

<p><img src="/assets/images/posts/022/WrongStencil.png" alt="" /></p>

<p>When trying things out I ran into the problem that when using multiple stencil values to read/write the one that’s behind can be rendered later and will then overwrite the value from the buffer in the front. If you run into that problem a solution is to change the render queue of the materials. That’s because unity sorts all materials with a render queue higher than 2500 so they’re rendered furthest away to closest. usually this is done to ensure transparent object are drawn properly, but it works just as well to make sure we render the correct stencil values. In my example I used 2501 for the stencil write materials and 2502 for the stencil read materials. important is just that we render the write materials before the read materials and that we give them a queue order below 3000, otherwise we might mess with drawing of transparent objects.</p>

<p><img src="/assets/images/posts/022/WriteInspector.png" alt="" /></p>

<p><img src="/assets/images/posts/022/ReadInspector.png" alt="" /></p>

<p><img src="/assets/images/posts/022/Result.gif" alt="" /></p>

<h2 id="source">Source</h2>

<div class="language-glsl highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">Shader</span> <span class="s">"Tutorial/022_stencil_buffer/read"</span> <span class="p">{</span>
	<span class="n">Properties</span> <span class="p">{</span>
		<span class="n">_Color</span> <span class="p">(</span><span class="s">"Tint"</span><span class="p">,</span> <span class="n">Color</span><span class="p">)</span> <span class="o">=</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
		<span class="n">_MainTex</span> <span class="p">(</span><span class="s">"Texture"</span><span class="p">,</span> <span class="mi">2</span><span class="n">D</span><span class="p">)</span> <span class="o">=</span> <span class="s">"white"</span> <span class="p">{}</span>
		<span class="n">_Smoothness</span> <span class="p">(</span><span class="s">"Smoothness"</span><span class="p">,</span> <span class="n">Range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span> <span class="o">=</span> <span class="mi">0</span>
		<span class="n">_Metallic</span> <span class="p">(</span><span class="s">"Metalness"</span><span class="p">,</span> <span class="n">Range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span> <span class="o">=</span> <span class="mi">0</span>
		<span class="p">[</span><span class="n">HDR</span><span class="p">]</span> <span class="n">_Emission</span> <span class="p">(</span><span class="s">"Emission"</span><span class="p">,</span> <span class="n">color</span><span class="p">)</span> <span class="o">=</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span>

		<span class="p">[</span><span class="n">IntRange</span><span class="p">]</span> <span class="n">_StencilRef</span> <span class="p">(</span><span class="s">"Stencil Reference Value"</span><span class="p">,</span> <span class="n">Range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">255</span><span class="p">))</span> <span class="o">=</span> <span class="mi">0</span>
	<span class="p">}</span>
	<span class="n">SubShader</span> <span class="p">{</span>
		<span class="n">Tags</span><span class="p">{</span> <span class="s">"RenderType"</span><span class="o">=</span><span class="s">"Opaque"</span> <span class="s">"Queue"</span><span class="o">=</span><span class="s">"Geometry"</span><span class="p">}</span>

        <span class="c1">//stencil operation</span>
		<span class="n">Stencil</span><span class="p">{</span>
			<span class="n">Ref</span> <span class="p">[</span><span class="n">_StencilRef</span><span class="p">]</span>
			<span class="n">Comp</span> <span class="n">Equal</span>
		<span class="p">}</span>

		<span class="n">CGPROGRAM</span>

		<span class="cp">#pragma surface surf Standard fullforwardshadows
</span>		<span class="cp">#pragma target 3.0
</span>
		<span class="kt">sampler2D</span> <span class="n">_MainTex</span><span class="p">;</span>
		<span class="n">fixed4</span> <span class="n">_Color</span><span class="p">;</span>

		<span class="kr">half</span> <span class="n">_Smoothness</span><span class="p">;</span>
		<span class="kr">half</span> <span class="n">_Metallic</span><span class="p">;</span>
		<span class="n">half3</span> <span class="n">_Emission</span><span class="p">;</span>

		<span class="k">struct</span> <span class="n">Input</span> <span class="p">{</span>
			<span class="n">float2</span> <span class="n">uv_MainTex</span><span class="p">;</span>
		<span class="p">};</span>

		<span class="kt">void</span> <span class="n">surf</span> <span class="p">(</span><span class="n">Input</span> <span class="n">i</span><span class="p">,</span> <span class="k">inout</span> <span class="n">SurfaceOutputStandard</span> <span class="n">o</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">fixed4</span> <span class="n">col</span> <span class="o">=</span> <span class="n">tex2D</span><span class="p">(</span><span class="n">_MainTex</span><span class="p">,</span> <span class="n">i</span><span class="p">.</span><span class="n">uv_MainTex</span><span class="p">);</span>
			<span class="n">col</span> <span class="o">*=</span> <span class="n">_Color</span><span class="p">;</span>
			<span class="n">o</span><span class="p">.</span><span class="n">Albedo</span> <span class="o">=</span> <span class="n">col</span><span class="p">.</span><span class="n">rgb</span><span class="p">;</span>
			<span class="n">o</span><span class="p">.</span><span class="n">Metallic</span> <span class="o">=</span> <span class="n">_Metallic</span><span class="p">;</span>
			<span class="n">o</span><span class="p">.</span><span class="n">Smoothness</span> <span class="o">=</span> <span class="n">_Smoothness</span><span class="p">;</span>
			<span class="n">o</span><span class="p">.</span><span class="n">Emission</span> <span class="o">=</span> <span class="n">_Emission</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">ENDCG</span>
	<span class="p">}</span>
	<span class="n">FallBack</span> <span class="s">"Standard"</span>
<span class="p">}</span>
</code></pre></div></div>

<div class="language-glsl highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">Shader</span> <span class="s">"Tutorial/022_stencil_buffer/write"</span><span class="p">{</span>
	<span class="c1">//show values to edit in inspector</span>
	<span class="n">Properties</span><span class="p">{</span>
		<span class="p">[</span><span class="n">IntRange</span><span class="p">]</span> <span class="n">_StencilRef</span> <span class="p">(</span><span class="s">"Stencil Reference Value"</span><span class="p">,</span> <span class="n">Range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">255</span><span class="p">))</span> <span class="o">=</span> <span class="mi">0</span>
	<span class="p">}</span>

	<span class="n">SubShader</span><span class="p">{</span>
		<span class="c1">//the material is completely non-transparent and is rendered at the same time as the other opaque geometry</span>
		<span class="n">Tags</span><span class="p">{</span> <span class="s">"RenderType"</span><span class="o">=</span><span class="s">"Opaque"</span> <span class="s">"Queue"</span><span class="o">=</span><span class="s">"Geometry-1"</span><span class="p">}</span>

        <span class="c1">//stencil operation</span>
		<span class="n">Stencil</span><span class="p">{</span>
			<span class="n">Ref</span> <span class="p">[</span><span class="n">_StencilRef</span><span class="p">]</span>
			<span class="n">Comp</span> <span class="n">Always</span>
			<span class="n">Pass</span> <span class="n">Replace</span>
		<span class="p">}</span>

		<span class="n">Pass</span><span class="p">{</span>
            <span class="c1">//don't draw color or depth</span>
			<span class="n">Blend</span> <span class="n">Zero</span> <span class="n">One</span>
			<span class="n">ZWrite</span> <span class="n">Off</span>

			<span class="n">CGPROGRAM</span>
			<span class="cp">#include "UnityCG.cginc"
</span>
			<span class="cp">#pragma vertex vert
</span>			<span class="cp">#pragma fragment frag
</span>
			<span class="k">struct</span> <span class="n">appdata</span><span class="p">{</span>
				<span class="n">float4</span> <span class="n">vertex</span> <span class="o">:</span> <span class="n">POSITION</span><span class="p">;</span>
			<span class="p">};</span>

			<span class="k">struct</span> <span class="n">v2f</span><span class="p">{</span>
				<span class="n">float4</span> <span class="n">position</span> <span class="o">:</span> <span class="n">SV_POSITION</span><span class="p">;</span>
			<span class="p">};</span>

			<span class="n">v2f</span> <span class="n">vert</span><span class="p">(</span><span class="n">appdata</span> <span class="n">v</span><span class="p">){</span>
				<span class="n">v2f</span> <span class="n">o</span><span class="p">;</span>
				<span class="c1">//calculate the position in clip space to render the object</span>
				<span class="n">o</span><span class="p">.</span><span class="n">position</span> <span class="o">=</span> <span class="n">UnityObjectToClipPos</span><span class="p">(</span><span class="n">v</span><span class="p">.</span><span class="n">vertex</span><span class="p">);</span>
				<span class="k">return</span> <span class="n">o</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="n">fixed4</span> <span class="n">frag</span><span class="p">(</span><span class="n">v2f</span> <span class="n">i</span><span class="p">)</span> <span class="o">:</span> <span class="n">SV_TARGET</span><span class="p">{</span>
				<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="n">ENDCG</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>I hope this tutorial helped you understand how to use the stencil buffer and how to archieve cool effects with it.</p>

<p>You can also find the source here:</p>

<ul>
  <li><a href="https://github.com/ronja-tutorials/ShaderTutorials/blob/master/Assets/022_Stencil_Buffer/stencil_read.shader">https://github.com/ronja-tutorials/ShaderTutorials/blob/master/Assets/022_Stencil_Buffer/stencil_read.shader</a></li>
  <li><a href="https://github.com/ronja-tutorials/ShaderTutorials/blob/master/Assets/022_Stencil_Buffer/stencil_write.shader">https://github.com/ronja-tutorials/ShaderTutorials/blob/master/Assets/022_Stencil_Buffer/stencil_write.shader</a></li>
</ul>


    <p>
        You can also find me on twitter at <a href="https://www.twitter.com/totallyRonja">@totallyRonja</a>. If you liked my tutorial and want to support me you can do that on Patreon (<a href="https://www.patreon.com/RonjaTutorials">patreon.com/RonjaTutorials</a>) or Ko-Fi (<a href="https://ko-fi.com/RonjaTutorials">ko-fi.com/RonjaTutorials</a>).
    </p>
  </div>

  
    <div id="disqus_thread"></div>
<script>

/**
*  RECOMMENDED CONFIGURATION VARIABLES: EDIT AND UNCOMMENT THE SECTION BELOW TO INSERT DYNAMIC VALUES FROM YOUR PLATFORM OR CMS.
*  LEARN WHY DEFINING THESE VARIABLES IS IMPORTANT: https://disqus.com/admin/universalcode/#configuration-variables*/
/*
var disqus_config = function () {
this.page.url = PAGE_URL;  // Replace PAGE_URL with your page's canonical URL variable
this.page.identifier = PAGE_IDENTIFIER; // Replace PAGE_IDENTIFIER with your page's unique identifier variable
};
*/
(function() { // DON'T EDIT BELOW THIS LINE
var d = document, s = d.createElement('script');
s.src = 'https://ronja-tutorials.disqus.com/embed.js';
s.setAttribute('data-timestamp', +new Date());
(d.head || d.body).appendChild(s);
})();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
                            
  
</article>


      <!-- SVG icons from https://iconmonstr.com -->

      <!-- Twitter icon -->
      <span class="my-span-icon">
          <a href="https://twitter.com/TotallyRonja" aria-label="'s Twitter" title="'s Twitter">
            <svg class="my-svg-icon" xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24" style="margin-top: 12px;margin-left: 13px;"><path d="M12 0c-6.627 0-12 5.373-12 12s5.373 12 12 12 12-5.373 12-12-5.373-12-12-12zm6.066 9.645c.183 4.04-2.83 8.544-8.164 8.544-1.622 0-3.131-.476-4.402-1.291 1.524.18 3.045-.244 4.252-1.189-1.256-.023-2.317-.854-2.684-1.995.451.086.895.061 1.298-.049-1.381-.278-2.335-1.522-2.304-2.853.388.215.83.344 1.301.359-1.279-.855-1.641-2.544-.889-3.835 1.416 1.738 3.533 2.881 5.92 3.001-.419-1.796.944-3.527 2.799-3.527.825 0 1.572.349 2.096.907.654-.128 1.27-.368 1.824-.697-.215.671-.67 1.233-1.263 1.589.581-.07 1.135-.224 1.649-.453-.384.578-.87 1.084-1.433 1.489z"/></svg>
          </a>
        </span>

        <!-- RSS icon -->
        
          <span class="my-span-icon">
            <a href="/feed.xml" aria-label="RSS feed" title="'s RSS feed">
              <svg class="my-svg-icon" xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24"><path d="M12 0c-6.627 0-12 5.373-12 12s5.373 12 12 12 12-5.373 12-12-5.373-12-12-12zm-3.374 17c-.897 0-1.626-.727-1.626-1.624s.729-1.624 1.626-1.624 1.626.727 1.626 1.624-.729 1.624-1.626 1.624zm3.885 0c-.03-3.022-2.485-5.474-5.511-5.504v-2.406c4.361.03 7.889 3.555 7.92 7.91h-2.409zm4.081 0c-.016-5.297-4.303-9.571-9.592-9.594v-2.406c6.623.023 11.985 5.384 12 12h-2.408z"/></svg>
            </a>
          </span>
        
        <!-- Contact icon -->
        
        
          <span class="my-span-icon">
            <a href="/about.html" aria-label="Contact" title="Contact ">
              <svg class="my-svg-icon" xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24"><path d="M12 .02c-6.627 0-12 5.373-12 12s5.373 12 12 12 12-5.373 12-12-5.373-12-12-12zm6.99 6.98l-6.99 5.666-6.991-5.666h13.981zm.01 10h-14v-8.505l7 5.673 7-5.672v8.504z"/></svg>
            </a>
          </span>
        
    </section>

    
      <script type="text/javascript">
        (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
        (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
        m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
        })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

        ga('create', 'UA-124040112-1', 'auto');
        ga('send', 'pageview');
      </script>
    
  </body>
</html>
