<!DOCTYPE html>
<html lang="en">

  <head>

    <!-- Non social metatags -->
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <meta name="theme-color" content="#157878">

    

    <title>Handling Depth for Spheretracing</title>

    
      <!-- Update your html tag to include the itemscope and itemtype attributes. -->
<html itemscope itemtype="http://schema.org/Article">












<!-- Place this data between the <head> tags of your website -->

  <meta name="author" content="Ronja Böhringer">

<meta name="description" content="In the last 2 tutorials of the volumetric rendering series I showed how to trace 3d signed distance fields and how to shade the result. In my opinion..." />





<!-- Schema.org markup for Google+ -->
<meta itemprop="name" content="Handling Depth for Spheretracing">
<meta itemprop="description" content="In the last 2 tutorials of the volumetric rendering series I showed how to trace 3d signed distance fields and how to shade the result. In my opinion...">

  <meta itemprop="image" content="https://www.ronja-tutorials.com/assets/images/posts/045/Result.png">


<!-- Twitter Card data -->
<meta name="twitter:card" content="summary_large_image">



<meta name="twitter:title" content="Handling Depth for Spheretracing">
<meta name="twitter:description" content="In the last 2 tutorials of the volumetric rendering series I showed how to trace 3d signed distance fields and how to shade the result. In my opinion...">


  <meta name="twitter:creator" content="@TotallyRonja">


<!-- Twitter summary card with large image must be at least 280x150px -->

  <meta name="twitter:image:src" content="https://www.ronja-tutorials.com/assets/images/posts/045/Result.png">
  <meta property="twitter:image" content="https://www.ronja-tutorials.com/assets/images/posts/045/Result.png">

<meta property="twitter:url" content="https://www.ronja-tutorials.com/2019/10/14/spheretracing-depth.html">

<!-- Open Graph data -->
<meta property="og:title" content="Handling Depth for Spheretracing" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://www.ronja-tutorials.com/2019/10/14/spheretracing-depth.html" />

  <meta property="og:image" content="https://www.ronja-tutorials.com/assets/images/posts/045/Result.png" />

<meta property="og:description" content="In the last 2 tutorials of the volumetric rendering series I showed how to trace 3d signed distance fields and how to shade the result. In my opinion..." />
<meta property="og:site_name" content="Ronja's Shader Tutorials" />

  <meta property="article:published_time" content="2019-10-14T00:00:00+02:00" />














  





  




    

    <link rel="canonical" href="https://www.ronja-tutorials.com/2019/10/14/spheretracing-depth.html">

    

    <!-- <link rel="shortcut icon" href="https://www.ronja-tutorials.com/favicon.ico"> -->
    <meta name="robots" content="noarchive">

    <!-- <link rel="alternate" media="only screen and (max-width: 640px)" href="">
    <link rel="alternate" media="handheld" href=""> -->


    <link href='https://fonts.googleapis.com/css?family=Open+Sans:400,700' rel='stylesheet' type='text/css'>
    <script async defer data-website-id="fb34d410-ef67-4a3a-8fdc-01a05f5e22b2" src="https://stats.ruby0x1.ca/umami.js" ></script>
    <link rel="stylesheet" href="/assets/css/style.css?v=">
  </head>
  <body>

    <header class="site-header" role="banner">

  <div class="wrapper">
    
    

    
      <a class="site-title" href="/">Ronja&#39;s Shader Tutorials</a>
    
    <!-- SVG icons from https://iconmonstr.com -->

    <!-- Twitter icon -->
    <span class="my-span-icon">
        <a href="https://twitter.com/TotallyRonja" aria-label="'s Twitter" title="'s Twitter">
          <svg class="my-svg-icon" xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24" style="margin-top: 12px;margin-left: 13px;"><path d="M12 0c-6.627 0-12 5.373-12 12s5.373 12 12 12 12-5.373 12-12-5.373-12-12-12zm6.066 9.645c.183 4.04-2.83 8.544-8.164 8.544-1.622 0-3.131-.476-4.402-1.291 1.524.18 3.045-.244 4.252-1.189-1.256-.023-2.317-.854-2.684-1.995.451.086.895.061 1.298-.049-1.381-.278-2.335-1.522-2.304-2.853.388.215.83.344 1.301.359-1.279-.855-1.641-2.544-.889-3.835 1.416 1.738 3.533 2.881 5.92 3.001-.419-1.796.944-3.527 2.799-3.527.825 0 1.572.349 2.096.907.654-.128 1.27-.368 1.824-.697-.215.671-.67 1.233-1.263 1.589.581-.07 1.135-.224 1.649-.453-.384.578-.87 1.084-1.433 1.489z"/></svg>
        </a>
      </span>

      <!-- RSS icon -->
      
        <span class="my-span-icon">
          <a href="/feed.xml" aria-label="RSS feed" title="'s RSS feed">
            <svg class="my-svg-icon" xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24"><path d="M12 0c-6.627 0-12 5.373-12 12s5.373 12 12 12 12-5.373 12-12-5.373-12-12-12zm-3.374 17c-.897 0-1.626-.727-1.626-1.624s.729-1.624 1.626-1.624 1.626.727 1.626 1.624-.729 1.624-1.626 1.624zm3.885 0c-.03-3.022-2.485-5.474-5.511-5.504v-2.406c4.361.03 7.889 3.555 7.92 7.91h-2.409zm4.081 0c-.016-5.297-4.303-9.571-9.592-9.594v-2.406c6.623.023 11.985 5.384 12 12h-2.408z"/></svg>
          </a>
        </span>
      
      <!-- Contact icon -->
      
      
        <span class="my-span-icon">
          <a href="/about.html" aria-label="Contact" title="Contact ">
            <svg class="my-svg-icon" xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24"><path d="M12 .02c-6.627 0-12 5.373-12 12s5.373 12 12 12 12-5.373 12-12-5.373-12-12-12zm6.99 6.98l-6.99 5.666-6.991-5.666h13.981zm.01 10h-14v-8.505l7 5.673 7-5.672v8.504z"/></svg>
          </a>
        </span>
      

    
      <nav class="site-nav">
        <input type="checkbox" id="nav-trigger" class="nav-trigger" />
        <label for="nav-trigger">
          <span class="menu-icon">
            <svg viewBox="0 0 18 15" width="18px" height="15px">
              <path fill="#424242" d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.031C17.335,0,18,0.665,18,1.484L18,1.484z"/>
              <path fill="#424242" d="M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0c0-0.82,0.665-1.484,1.484-1.484 h15.031C17.335,6.031,18,6.696,18,7.516L18,7.516z"/>
              <path fill="#424242" d="M18,13.516C18,14.335,17.335,15,16.516,15H1.484C0.665,15,0,14.335,0,13.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.031C17.335,12.031,18,12.696,18,13.516L18,13.516z"/>
            </svg>
          </span>
        </label>

        <div class="trigger">
          
            
            
              
              
            
          
            
            
          
            
            
              
                <a class="page-link" href="/about.html">About</a>
              
            
          
            
            
          
            
            
          
            
            
          
            
            
          
            
            
              
                <a class="page-link" href="/2018/03/20/hlsl-basics.html"></a>
              
            
          
            
            
              
                <a class="page-link" href="/2018/03/20/hlsl-basics.html"></a>
              
            
          
            
            
              
                <a class="page-link" href="/2018/03/20/hlsl-basics.html"></a>
              
            
          
            
            
              
                <a class="page-link" href="/2018/03/20/hlsl-basics.html"></a>
              
            
          
            
            
          
            
            
          
        </div>
      </nav>
    
  </div>
</header>


    
    
    

    <section class="page-header">
      <h1 class="project-name">Handling Depth for Spheretracing</h1>
      <h2 class="project-tagline"></h2>
      
      <!-- Post tagline -->
      
        <h2 class="project-date">
        <time datetime="2019-10-14T00:00:00+02:00" itemprop="datePublished">
          
          Oct 14, 2019
        </time>
        
        
          • <span itemprop="author" itemscope itemtype="http://schema.org/Person"><span itemprop="name">Ronja Böhringer</span></span>
        
        </h2>
      
      <!-- End: Post tagline -->
    </section>

    <section class="main-content">

      <article itemscope itemtype="http://schema.org/BlogPosting">

  <!-- <header class="post-header">
    <h1 class="post-title" itemprop="name headline">Handling Depth for Spheretracing</h1>
    <p class="post-meta">
      <time datetime="2019-10-14T00:00:00+02:00" itemprop="datePublished">
        
        Oct 14, 2019
      </time>
      </p>
  </header> -->

  
<ul>
  <li><a href="#minor-adjustments">Minor adjustments</a></li>
  <li><a href="#output-custom-depth">Output Custom Depth</a></li>
  <li><a href="#source">Source</a></li>
</ul>

  <div itemprop="articleBody">
    <p>In the last 2 tutorials of the volumetric rendering series I showed how
to trace 3d signed distance fields and how to shade the result. In my 
opinion the biggest drawback of the state of the shader so far is the
way that independent objects interact with each other and with regular
meshes. They either don’t write to the depth buffer at all, or with the
shape of the mesh that’s used for them and the depth check is similarly
lacking. In this tutorial I want to show you how to make volumetric
rendering work with the depth buffer just as you expect it to.</p>

<p>This tutorial starts with the code of the <a href="/2019/08/15/spheretracing-shading.html">shaded spheretracing
 tutorial</a> and you should at least understand
<a href="/2019/06/21/spheretracing-basics.html">spheretracing basics</a> before you try to understand it.</p>

<p><img src="/assets/images/posts/045/Result.png" alt="" /></p>

<h2 id="minor-adjustments">Minor adjustments</h2>

<p>If you followed my previous tutorials on volumetric rendering tutorials
I want to change a few small things for this one. Since we’re fixing the
depth, we can now enable the depth writing for the shader by adding
<code class="language-plaintext highlighter-rouge">ZWrite On</code> to the SubShader or Pass section. I also set the Render Type
to Opaque as well as define the render queue to render the object just
after regular geometry in the Tags of the SubShader.</p>

<div class="language-glsl highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">//the material is completely non-transparent and is rendered just after opaque geometry</span>
<span class="n">Tags</span><span class="p">{</span> <span class="s">"RenderType"</span><span class="o">=</span><span class="s">"Opaque"</span> <span class="s">"Queue"</span><span class="o">=</span><span class="s">"Geometry+1"</span> <span class="s">"DisableBatching"</span><span class="o">=</span><span class="s">"True"</span> <span class="s">"IgnoreProjector"</span><span class="o">=</span><span class="s">"True"</span><span class="p">}</span>
</code></pre></div></div>

<p>Additionally I want to change the setup of the tracing loop since the
color of the material is decided in a function call inside a
conditional(if) statement in the loop. I’m not 100% sure what operations
affect performance in which ways, but my gut feeling tells me that it’s
more efficient to do the heavy operations outside of the loop. And keep
calculations in conditional blocks as lightweight as possible. I
archived this by defining a <code class="language-plaintext highlighter-rouge">hitsurface</code> variable before the loop starts
and set it to false and if we actually hit a surface, it’s set to true
and the loop is aborted. This way we can then discard all pixels which
rays didn’t result in a surface hit after the loop and then return the
color. Another small change was that I renamed the function which
calculates the color to <code class="language-plaintext highlighter-rouge">renderSurface</code> and defined the samplePoint
variable before the loop so we still have access to it after it
finished. With this the new fragment function should look like this:</p>

<div class="language-glsl highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">fixed4</span> <span class="nf">frag</span><span class="p">(</span><span class="n">v2f</span> <span class="n">i</span><span class="p">){</span>
    <span class="c1">//ray information</span>
    <span class="n">float3</span> <span class="n">pos</span> <span class="o">=</span> <span class="n">i</span><span class="p">.</span><span class="n">localPosition</span><span class="p">;</span>
    <span class="n">float3</span> <span class="n">dir</span> <span class="o">=</span> <span class="n">normalize</span><span class="p">(</span><span class="n">i</span><span class="p">.</span><span class="n">viewDirection</span><span class="p">.</span><span class="n">xyz</span><span class="p">);</span>
    <span class="kt">float</span> <span class="n">progress</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">float3</span> <span class="n">samplePoint</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    
    <span class="kt">bool</span> <span class="n">hitsurface</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
    <span class="c1">//tracing loop</span>
    <span class="k">for</span> <span class="p">(</span><span class="kt">uint</span> <span class="n">iter</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">iter</span> <span class="o">&lt;</span> <span class="n">MAX_STEPS</span><span class="p">;</span> <span class="n">iter</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
        <span class="c1">//get current location on ray</span>
        <span class="n">samplePoint</span> <span class="o">=</span> <span class="n">pos</span> <span class="o">+</span> <span class="n">dir</span> <span class="o">*</span> <span class="n">progress</span><span class="p">;</span>
        <span class="c1">//get distance to closest shape</span>
        <span class="kt">float</span> <span class="n">distance</span> <span class="o">=</span> <span class="n">scene</span><span class="p">(</span><span class="n">samplePoint</span><span class="p">);</span>
        <span class="c1">//return color if inside shape</span>
        <span class="k">if</span><span class="p">(</span><span class="n">distance</span> <span class="o">&lt;</span> <span class="n">THICKNESS</span><span class="p">){</span>
            <span class="n">hitsurface</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
            <span class="k">break</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="c1">//go forwards</span>
        <span class="n">progress</span> <span class="o">=</span> <span class="n">progress</span> <span class="o">+</span> <span class="n">distance</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="c1">//discard pixel if no shape was hit</span>
    <span class="n">clip</span><span class="p">(</span><span class="n">hitsurface</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="o">-</span><span class="mi">1</span><span class="p">);</span>
    
    <span class="c1">//return surface color</span>
    <span class="k">return</span> <span class="n">renderSurface</span><span class="p">(</span><span class="n">samplePoint</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div></div>

<p><img src="/assets/images/posts/045/TracedBeforeDepth.png" alt="" /></p>

<h2 id="output-custom-depth">Output Custom Depth</h2>

<p>If we don’t worry about the depth of our surface, the shader pipeline
automatically uses the depth of the triangles of the mesh. But we also
have the possibility on many platforms to write and compare whatever
depth value we want to. To write custom depth values we can either
return a struct from the fragment function with variables for both color
and depth or what I opted to do, remove the output type of the function
by changing it to void and instead define output variables for the color
and depth values.</p>

<div class="language-glsl highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">void</span> <span class="nf">frag</span><span class="p">(</span><span class="n">v2f</span> <span class="n">i</span><span class="p">,</span> <span class="k">out</span> <span class="n">fixed4</span> <span class="n">color</span> <span class="o">:</span> <span class="n">SV_TARGET</span><span class="p">,</span> <span class="k">out</span> <span class="kt">float</span> <span class="n">depth</span> <span class="o">:</span> <span class="n">SV_Depth</span><span class="p">){</span>
</code></pre></div></div>

<p>The color variable we can set to the value we returned previously. For
the depth value we have to calculate the distance to the camera, the
most forward way to do that is to get it from the clip space position.
We calculate the clip space position in a similar way we transform
vertices into clip space in the vertex shader, via the
<code class="language-plaintext highlighter-rouge">UnityObjectToClipPos</code> macro. The <code class="language-plaintext highlighter-rouge">float4</code> result of this also has the
<code class="language-plaintext highlighter-rouge">w</code> component which we have to divide by to get regular 3d values. Since
we only care about the depth, we only divide the <code class="language-plaintext highlighter-rouge">z</code> component by the
<code class="language-plaintext highlighter-rouge">w</code> component and assign the result to the depth output value. Because
we changed the function type to void we don’t have to return anything.</p>

<div class="language-glsl highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">//calculate surface color</span>
<span class="n">color</span> <span class="o">=</span> <span class="n">renderSurface</span><span class="p">(</span><span class="n">samplePoint</span><span class="p">);</span>
<span class="c1">//calculate surface depth</span>
<span class="n">float4</span> <span class="n">tracedClipPos</span> <span class="o">=</span> <span class="n">UnityObjectToClipPos</span><span class="p">(</span><span class="n">float4</span><span class="p">(</span><span class="n">samplePoint</span><span class="p">,</span> <span class="mi">1</span><span class="p">.</span><span class="mi">0</span><span class="p">));</span>
<span class="n">depth</span> <span class="o">=</span> <span class="n">tracedClipPos</span><span class="p">.</span><span class="n">z</span> <span class="o">/</span> <span class="n">tracedClipPos</span><span class="p">.</span><span class="n">w</span><span class="p">;</span>
</code></pre></div></div>

<p><img src="/assets/images/posts/045/Result.png" alt="" /></p>

<h2 id="source">Source</h2>

<ul>
  <li><a href="https://github.com/ronja-tutorials/ShaderTutorials/blob/master/Assets/045_SphereTracingDepth/SphereTracingDepth.shader">https://github.com/ronja-tutorials/ShaderTutorials/blob/master/Assets/045_SphereTracingDepth/SphereTracingDepth.shader</a></li>
</ul>

<div class="language-glsl highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">Shader</span> <span class="s">"Tutorial/045_SphereTracingDepth"</span><span class="p">{</span>
    <span class="c1">//show values to edit in inspector</span>
    <span class="n">Properties</span><span class="p">{</span>
        <span class="n">_Color</span> <span class="p">(</span><span class="s">"Color"</span><span class="p">,</span> <span class="n">Color</span><span class="p">)</span> <span class="o">=</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
    <span class="p">}</span>
    
    <span class="n">SubShader</span><span class="p">{</span>
        <span class="c1">//the material is completely non-transparent and is rendered just after opaque geometry</span>
        <span class="n">Tags</span><span class="p">{</span> <span class="s">"RenderType"</span><span class="o">=</span><span class="s">"Opaque"</span> <span class="s">"Queue"</span><span class="o">=</span><span class="s">"Geometry+1"</span> <span class="s">"DisableBatching"</span><span class="o">=</span><span class="s">"True"</span> <span class="s">"IgnoreProjector"</span><span class="o">=</span><span class="s">"True"</span><span class="p">}</span>
    
        <span class="n">Pass</span><span class="p">{</span>
            <span class="n">ZWrite</span> <span class="n">On</span>
    
            <span class="n">CGPROGRAM</span>
            <span class="cp">#include "UnityCG.cginc"
</span>            <span class="cp">#include "Lighting.cginc"
</span>    
            <span class="cp">#pragma vertex vert
</span>            <span class="cp">#pragma fragment frag
</span>    
            <span class="c1">//surface color</span>
            <span class="n">fixed4</span> <span class="n">_Color</span><span class="p">;</span>
    
            <span class="c1">//maximum amount of steps</span>
            <span class="cp">#define MAX_STEPS 32
</span>            <span class="c1">//furthest distance that's accepted as inside surface</span>
            <span class="cp">#define THICKNESS 0.001
</span>            <span class="c1">//distance from rendered point to sample SDF for normal calculation</span>
            <span class="cp">#define NORMAL_EPSILON 0.01
</span>    
            <span class="c1">//input data</span>
            <span class="k">struct</span> <span class="n">appdata</span><span class="p">{</span>
                <span class="n">float4</span> <span class="n">vertex</span> <span class="o">:</span> <span class="n">POSITION</span><span class="p">;</span>
            <span class="p">};</span>
    
            <span class="c1">//data that goes from vertex to fragment shader</span>
            <span class="k">struct</span> <span class="n">v2f</span><span class="p">{</span>
                <span class="n">float4</span> <span class="n">position</span> <span class="o">:</span> <span class="n">SV_POSITION</span><span class="p">;</span> <span class="c1">//position in clip space</span>
                <span class="n">float4</span> <span class="n">localPosition</span> <span class="o">:</span> <span class="n">TEXCOORD0</span><span class="p">;</span> <span class="c1">//position in local space</span>
                <span class="n">float4</span> <span class="n">viewDirection</span> <span class="o">:</span> <span class="n">TEXCOORD1</span><span class="p">;</span> <span class="c1">//view direction in local space (not normalized!)</span>
            <span class="p">};</span>
    
            <span class="n">v2f</span> <span class="n">vert</span><span class="p">(</span><span class="n">appdata</span> <span class="n">v</span><span class="p">){</span>
                <span class="n">v2f</span> <span class="n">o</span><span class="p">;</span>
                <span class="c1">//position for rendering</span>
                <span class="n">o</span><span class="p">.</span><span class="n">position</span> <span class="o">=</span> <span class="n">UnityObjectToClipPos</span><span class="p">(</span><span class="n">v</span><span class="p">.</span><span class="n">vertex</span><span class="p">);</span>
                <span class="c1">//save local position for origin</span>
                <span class="n">o</span><span class="p">.</span><span class="n">localPosition</span> <span class="o">=</span> <span class="n">v</span><span class="p">.</span><span class="n">vertex</span><span class="p">;</span>
                <span class="c1">//get camera position in local space</span>
                <span class="n">float4</span> <span class="n">objectSpaceCameraPos</span> <span class="o">=</span> <span class="n">mul</span><span class="p">(</span><span class="n">unity_WorldToObject</span><span class="p">,</span> <span class="n">float4</span><span class="p">(</span><span class="n">_WorldSpaceCameraPos</span><span class="p">,</span> <span class="mi">1</span><span class="p">));</span>
                <span class="c1">//get local view vector</span>
                <span class="n">o</span><span class="p">.</span><span class="n">viewDirection</span> <span class="o">=</span> <span class="n">v</span><span class="p">.</span><span class="n">vertex</span> <span class="o">-</span> <span class="n">objectSpaceCameraPos</span><span class="p">;</span>
                <span class="k">return</span> <span class="n">o</span><span class="p">;</span>
            <span class="p">}</span>
    
    
            <span class="kt">float</span> <span class="n">scene</span><span class="p">(</span><span class="n">float3</span> <span class="n">pos</span><span class="p">){</span>
                <span class="k">return</span> <span class="n">length</span><span class="p">(</span><span class="n">pos</span><span class="p">)</span> <span class="o">-</span> <span class="mi">0</span><span class="p">.</span><span class="mi">5</span><span class="p">;</span>
            <span class="p">}</span>
    
            <span class="n">float3</span> <span class="n">normal</span><span class="p">(</span><span class="n">float3</span> <span class="n">pos</span><span class="p">){</span>
                <span class="c1">//determine change in signed distance</span>
                <span class="kt">float</span> <span class="n">changeX</span> <span class="o">=</span> <span class="n">scene</span><span class="p">(</span><span class="n">pos</span> <span class="o">+</span> <span class="n">float3</span><span class="p">(</span><span class="n">NORMAL_EPSILON</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span> <span class="o">-</span> <span class="n">scene</span><span class="p">(</span><span class="n">pos</span> <span class="o">-</span> <span class="n">float3</span><span class="p">(</span><span class="n">NORMAL_EPSILON</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">));</span>
                <span class="kt">float</span> <span class="n">changeY</span> <span class="o">=</span> <span class="n">scene</span><span class="p">(</span><span class="n">pos</span> <span class="o">+</span> <span class="n">float3</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">NORMAL_EPSILON</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span> <span class="o">-</span> <span class="n">scene</span><span class="p">(</span><span class="n">pos</span> <span class="o">-</span> <span class="n">float3</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">NORMAL_EPSILON</span><span class="p">,</span> <span class="mi">0</span><span class="p">));</span>
                <span class="kt">float</span> <span class="n">changeZ</span> <span class="o">=</span> <span class="n">scene</span><span class="p">(</span><span class="n">pos</span> <span class="o">+</span> <span class="n">float3</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">NORMAL_EPSILON</span><span class="p">))</span> <span class="o">-</span> <span class="n">scene</span><span class="p">(</span><span class="n">pos</span> <span class="o">-</span> <span class="n">float3</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">NORMAL_EPSILON</span><span class="p">));</span>
                <span class="c1">//construct normal vector</span>
                <span class="n">float3</span> <span class="n">surfaceNormal</span> <span class="o">=</span> <span class="n">float3</span><span class="p">(</span><span class="n">changeX</span><span class="p">,</span> <span class="n">changeY</span><span class="p">,</span> <span class="n">changeZ</span><span class="p">);</span>
                <span class="c1">//convert normal vector into worldspace and make it uniform length</span>
                <span class="n">surfaceNormal</span> <span class="o">=</span> <span class="n">mul</span><span class="p">(</span><span class="n">unity_ObjectToWorld</span><span class="p">,</span> <span class="n">float4</span><span class="p">(</span><span class="n">surfaceNormal</span><span class="p">,</span> <span class="mi">0</span><span class="p">));</span>
                <span class="k">return</span> <span class="n">normalize</span><span class="p">(</span><span class="n">surfaceNormal</span><span class="p">);</span>
            <span class="p">}</span>
    
            <span class="n">float4</span> <span class="n">lightColor</span><span class="p">(</span><span class="n">float3</span> <span class="n">position</span><span class="p">){</span>
                <span class="c1">//calculate needed surface and light data</span>
                <span class="n">float3</span> <span class="n">surfaceNormal</span> <span class="o">=</span> <span class="n">normal</span><span class="p">(</span><span class="n">position</span><span class="p">);</span>
                <span class="n">float3</span> <span class="n">lightDirection</span> <span class="o">=</span> <span class="n">_WorldSpaceLightPos0</span><span class="p">.</span><span class="n">xyz</span><span class="p">;</span>
    
                <span class="c1">//calculate simple shading</span>
                <span class="kt">float</span> <span class="n">lightAngle</span> <span class="o">=</span> <span class="n">saturate</span><span class="p">(</span><span class="n">dot</span><span class="p">(</span><span class="n">surfaceNormal</span><span class="p">,</span> <span class="n">lightDirection</span><span class="p">));</span>
                <span class="k">return</span> <span class="n">lightAngle</span> <span class="o">*</span> <span class="n">_LightColor0</span><span class="p">;</span>
            <span class="p">}</span>
    
            <span class="n">float4</span> <span class="n">renderSurface</span><span class="p">(</span><span class="n">float3</span> <span class="n">position</span><span class="p">){</span>
                <span class="c1">//get light color</span>
                <span class="n">float4</span> <span class="n">light</span> <span class="o">=</span> <span class="n">lightColor</span><span class="p">(</span><span class="n">position</span><span class="p">);</span>
    
                <span class="c1">//combine base color and light color</span>
                <span class="n">float4</span> <span class="n">color</span> <span class="o">=</span> <span class="n">_Color</span> <span class="o">*</span> <span class="n">light</span><span class="p">;</span>
    
                <span class="k">return</span> <span class="n">color</span><span class="p">;</span>
            <span class="p">}</span>
            
            <span class="kt">void</span> <span class="n">frag</span><span class="p">(</span><span class="n">v2f</span> <span class="n">i</span><span class="p">,</span> <span class="k">out</span> <span class="n">fixed4</span> <span class="n">color</span> <span class="o">:</span> <span class="n">SV_TARGET</span><span class="p">,</span> <span class="k">out</span> <span class="kt">float</span> <span class="n">depth</span> <span class="o">:</span> <span class="n">SV_Depth</span><span class="p">){</span>
                <span class="c1">//ray information</span>
                <span class="n">float3</span> <span class="n">pos</span> <span class="o">=</span> <span class="n">i</span><span class="p">.</span><span class="n">localPosition</span><span class="p">;</span>
                <span class="n">float3</span> <span class="n">dir</span> <span class="o">=</span> <span class="n">normalize</span><span class="p">(</span><span class="n">i</span><span class="p">.</span><span class="n">viewDirection</span><span class="p">.</span><span class="n">xyz</span><span class="p">);</span>
                <span class="kt">float</span> <span class="n">progress</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
                <span class="n">float3</span> <span class="n">samplePoint</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
                
                <span class="kt">bool</span> <span class="n">hitsurface</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
                <span class="c1">//tracing loop</span>
                <span class="k">for</span> <span class="p">(</span><span class="kt">uint</span> <span class="n">iter</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">iter</span> <span class="o">&lt;</span> <span class="n">MAX_STEPS</span><span class="p">;</span> <span class="n">iter</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
                    <span class="c1">//get current location on ray</span>
                    <span class="n">samplePoint</span> <span class="o">=</span> <span class="n">pos</span> <span class="o">+</span> <span class="n">dir</span> <span class="o">*</span> <span class="n">progress</span><span class="p">;</span>
                    <span class="c1">//get distance to closest shape</span>
                    <span class="kt">float</span> <span class="n">distance</span> <span class="o">=</span> <span class="n">scene</span><span class="p">(</span><span class="n">samplePoint</span><span class="p">);</span>
                    <span class="c1">//return color if inside shape</span>
                    <span class="k">if</span><span class="p">(</span><span class="n">distance</span> <span class="o">&lt;</span> <span class="n">THICKNESS</span><span class="p">){</span>
                        <span class="n">hitsurface</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
                        <span class="k">break</span><span class="p">;</span>
                    <span class="p">}</span>
                    <span class="c1">//go forwards</span>
                    <span class="n">progress</span> <span class="o">=</span> <span class="n">progress</span> <span class="o">+</span> <span class="n">distance</span><span class="p">;</span>
                <span class="p">}</span>
                <span class="c1">//discard pixel if no shape was hit</span>
                <span class="n">clip</span><span class="p">(</span><span class="n">hitsurface</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="o">-</span><span class="mi">1</span><span class="p">);</span>
                
                <span class="c1">//calculate surface color</span>
                <span class="n">color</span> <span class="o">=</span> <span class="n">renderSurface</span><span class="p">(</span><span class="n">samplePoint</span><span class="p">);</span>
                <span class="c1">//calculate surface depth</span>
                <span class="n">float4</span> <span class="n">tracedClipPos</span> <span class="o">=</span> <span class="n">UnityObjectToClipPos</span><span class="p">(</span><span class="n">float4</span><span class="p">(</span><span class="n">samplePoint</span><span class="p">,</span> <span class="mi">1</span><span class="p">.</span><span class="mi">0</span><span class="p">));</span>
                <span class="n">depth</span> <span class="o">=</span> <span class="n">tracedClipPos</span><span class="p">.</span><span class="n">z</span> <span class="o">/</span> <span class="n">tracedClipPos</span><span class="p">.</span><span class="n">w</span><span class="p">;</span>
            <span class="p">}</span>
    
            <span class="n">ENDCG</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>


    <p>
        You can also find me on twitter at <a href="https://www.twitter.com/totallyRonja">@totallyRonja</a>. If you liked my tutorial and want to support me you can do that on Patreon (<a href="https://www.patreon.com/RonjaTutorials">patreon.com/RonjaTutorials</a>) or Ko-Fi (<a href="https://ko-fi.com/RonjaTutorials">ko-fi.com/RonjaTutorials</a>).
    </p>
  </div>

  
    <div id="disqus_thread"></div>
<script>

/**
*  RECOMMENDED CONFIGURATION VARIABLES: EDIT AND UNCOMMENT THE SECTION BELOW TO INSERT DYNAMIC VALUES FROM YOUR PLATFORM OR CMS.
*  LEARN WHY DEFINING THESE VARIABLES IS IMPORTANT: https://disqus.com/admin/universalcode/#configuration-variables*/
/*
var disqus_config = function () {
this.page.url = PAGE_URL;  // Replace PAGE_URL with your page's canonical URL variable
this.page.identifier = PAGE_IDENTIFIER; // Replace PAGE_IDENTIFIER with your page's unique identifier variable
};
*/
(function() { // DON'T EDIT BELOW THIS LINE
var d = document, s = d.createElement('script');
s.src = 'https://ronja-tutorials.disqus.com/embed.js';
s.setAttribute('data-timestamp', +new Date());
(d.head || d.body).appendChild(s);
})();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
                            
  
</article>


      <!-- SVG icons from https://iconmonstr.com -->

      <!-- Twitter icon -->
      <span class="my-span-icon">
          <a href="https://twitter.com/TotallyRonja" aria-label="'s Twitter" title="'s Twitter">
            <svg class="my-svg-icon" xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24" style="margin-top: 12px;margin-left: 13px;"><path d="M12 0c-6.627 0-12 5.373-12 12s5.373 12 12 12 12-5.373 12-12-5.373-12-12-12zm6.066 9.645c.183 4.04-2.83 8.544-8.164 8.544-1.622 0-3.131-.476-4.402-1.291 1.524.18 3.045-.244 4.252-1.189-1.256-.023-2.317-.854-2.684-1.995.451.086.895.061 1.298-.049-1.381-.278-2.335-1.522-2.304-2.853.388.215.83.344 1.301.359-1.279-.855-1.641-2.544-.889-3.835 1.416 1.738 3.533 2.881 5.92 3.001-.419-1.796.944-3.527 2.799-3.527.825 0 1.572.349 2.096.907.654-.128 1.27-.368 1.824-.697-.215.671-.67 1.233-1.263 1.589.581-.07 1.135-.224 1.649-.453-.384.578-.87 1.084-1.433 1.489z"/></svg>
          </a>
        </span>

        <!-- RSS icon -->
        
          <span class="my-span-icon">
            <a href="/feed.xml" aria-label="RSS feed" title="'s RSS feed">
              <svg class="my-svg-icon" xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24"><path d="M12 0c-6.627 0-12 5.373-12 12s5.373 12 12 12 12-5.373 12-12-5.373-12-12-12zm-3.374 17c-.897 0-1.626-.727-1.626-1.624s.729-1.624 1.626-1.624 1.626.727 1.626 1.624-.729 1.624-1.626 1.624zm3.885 0c-.03-3.022-2.485-5.474-5.511-5.504v-2.406c4.361.03 7.889 3.555 7.92 7.91h-2.409zm4.081 0c-.016-5.297-4.303-9.571-9.592-9.594v-2.406c6.623.023 11.985 5.384 12 12h-2.408z"/></svg>
            </a>
          </span>
        
        <!-- Contact icon -->
        
        
          <span class="my-span-icon">
            <a href="/about.html" aria-label="Contact" title="Contact ">
              <svg class="my-svg-icon" xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24"><path d="M12 .02c-6.627 0-12 5.373-12 12s5.373 12 12 12 12-5.373 12-12-5.373-12-12-12zm6.99 6.98l-6.99 5.666-6.991-5.666h13.981zm.01 10h-14v-8.505l7 5.673 7-5.672v8.504z"/></svg>
            </a>
          </span>
        
    </section>

    
      <script type="text/javascript">
        (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
        (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
        m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
        })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

        ga('create', 'UA-124040112-1', 'auto');
        ga('send', 'pageview');
      </script>
    
  </body>
</html>
