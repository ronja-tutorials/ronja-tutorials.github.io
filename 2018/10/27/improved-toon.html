<!DOCTYPE html>
<html lang="en">

  <head>

    <!-- Non social metatags -->
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <meta name="theme-color" content="#157878">

    

    <title>Improved Toon Light</title>

    
      <!-- Update your html tag to include the itemscope and itemtype attributes. -->
<html itemscope itemtype="http://schema.org/Article">












<!-- Place this data between the <head> tags of your website -->

  <meta name="author" content="Ronja Böhringer">

<meta name="description" content="Last weeks tutorial was about making a simple toon shader, but I felt like there’s still a lot to improve about it so this weeks tutorial is too. We’..." />





<!-- Schema.org markup for Google+ -->
<meta itemprop="name" content="Improved Toon Light">
<meta itemprop="description" content="Last weeks tutorial was about making a simple toon shader, but I felt like there’s still a lot to improve about it so this weeks tutorial is too. We’...">

  <meta itemprop="image" content="https://www.ronja-tutorials.com/assets/images/posts/032/CompleteToon.png">


<!-- Twitter Card data -->
<meta name="twitter:card" content="summary_large_image">



<meta name="twitter:title" content="Improved Toon Light">
<meta name="twitter:description" content="Last weeks tutorial was about making a simple toon shader, but I felt like there’s still a lot to improve about it so this weeks tutorial is too. We’...">


  <meta name="twitter:creator" content="@TotallyRonja">


<!-- Twitter summary card with large image must be at least 280x150px -->

  <meta name="twitter:image:src" content="https://www.ronja-tutorials.com/assets/images/posts/032/CompleteToon.png">
  <meta property="twitter:image" content="https://www.ronja-tutorials.com/assets/images/posts/032/CompleteToon.png">

<meta property="twitter:url" content="https://www.ronja-tutorials.com/2018/10/27/improved-toon.html">

<!-- Open Graph data -->
<meta property="og:title" content="Improved Toon Light" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://www.ronja-tutorials.com/2018/10/27/improved-toon.html" />

  <meta property="og:image" content="https://www.ronja-tutorials.com/assets/images/posts/032/CompleteToon.png" />

<meta property="og:description" content="Last weeks tutorial was about making a simple toon shader, but I felt like there’s still a lot to improve about it so this weeks tutorial is too. We’..." />
<meta property="og:site_name" content="Ronja's Shader Tutorials" />

  <meta property="article:published_time" content="2018-10-27T00:00:00+02:00" />














  





  




    

    <link rel="canonical" href="https://www.ronja-tutorials.com/2018/10/27/improved-toon.html">

    

    <!-- <link rel="shortcut icon" href="https://www.ronja-tutorials.com/favicon.ico"> -->
    <meta name="robots" content="noarchive">

    <!-- <link rel="alternate" media="only screen and (max-width: 640px)" href="">
    <link rel="alternate" media="handheld" href=""> -->


    <link href='https://fonts.googleapis.com/css?family=Open+Sans:400,700' rel='stylesheet' type='text/css'>
    <script async defer data-website-id="fb34d410-ef67-4a3a-8fdc-01a05f5e22b2" src="https://stats.ruby0x1.ca/umami.js" ></script>
    <link rel="stylesheet" href="/assets/css/style.css?v=">
  </head>
  <body>

    <header class="site-header" role="banner">

  <div class="wrapper">
    
    

    
      <a class="site-title" href="/">Ronja&#39;s Shader Tutorials</a>
    
    <!-- SVG icons from https://iconmonstr.com -->

    <!-- Twitter icon -->
    <span class="my-span-icon">
        <a href="https://twitter.com/TotallyRonja" aria-label="'s Twitter" title="'s Twitter">
          <svg class="my-svg-icon" xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24" style="margin-top: 12px;margin-left: 13px;"><path d="M12 0c-6.627 0-12 5.373-12 12s5.373 12 12 12 12-5.373 12-12-5.373-12-12-12zm6.066 9.645c.183 4.04-2.83 8.544-8.164 8.544-1.622 0-3.131-.476-4.402-1.291 1.524.18 3.045-.244 4.252-1.189-1.256-.023-2.317-.854-2.684-1.995.451.086.895.061 1.298-.049-1.381-.278-2.335-1.522-2.304-2.853.388.215.83.344 1.301.359-1.279-.855-1.641-2.544-.889-3.835 1.416 1.738 3.533 2.881 5.92 3.001-.419-1.796.944-3.527 2.799-3.527.825 0 1.572.349 2.096.907.654-.128 1.27-.368 1.824-.697-.215.671-.67 1.233-1.263 1.589.581-.07 1.135-.224 1.649-.453-.384.578-.87 1.084-1.433 1.489z"/></svg>
        </a>
      </span>

      <!-- RSS icon -->
      
        <span class="my-span-icon">
          <a href="/feed.xml" aria-label="RSS feed" title="'s RSS feed">
            <svg class="my-svg-icon" xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24"><path d="M12 0c-6.627 0-12 5.373-12 12s5.373 12 12 12 12-5.373 12-12-5.373-12-12-12zm-3.374 17c-.897 0-1.626-.727-1.626-1.624s.729-1.624 1.626-1.624 1.626.727 1.626 1.624-.729 1.624-1.626 1.624zm3.885 0c-.03-3.022-2.485-5.474-5.511-5.504v-2.406c4.361.03 7.889 3.555 7.92 7.91h-2.409zm4.081 0c-.016-5.297-4.303-9.571-9.592-9.594v-2.406c6.623.023 11.985 5.384 12 12h-2.408z"/></svg>
          </a>
        </span>
      
      <!-- Contact icon -->
      
      
        <span class="my-span-icon">
          <a href="/about.html" aria-label="Contact" title="Contact ">
            <svg class="my-svg-icon" xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24"><path d="M12 .02c-6.627 0-12 5.373-12 12s5.373 12 12 12 12-5.373 12-12-5.373-12-12-12zm6.99 6.98l-6.99 5.666-6.991-5.666h13.981zm.01 10h-14v-8.505l7 5.673 7-5.672v8.504z"/></svg>
          </a>
        </span>
      

    
      <nav class="site-nav">
        <input type="checkbox" id="nav-trigger" class="nav-trigger" />
        <label for="nav-trigger">
          <span class="menu-icon">
            <svg viewBox="0 0 18 15" width="18px" height="15px">
              <path fill="#424242" d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.031C17.335,0,18,0.665,18,1.484L18,1.484z"/>
              <path fill="#424242" d="M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0c0-0.82,0.665-1.484,1.484-1.484 h15.031C17.335,6.031,18,6.696,18,7.516L18,7.516z"/>
              <path fill="#424242" d="M18,13.516C18,14.335,17.335,15,16.516,15H1.484C0.665,15,0,14.335,0,13.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.031C17.335,12.031,18,12.696,18,13.516L18,13.516z"/>
            </svg>
          </span>
        </label>

        <div class="trigger">
          
            
            
              
              
            
          
            
            
          
            
            
              
                <a class="page-link" href="/about.html">About</a>
              
            
          
            
            
          
            
            
          
            
            
          
            
            
          
            
            
              
                <a class="page-link" href="/2018/03/20/hlsl-basics.html"></a>
              
            
          
            
            
              
                <a class="page-link" href="/2018/03/20/hlsl-basics.html"></a>
              
            
          
            
            
              
                <a class="page-link" href="/2018/03/20/hlsl-basics.html"></a>
              
            
          
            
            
              
                <a class="page-link" href="/2018/03/20/hlsl-basics.html"></a>
              
            
          
            
            
          
            
            
          
        </div>
      </nav>
    
  </div>
</header>


    
    
    

    <section class="page-header">
      <h1 class="project-name">Improved Toon Light</h1>
      <h2 class="project-tagline"></h2>
      
      <!-- Post tagline -->
      
        <h2 class="project-date">
        <time datetime="2018-10-27T00:00:00+02:00" itemprop="datePublished">
          
          Oct 27, 2018
        </time>
        
        
          • <span itemprop="author" itemscope itemtype="http://schema.org/Person"><span itemprop="name">Ronja Böhringer</span></span>
        
        </h2>
      
      <!-- End: Post tagline -->
    </section>

    <section class="main-content">

      <article itemscope itemtype="http://schema.org/BlogPosting">

  <!-- <header class="post-header">
    <h1 class="post-title" itemprop="name headline">Improved Toon Light</h1>
    <p class="post-meta">
      <time datetime="2018-10-27T00:00:00+02:00" itemprop="datePublished">
        
        Oct 27, 2018
      </time>
      </p>
  </header> -->

  
<ul>
  <li><a href="#improved-shadows-for-multiple-lights">Improved shadows for multiple lights.</a></li>
  <li><a href="#multiple-steps">Multiple Steps</a></li>
  <li><a href="#specular-highlights">Specular Highlights</a></li>
  <li><a href="#source">Source</a></li>
</ul>

  <div itemprop="articleBody">
    <p><a href="/2018/10/20/single-step-toon.html">Last weeks tutorial</a> was about making a simple toon shader, but I felt like there’s still a lot to improve about it so this weeks tutorial is too. We’ll fix a thing, and add multiple steps to the lighting as well as a specular highlight. I recommend you to read <a href="/2018/10/20/single-step-toon.html">the previous tutorial</a> if you haven’t because this one is heavily based on it and expands its code.</p>

<p><img src="/assets/images/posts/032/Demo.gif" alt="" /></p>

<h2 id="improved-shadows-for-multiple-lights">Improved shadows for multiple lights.</h2>

<p>If we have multiple lights in our scene we want them to all light up the light parts, but not have it change the areas where all of them have shadows. With the custom shadow color we have right now applied in the lighting function we also add the shadow color the more lights we have. This is also critical because point lights will add lighting in a weird square shape that we definitely don’t want.</p>

<p><img src="/assets/images/posts/032/BadLight.gif" alt="" /></p>

<p>The easiest fix for this is to add the shadow color in a way that only adds it once everywhere on the model and then use black as the shadow color in the lighting function.</p>

<p>There are 2 ways to do that. Either we set the ambient color in the lighting settings to the color we want our shadows to be in, or we set the ambient color to black and add the shadow color to the emissive value. I’ll do the second solution here because it allows us to set a custom shadow color per material, but feel free to use the ambient color solution if you want to change the color of all shadows at the same time.</p>

<p>We start by setting the ambient color to black in the lighting settings. Then we also disable environment reflections and global illumination. I recommend you do this in general if you want greater control over your lighting and you want a “clean” look.</p>

<p><img src="/assets/images/posts/032/LightingSettings.png" alt="" /></p>

<p>Then we move the shadow color to the emission of the material instead of the lighting function. We calculate it just like before by multiplying the albedo color of the object with the shadow color property. Then to use it we simply add it to the emissive color. Now that we implemented this we don’t have to set the color in the lighting function anymore. In the line where we used it to interpolate from the shadow to the light color we can now remove the lerp function and simply multiply the light intensity by the albedo.</p>

<div class="language-glsl highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">//the surface shader function which sets parameters the lighting function then uses</span>
<span class="kt">void</span> <span class="nf">surf</span> <span class="p">(</span><span class="n">Input</span> <span class="n">i</span><span class="p">,</span> <span class="k">inout</span> <span class="n">SurfaceOutput</span> <span class="n">o</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">//sample and tint albedo texture</span>
    <span class="n">fixed4</span> <span class="n">col</span> <span class="o">=</span> <span class="n">tex2D</span><span class="p">(</span><span class="n">_MainTex</span><span class="p">,</span> <span class="n">i</span><span class="p">.</span><span class="n">uv_MainTex</span><span class="p">);</span>
    <span class="n">col</span> <span class="o">*=</span> <span class="n">_Color</span><span class="p">;</span>
    <span class="n">o</span><span class="p">.</span><span class="n">Albedo</span> <span class="o">=</span> <span class="n">col</span><span class="p">.</span><span class="n">rgb</span><span class="p">;</span>

    <span class="n">float3</span> <span class="n">shadowColor</span> <span class="o">=</span> <span class="n">col</span><span class="p">.</span><span class="n">rgb</span> <span class="o">*</span> <span class="n">_ShadowTint</span><span class="p">;</span>
    <span class="n">o</span><span class="p">.</span><span class="n">Emission</span> <span class="o">=</span> <span class="n">_Emission</span> <span class="o">+</span> <span class="n">shadowColor</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>

<div class="language-glsl highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">float4</span> <span class="n">color</span><span class="p">;</span>
<span class="n">color</span><span class="p">.</span><span class="n">rgb</span> <span class="o">=</span> <span class="n">s</span><span class="p">.</span><span class="n">Albedo</span> <span class="o">*</span> <span class="n">lightIntensity</span> <span class="o">*</span> <span class="n">_LightColor0</span><span class="p">.</span><span class="n">rgb</span><span class="p">;</span>
<span class="n">color</span><span class="p">.</span><span class="n">a</span> <span class="o">=</span> <span class="n">s</span><span class="p">.</span><span class="n">Alpha</span><span class="p">;</span>
<span class="k">return</span> <span class="n">color</span><span class="p">;</span>
</code></pre></div></div>

<p><img src="/assets/images/posts/032/EmissiveShadowColor.png" alt="" /></p>

<p>This technique works really well for dark shadow colors, but if we want the shadow color to be very strong we we always have the light tinted in the shadow color. There are ways to avoid that but they have their own disadvantages, so I won’t get into them here (write me if you’re curious).</p>

<h2 id="multiple-steps">Multiple Steps</h2>

<p>So far we only have a single hard cut for the lighting. Another option is to have several of those. Having more steps can give the model more plasticity while still looking clean, but it’s important that you consider what fits your style best.</p>

<p>To make multiple steps we divide the <code class="language-plaintext highlighter-rouge">towardsLight</code> variable by the relative width of a single step. We’ll make that a property to edit. By dividing it, the variable will become higher and span more whole numbers. If we pass 0.5 as the relative width, it’ll go from 0 to 2 (in the area towards the light, we’ll ignore the backside for now), for a width of 0.25 it’s from 0 to 4 etc. We can then use this stretched variable to generate hard steps with the <code class="language-plaintext highlighter-rouge">ceil</code> function to force it to whole values. After we have whole values we divide it again, this time by another property which represents the amount of steps we want to show. The values will still be negative for the values on the shadow side and might go over 1 if we have a few narrow cuts, so we then clamp it between 0 and 1 by passing it though the <code class="language-plaintext highlighter-rouge">saturate</code> method. After those steps we can use it as the light intensity.</p>

<div class="language-glsl highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">Properties</span> <span class="p">{</span>
    <span class="p">[</span><span class="n">Header</span><span class="p">(</span><span class="n">Base</span> <span class="n">Parameters</span><span class="p">)]</span>
    <span class="n">_Color</span> <span class="p">(</span><span class="s">"Tint"</span><span class="p">,</span> <span class="n">Color</span><span class="p">)</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">_MainTex</span> <span class="p">(</span><span class="s">"Texture"</span><span class="p">,</span> <span class="mi">2</span><span class="n">D</span><span class="p">)</span> <span class="o">=</span> <span class="s">"white"</span> <span class="p">{}</span>
    <span class="p">[</span><span class="n">HDR</span><span class="p">]</span> <span class="n">_Emission</span> <span class="p">(</span><span class="s">"Emission"</span><span class="p">,</span> <span class="n">color</span><span class="p">)</span> <span class="o">=</span> <span class="p">(</span><span class="mi">0</span> <span class="p">,</span><span class="mi">0</span> <span class="p">,</span><span class="mi">0</span> <span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

    <span class="p">[</span><span class="n">Header</span><span class="p">(</span><span class="n">Lighting</span> <span class="n">Parameters</span><span class="p">)]</span>
    <span class="n">_ShadowTint</span> <span class="p">(</span><span class="s">"Shadow Color"</span><span class="p">,</span> <span class="n">Color</span><span class="p">)</span> <span class="o">=</span> <span class="p">(</span><span class="mi">0</span><span class="p">.</span><span class="mi">5</span><span class="p">,</span> <span class="mi">0</span><span class="p">.</span><span class="mi">5</span><span class="p">,</span> <span class="mi">0</span><span class="p">.</span><span class="mi">5</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
    <span class="p">[</span><span class="n">IntRange</span><span class="p">]</span><span class="n">_StepAmount</span> <span class="p">(</span><span class="s">"Shadow Steps"</span><span class="p">,</span> <span class="n">Range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">16</span><span class="p">))</span> <span class="o">=</span> <span class="mi">2</span>
    <span class="n">_StepWidth</span> <span class="p">(</span><span class="s">"Step Size"</span><span class="p">,</span> <span class="n">Range</span><span class="p">(</span><span class="mi">0</span><span class="p">.</span><span class="mo">05</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span> <span class="o">=</span> <span class="mi">0</span><span class="p">.</span><span class="mi">25</span>
<span class="p">}</span>
</code></pre></div></div>

<div class="language-glsl highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">//our lighting function. Will be called once per light</span>
<span class="n">float4</span> <span class="nf">LightingStepped</span><span class="p">(</span><span class="n">SurfaceOutput</span> <span class="n">s</span><span class="p">,</span> <span class="n">float3</span> <span class="n">lightDir</span><span class="p">,</span> <span class="n">half3</span> <span class="n">viewDir</span><span class="p">,</span> <span class="kt">float</span> <span class="n">shadowAttenuation</span><span class="p">){</span>
    <span class="c1">//how much does the normal point towards the light?</span>
    <span class="kt">float</span> <span class="n">towardsLight</span> <span class="o">=</span> <span class="n">dot</span><span class="p">(</span><span class="n">s</span><span class="p">.</span><span class="n">Normal</span><span class="p">,</span> <span class="n">lightDir</span><span class="p">);</span>
    <span class="n">towardsLight</span> <span class="o">=</span> <span class="n">towardsLight</span> <span class="o">/</span> <span class="n">_StepWidth</span><span class="p">;</span>
    <span class="kt">float</span> <span class="n">lightIntensity</span> <span class="o">=</span> <span class="n">ceil</span><span class="p">(</span><span class="n">towardsLight</span><span class="p">);</span>
    <span class="n">lightIntensity</span> <span class="o">=</span> <span class="n">lightIntensity</span> <span class="o">/</span> <span class="n">_StepAmount</span><span class="p">;</span>
    <span class="n">lightIntensity</span> <span class="o">=</span> <span class="n">saturate</span><span class="p">(</span><span class="n">lightIntensity</span><span class="p">);</span>

    <span class="c1">//shadow etc...</span>
</code></pre></div></div>

<p><img src="/assets/images/posts/032/SimpleSteps.gif" alt="" /></p>

<p>This already works pretty well now, but we have lost our antialiasing with that conversion, so we have to implement that again. We do this by interpolating to the next lower step in the first pixels of each step. This addition has to happen between the line where we ceil the value to a whole number and the line where we divide it by the amount of steps. We first get the change of how much it points towards the light with the <code class="language-plaintext highlighter-rouge">fwidth</code> function, then we do a <code class="language-plaintext highlighter-rouge">smoothstep</code> again from 0 to the amount the change in one pixel. But instead of using the towards light variable as the value to check against, which would only smooth the first step towards the shadowed area, we use the fractional part. This way we’ll get the smoothing for every single step. Once we have that smoothing variable which masks out the first few pixels, we add it to the intensity. Because this smoothing is 0 at the very beginning and 1 for most of the area of the step, this will make the material appear too bright. The easy way around that is to change the <code class="language-plaintext highlighter-rouge">ceil</code> method we used earlier to a <code class="language-plaintext highlighter-rouge">floor</code> which is basically the same, just one whole value lower.</p>

<div class="language-glsl highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">//how much does the normal point towards the light?</span>
<span class="kt">float</span> <span class="n">towardsLight</span> <span class="o">=</span> <span class="n">dot</span><span class="p">(</span><span class="n">s</span><span class="p">.</span><span class="n">Normal</span><span class="p">,</span> <span class="n">lightDir</span><span class="p">);</span>

<span class="c1">//stretch values so each whole value is one step</span>
<span class="n">towardsLight</span> <span class="o">=</span> <span class="n">towardsLight</span> <span class="o">/</span> <span class="n">_StepWidth</span><span class="p">;</span>
<span class="c1">//make steps harder</span>
<span class="kt">float</span> <span class="n">lightIntensity</span> <span class="o">=</span> <span class="n">floor</span><span class="p">(</span><span class="n">towardsLight</span><span class="p">);</span>

<span class="c1">// calculate smoothing in first pixels of the steps and add smoothing to step, raising it by one step</span>
<span class="c1">// (that's fine because we used floor previously and we want everything to be the value above the floor value, </span>
<span class="c1">// for example 0 to 1 should be 1, 1 to 2 should be 2 etc...)</span>
<span class="kt">float</span> <span class="n">change</span> <span class="o">=</span> <span class="n">fwidth</span><span class="p">(</span><span class="n">towardsLight</span><span class="p">);</span>
<span class="kt">float</span> <span class="n">smoothing</span> <span class="o">=</span> <span class="n">smoothstep</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">change</span><span class="p">,</span> <span class="n">frac</span><span class="p">(</span><span class="n">towardsLight</span><span class="p">));</span>
<span class="n">lightIntensity</span> <span class="o">=</span> <span class="n">lightIntensity</span> <span class="o">+</span> <span class="n">smoothing</span><span class="p">;</span>

<span class="c1">// bring the light intensity back into a range where we can use it for color</span>
<span class="c1">// and clamp it so it doesn't do weird stuff below 0 / above one</span>
<span class="n">lightIntensity</span> <span class="o">=</span> <span class="n">lightIntensity</span> <span class="o">/</span> <span class="n">_StepAmount</span><span class="p">;</span>
<span class="n">lightIntensity</span> <span class="o">=</span> <span class="n">saturate</span><span class="p">(</span><span class="n">lightIntensity</span><span class="p">);</span>
</code></pre></div></div>

<p><img src="/assets/images/posts/032/AntialiasedSteps.png" alt="" /></p>

<h2 id="specular-highlights">Specular Highlights</h2>

<p>For objects to look wet, shiny or metallic we can implement specular highlights. Because they depend on how the light would be reflected towards the camera they change based on the view direction.</p>

<p>First we calculate in which direction the light would be reflected, for this hlsl has the handy <code class="language-plaintext highlighter-rouge">reflect</code> method which takes a direction and a normal. Then we compare it to the view direction with a dot product, but only after we invert it because the reflection goes out of the surface and the view direction towards the surface.</p>

<div class="language-glsl highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">float3</span> <span class="n">reflectionDirection</span> <span class="o">=</span> <span class="n">reflect</span><span class="p">(</span><span class="n">lightDir</span><span class="p">,</span> <span class="n">s</span><span class="p">.</span><span class="n">Normal</span><span class="p">);</span>
<span class="kt">float</span> <span class="n">towardsReflection</span> <span class="o">=</span> <span class="n">dot</span><span class="p">(</span><span class="n">viewDir</span><span class="p">,</span> <span class="o">-</span><span class="n">reflectionDirection</span><span class="p">);</span>
<span class="k">return</span> <span class="n">towardsReflection</span><span class="p">;</span>
</code></pre></div></div>

<p><img src="/assets/images/posts/032/ReflectionDirection.png" alt="" /></p>

<p>With this we get a nice soft gradient towards the direction of the light reflection. Just like the shadowing, we can then cut it off so we get a nice hard highlight. We first get the change in the variable, then we do a smoothstep. We subtract our specular size property from 1 because the towards light variable will be one where it points towards the reflection so when we cut off at 1, the specular highlight will be invisible, and the lower the cutoff points gets, the bigger the highlight grows.</p>

<div class="language-glsl highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">//property</span>
<span class="n">_SpecularSize</span> <span class="p">(</span><span class="s">"Specular Size"</span><span class="p">,</span> <span class="n">Range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span> <span class="o">=</span> <span class="mi">0</span><span class="p">.</span><span class="mi">1</span>
</code></pre></div></div>

<div class="language-glsl highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">//global shader variable</span>
<span class="kt">float</span> <span class="n">_SpecularSize</span><span class="p">;</span>
</code></pre></div></div>

<div class="language-glsl highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">float3</span> <span class="n">reflectionDirection</span> <span class="o">=</span> <span class="n">reflect</span><span class="p">(</span><span class="n">lightDir</span><span class="p">,</span> <span class="n">s</span><span class="p">.</span><span class="n">Normal</span><span class="p">);</span>
<span class="kt">float</span> <span class="n">towardsReflection</span> <span class="o">=</span> <span class="n">dot</span><span class="p">(</span><span class="n">viewDir</span><span class="p">,</span> <span class="o">-</span><span class="n">reflectionDirection</span><span class="p">);</span>
<span class="kt">float</span> <span class="n">specularChange</span> <span class="o">=</span> <span class="n">fwidth</span><span class="p">(</span><span class="n">towardsReflection</span><span class="p">);</span>
<span class="kt">float</span> <span class="n">specularIntensity</span> <span class="o">=</span> <span class="n">smoothstep</span><span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">_SpecularSize</span><span class="p">,</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">_SpecularSize</span> <span class="o">+</span> <span class="n">specularChange</span><span class="p">,</span> <span class="n">towardsReflection</span><span class="p">);</span>
<span class="k">return</span> <span class="n">specularIntensity</span><span class="p">;</span>
</code></pre></div></div>

<p><img src="/assets/images/posts/032/SpecularIntensity.png" alt="" /></p>

<p>One thing that can look weird with this is that if we go behind out object and look in the direction of the light, the highlight can become huge and span around the outside of the object.</p>

<p><img src="/assets/images/posts/032/BigSpecular.png" alt="" /></p>

<p>To counteract this, we can simply multiply the towardsLight variable with a inverse fresnel before doing the cutoff. We get the inverse fresnel by simply taking the dot product between the normal and the view direction. To make it adjustable by a property, we take the dot product by the power of the property. Then we multiply the new falloff variable by the towards light direction.</p>

<div class="language-glsl highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">//property</span>
<span class="n">_SpecularFalloff</span> <span class="p">(</span><span class="s">"Specular Falloff"</span><span class="p">,</span> <span class="n">Range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span> <span class="o">=</span> <span class="mi">1</span>
</code></pre></div></div>

<div class="language-glsl highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">//global shader variable</span>
<span class="kt">float</span> <span class="n">_SpecularFalloff</span><span class="p">;</span>
</code></pre></div></div>

<div class="language-glsl highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">float3</span> <span class="n">reflectionDirection</span> <span class="o">=</span> <span class="n">reflect</span><span class="p">(</span><span class="n">lightDir</span><span class="p">,</span> <span class="n">s</span><span class="p">.</span><span class="n">Normal</span><span class="p">);</span>
<span class="kt">float</span> <span class="n">towardsReflection</span> <span class="o">=</span> <span class="n">dot</span><span class="p">(</span><span class="n">viewDir</span><span class="p">,</span> <span class="o">-</span><span class="n">reflectionDirection</span><span class="p">);</span>
<span class="kt">float</span> <span class="n">specularFalloff</span> <span class="o">=</span> <span class="n">dot</span><span class="p">(</span><span class="n">viewDir</span><span class="p">,</span> <span class="n">s</span><span class="p">.</span><span class="n">Normal</span><span class="p">);</span>
<span class="n">specularFalloff</span> <span class="o">=</span> <span class="n">pow</span><span class="p">(</span><span class="n">specularFalloff</span><span class="p">,</span> <span class="n">_SpecularFalloff</span><span class="p">);</span>
<span class="n">towardsReflection</span> <span class="o">=</span> <span class="n">towardsReflection</span> <span class="o">*</span> <span class="n">specularFalloff</span><span class="p">;</span>
<span class="kt">float</span> <span class="n">specularChange</span> <span class="o">=</span> <span class="n">fwidth</span><span class="p">(</span><span class="n">towardsReflection</span><span class="p">);</span>
<span class="kt">float</span> <span class="n">specularIntensity</span> <span class="o">=</span> <span class="n">smoothstep</span><span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">_SpecularSize</span><span class="p">,</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">_SpecularSize</span> <span class="o">+</span> <span class="n">specularChange</span><span class="p">,</span> <span class="n">towardsReflection</span><span class="p">);</span>
<span class="k">return</span> <span class="n">specularIntensity</span><span class="p">;</span>
</code></pre></div></div>

<p><img src="/assets/images/posts/032/FalloffAdjustment.gif" alt="" /></p>

<p>And as a last point we also multiply the shadow intensity by our shadow variable so we don’t see the specular highlights where the surface should be shadowed.</p>

<div class="language-glsl highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">specularIntensity</span> <span class="o">=</span> <span class="n">specularIntensity</span> <span class="o">*</span> <span class="n">shadow</span><span class="p">;</span>
</code></pre></div></div>

<p>Then to implement it with the correct colors and with the existing lighting we simply do a linear interpolation from the color we calculated with lighting and the specular color based on the specular intensity and the color of the light. We set the specular color property as the specular parameter of the surfaceoutput struct. At this moment it doesn’t matter wether we write the property to the surfaceoutput and read that in the lighting function or we simply read the property in the lighting function, but doing it this way makes it easier to expand in the future and for example read the specular color from a texture.</p>

<div class="language-glsl highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">//property</span>
<span class="n">_Specular</span> <span class="p">(</span><span class="s">"Specular Color"</span><span class="p">,</span> <span class="n">Color</span><span class="p">)</span> <span class="o">=</span> <span class="mi">1</span>
</code></pre></div></div>

<div class="language-glsl highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">//global shader variable</span>
<span class="n">fixed3</span> <span class="n">_Specular</span><span class="p">;</span>
</code></pre></div></div>

<div class="language-glsl highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">//in the surface function</span>
<span class="n">o</span><span class="p">.</span><span class="n">Specular</span> <span class="o">=</span> <span class="n">_Specular</span><span class="p">;</span>
</code></pre></div></div>

<div class="language-glsl highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">//in the lighting function</span>

<span class="c1">//calculate how much the surface points points towards the reflection direction</span>
<span class="n">float3</span> <span class="n">reflectionDirection</span> <span class="o">=</span> <span class="n">reflect</span><span class="p">(</span><span class="n">lightDir</span><span class="p">,</span> <span class="n">s</span><span class="p">.</span><span class="n">Normal</span><span class="p">);</span>
<span class="kt">float</span> <span class="n">towardsReflection</span> <span class="o">=</span> <span class="n">dot</span><span class="p">(</span><span class="n">viewDir</span><span class="p">,</span> <span class="o">-</span><span class="n">reflectionDirection</span><span class="p">);</span>

<span class="c1">//make specular highlight all off towards outside of model</span>
<span class="kt">float</span> <span class="n">specularFalloff</span> <span class="o">=</span> <span class="n">dot</span><span class="p">(</span><span class="n">viewDir</span><span class="p">,</span> <span class="n">s</span><span class="p">.</span><span class="n">Normal</span><span class="p">);</span>
<span class="n">specularFalloff</span> <span class="o">=</span> <span class="n">pow</span><span class="p">(</span><span class="n">specularFalloff</span><span class="p">,</span> <span class="n">_SpecularFalloff</span><span class="p">);</span>
<span class="n">towardsReflection</span> <span class="o">=</span> <span class="n">towardsReflection</span> <span class="o">*</span> <span class="n">specularFalloff</span><span class="p">;</span>

<span class="c1">//make specular intensity with a hard corner</span>
<span class="kt">float</span> <span class="n">specularChange</span> <span class="o">=</span> <span class="n">fwidth</span><span class="p">(</span><span class="n">towardsReflection</span><span class="p">);</span>
<span class="kt">float</span> <span class="n">specularIntensity</span> <span class="o">=</span> <span class="n">smoothstep</span><span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">_SpecularSize</span><span class="p">,</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">_SpecularSize</span> <span class="o">+</span> <span class="n">specularChange</span><span class="p">,</span> <span class="n">towardsReflection</span><span class="p">);</span>
<span class="c1">//factor inshadows</span>
<span class="n">specularIntensity</span> <span class="o">=</span> <span class="n">specularIntensity</span> <span class="o">*</span> <span class="n">shadow</span><span class="p">;</span>

<span class="n">float4</span> <span class="n">color</span><span class="p">;</span>
<span class="c1">//calculate final color</span>
<span class="n">color</span><span class="p">.</span><span class="n">rgb</span> <span class="o">=</span> <span class="n">s</span><span class="p">.</span><span class="n">Albedo</span> <span class="o">*</span> <span class="n">lightIntensity</span> <span class="o">*</span> <span class="n">_LightColor0</span><span class="p">.</span><span class="n">rgb</span><span class="p">;</span>
<span class="n">color</span><span class="p">.</span><span class="n">rgb</span> <span class="o">=</span> <span class="n">lerp</span><span class="p">(</span><span class="n">color</span><span class="p">.</span><span class="n">rgb</span><span class="p">,</span> <span class="n">s</span><span class="p">.</span><span class="n">Specular</span> <span class="o">*</span> <span class="n">_LightColor0</span><span class="p">.</span><span class="n">rgb</span><span class="p">,</span> <span class="n">saturate</span><span class="p">(</span><span class="n">specularIntensity</span><span class="p">));</span>

<span class="n">color</span><span class="p">.</span><span class="n">a</span> <span class="o">=</span> <span class="n">s</span><span class="p">.</span><span class="n">Alpha</span><span class="p">;</span>
<span class="k">return</span> <span class="n">color</span><span class="p">;</span>
</code></pre></div></div>

<p>Sadly the surface variable only supports 1-dimensional variables, so we’ll write our own struct for passing variables. It needs an albedo, emission, specular, alpha, and normal property. We’ll then replace all occurances of SurfaceOutput with our new struct.</p>

<div class="language-glsl highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">struct</span> <span class="n">ToonSurfaceOutput</span><span class="p">{</span>
    <span class="n">fixed3</span> <span class="n">Albedo</span><span class="p">;</span>
    <span class="n">half3</span> <span class="n">Emission</span><span class="p">;</span>
    <span class="n">fixed3</span> <span class="n">Specular</span><span class="p">;</span>
    <span class="kr">fixed</span> <span class="n">Alpha</span><span class="p">;</span>
    <span class="n">fixed3</span> <span class="n">Normal</span><span class="p">;</span>
<span class="p">};</span>
</code></pre></div></div>

<div class="language-glsl highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">float4</span> <span class="nf">LightingStepped</span><span class="p">(</span><span class="n">ToonSurfaceOutput</span> <span class="n">s</span><span class="p">,</span> <span class="n">float3</span> <span class="n">lightDir</span><span class="p">,</span> <span class="n">half3</span> <span class="n">viewDir</span><span class="p">,</span> <span class="kt">float</span> <span class="n">shadowAttenuation</span><span class="p">){</span>
</code></pre></div></div>

<div class="language-glsl highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">void</span> <span class="nf">surf</span> <span class="p">(</span><span class="n">Input</span> <span class="n">i</span><span class="p">,</span> <span class="k">inout</span> <span class="n">ToonSurfaceOutput</span> <span class="n">o</span><span class="p">)</span> <span class="p">{</span>
</code></pre></div></div>

<p><img src="/assets/images/posts/032/CompleteToon.png" alt="" /></p>

<h2 id="source">Source</h2>

<ul>
  <li><a href="https://github.com/ronja-tutorials/ShaderTutorials/blob/master/Assets/032_ImprovedToon/ImprovedToonLighting.shader">https://github.com/ronja-tutorials/ShaderTutorials/blob/master/Assets/032_ImprovedToon/ImprovedToonLighting.shader</a></li>
</ul>

<div class="language-glsl highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">Shader</span> <span class="s">"Tutorial/032_ImprovedToon"</span> <span class="p">{</span>
    <span class="c1">//show values to edit in inspector</span>
    <span class="n">Properties</span> <span class="p">{</span>
        <span class="p">[</span><span class="n">Header</span><span class="p">(</span><span class="n">Base</span> <span class="n">Parameters</span><span class="p">)]</span>
        <span class="n">_Color</span> <span class="p">(</span><span class="s">"Tint"</span><span class="p">,</span> <span class="n">Color</span><span class="p">)</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">_MainTex</span> <span class="p">(</span><span class="s">"Texture"</span><span class="p">,</span> <span class="mi">2</span><span class="n">D</span><span class="p">)</span> <span class="o">=</span> <span class="s">"white"</span> <span class="p">{}</span>
        <span class="n">_Specular</span> <span class="p">(</span><span class="s">"Specular Color"</span><span class="p">,</span> <span class="n">Color</span><span class="p">)</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
        <span class="p">[</span><span class="n">HDR</span><span class="p">]</span> <span class="n">_Emission</span> <span class="p">(</span><span class="s">"Emission"</span><span class="p">,</span> <span class="n">color</span><span class="p">)</span> <span class="o">=</span> <span class="p">(</span><span class="mi">0</span> <span class="p">,</span><span class="mi">0</span> <span class="p">,</span><span class="mi">0</span> <span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

        <span class="p">[</span><span class="n">Header</span><span class="p">(</span><span class="n">Lighting</span> <span class="n">Parameters</span><span class="p">)]</span>
        <span class="n">_ShadowTint</span> <span class="p">(</span><span class="s">"Shadow Color"</span><span class="p">,</span> <span class="n">Color</span><span class="p">)</span> <span class="o">=</span> <span class="p">(</span><span class="mi">0</span><span class="p">.</span><span class="mi">5</span><span class="p">,</span> <span class="mi">0</span><span class="p">.</span><span class="mi">5</span><span class="p">,</span> <span class="mi">0</span><span class="p">.</span><span class="mi">5</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="p">[</span><span class="n">IntRange</span><span class="p">]</span><span class="n">_StepAmount</span> <span class="p">(</span><span class="s">"Shadow Steps"</span><span class="p">,</span> <span class="n">Range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">16</span><span class="p">))</span> <span class="o">=</span> <span class="mi">2</span>
        <span class="n">_StepWidth</span> <span class="p">(</span><span class="s">"Step Size"</span><span class="p">,</span> <span class="n">Range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span> <span class="o">=</span> <span class="mi">0</span><span class="p">.</span><span class="mi">25</span>
        <span class="n">_SpecularSize</span> <span class="p">(</span><span class="s">"Specular Size"</span><span class="p">,</span> <span class="n">Range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span> <span class="o">=</span> <span class="mi">0</span><span class="p">.</span><span class="mi">1</span>
        <span class="n">_SpecularFalloff</span> <span class="p">(</span><span class="s">"Specular Falloff"</span><span class="p">,</span> <span class="n">Range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="p">}</span>
    <span class="n">SubShader</span> <span class="p">{</span>
        <span class="c1">//the material is completely non-transparent and is rendered at the same time as the other opaque geometry</span>
        <span class="n">Tags</span><span class="p">{</span> <span class="s">"RenderType"</span><span class="o">=</span><span class="s">"Opaque"</span> <span class="s">"Queue"</span><span class="o">=</span><span class="s">"Geometry"</span><span class="p">}</span>

        <span class="n">CGPROGRAM</span>

        <span class="c1">//the shader is a surface shader, meaning that it will be extended by unity in the background to have fancy lighting and other features</span>
        <span class="c1">//our surface shader function is called surf and we use our custom lighting model</span>
        <span class="c1">//fullforwardshadows makes sure unity adds the shadow passes the shader might need</span>
        <span class="cp">#pragma surface surf Stepped fullforwardshadows
</span>        <span class="cp">#pragma target 3.0
</span>
        <span class="kt">sampler2D</span> <span class="n">_MainTex</span><span class="p">;</span>
        <span class="n">fixed4</span> <span class="n">_Color</span><span class="p">;</span>
        <span class="n">half3</span> <span class="n">_Emission</span><span class="p">;</span>
        <span class="n">fixed4</span> <span class="n">_Specular</span><span class="p">;</span>

        <span class="n">float3</span> <span class="n">_ShadowTint</span><span class="p">;</span>
        <span class="kt">float</span> <span class="n">_StepWidth</span><span class="p">;</span>
        <span class="kt">float</span> <span class="n">_StepAmount</span><span class="p">;</span>
        <span class="kt">float</span> <span class="n">_SpecularSize</span><span class="p">;</span>
        <span class="kt">float</span> <span class="n">_SpecularFalloff</span><span class="p">;</span>

        <span class="k">struct</span> <span class="n">ToonSurfaceOutput</span><span class="p">{</span>
            <span class="n">fixed3</span> <span class="n">Albedo</span><span class="p">;</span>
            <span class="n">half3</span> <span class="n">Emission</span><span class="p">;</span>
            <span class="n">fixed3</span> <span class="n">Specular</span><span class="p">;</span>
            <span class="kr">fixed</span> <span class="n">Alpha</span><span class="p">;</span>
            <span class="n">fixed3</span> <span class="n">Normal</span><span class="p">;</span>
        <span class="p">};</span>

        <span class="c1">//our lighting function. Will be called once per light</span>
        <span class="n">float4</span> <span class="n">LightingStepped</span><span class="p">(</span><span class="n">ToonSurfaceOutput</span> <span class="n">s</span><span class="p">,</span> <span class="n">float3</span> <span class="n">lightDir</span><span class="p">,</span> <span class="n">half3</span> <span class="n">viewDir</span><span class="p">,</span> <span class="kt">float</span> <span class="n">shadowAttenuation</span><span class="p">){</span>
            <span class="c1">//how much does the normal point towards the light?</span>
            <span class="kt">float</span> <span class="n">towardsLight</span> <span class="o">=</span> <span class="n">dot</span><span class="p">(</span><span class="n">s</span><span class="p">.</span><span class="n">Normal</span><span class="p">,</span> <span class="n">lightDir</span><span class="p">);</span>

            <span class="c1">//stretch values so each whole value is one step</span>
            <span class="n">towardsLight</span> <span class="o">=</span> <span class="n">towardsLight</span> <span class="o">/</span> <span class="n">_StepWidth</span><span class="p">;</span>
            <span class="c1">//make steps harder</span>
            <span class="kt">float</span> <span class="n">lightIntensity</span> <span class="o">=</span> <span class="n">floor</span><span class="p">(</span><span class="n">towardsLight</span><span class="p">);</span>

            <span class="c1">// calculate smoothing in first pixels of the steps and add smoothing to step, raising it by one step</span>
            <span class="c1">// (that's fine because we used floor previously and we want everything to be the value above the floor value, </span>
            <span class="c1">// for example 0 to 1 should be 1, 1 to 2 should be 2 etc...)</span>
            <span class="kt">float</span> <span class="n">change</span> <span class="o">=</span> <span class="n">fwidth</span><span class="p">(</span><span class="n">towardsLight</span><span class="p">);</span>
            <span class="kt">float</span> <span class="n">smoothing</span> <span class="o">=</span> <span class="n">smoothstep</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">change</span><span class="p">,</span> <span class="n">frac</span><span class="p">(</span><span class="n">towardsLight</span><span class="p">));</span>
            <span class="n">lightIntensity</span> <span class="o">=</span> <span class="n">lightIntensity</span> <span class="o">+</span> <span class="n">smoothing</span><span class="p">;</span>

            <span class="c1">// bring the light intensity back into a range where we can use it for color</span>
            <span class="c1">// and clamp it so it doesn't do weird stuff below 0 / above one</span>
            <span class="n">lightIntensity</span> <span class="o">=</span> <span class="n">lightIntensity</span> <span class="o">/</span> <span class="n">_StepAmount</span><span class="p">;</span>
            <span class="n">lightIntensity</span> <span class="o">=</span> <span class="n">saturate</span><span class="p">(</span><span class="n">lightIntensity</span><span class="p">);</span>

        <span class="cp">#ifdef USING_DIRECTIONAL_LIGHT
</span>            <span class="c1">//for directional lights, get a hard vut in the middle of the shadow attenuation</span>
            <span class="kt">float</span> <span class="n">attenuationChange</span> <span class="o">=</span> <span class="n">fwidth</span><span class="p">(</span><span class="n">shadowAttenuation</span><span class="p">)</span> <span class="o">*</span> <span class="mi">0</span><span class="p">.</span><span class="mi">5</span><span class="p">;</span>
            <span class="kt">float</span> <span class="n">shadow</span> <span class="o">=</span> <span class="n">smoothstep</span><span class="p">(</span><span class="mi">0</span><span class="p">.</span><span class="mi">5</span> <span class="o">-</span> <span class="n">attenuationChange</span><span class="p">,</span> <span class="mi">0</span><span class="p">.</span><span class="mi">5</span> <span class="o">+</span> <span class="n">attenuationChange</span><span class="p">,</span> <span class="n">shadowAttenuation</span><span class="p">);</span>
        <span class="cp">#else
</span>            <span class="c1">//for other light types (point, spot), put the cutoff near black, so the falloff doesn't affect the range</span>
            <span class="kt">float</span> <span class="n">attenuationChange</span> <span class="o">=</span> <span class="n">fwidth</span><span class="p">(</span><span class="n">shadowAttenuation</span><span class="p">);</span>
            <span class="kt">float</span> <span class="n">shadow</span> <span class="o">=</span> <span class="n">smoothstep</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">attenuationChange</span><span class="p">,</span> <span class="n">shadowAttenuation</span><span class="p">);</span>
        <span class="cp">#endif
</span>            <span class="n">lightIntensity</span> <span class="o">=</span> <span class="n">lightIntensity</span> <span class="o">*</span> <span class="n">shadow</span><span class="p">;</span>

            <span class="c1">//calculate how much the surface points points towards the reflection direction</span>
            <span class="n">float3</span> <span class="n">reflectionDirection</span> <span class="o">=</span> <span class="n">reflect</span><span class="p">(</span><span class="n">lightDir</span><span class="p">,</span> <span class="n">s</span><span class="p">.</span><span class="n">Normal</span><span class="p">);</span>
            <span class="kt">float</span> <span class="n">towardsReflection</span> <span class="o">=</span> <span class="n">dot</span><span class="p">(</span><span class="n">viewDir</span><span class="p">,</span> <span class="o">-</span><span class="n">reflectionDirection</span><span class="p">);</span>

            <span class="c1">//make specular highlight all off towards outside of model</span>
            <span class="kt">float</span> <span class="n">specularFalloff</span> <span class="o">=</span> <span class="n">dot</span><span class="p">(</span><span class="n">viewDir</span><span class="p">,</span> <span class="n">s</span><span class="p">.</span><span class="n">Normal</span><span class="p">);</span>
            <span class="n">specularFalloff</span> <span class="o">=</span> <span class="n">pow</span><span class="p">(</span><span class="n">specularFalloff</span><span class="p">,</span> <span class="n">_SpecularFalloff</span><span class="p">);</span>
            <span class="n">towardsReflection</span> <span class="o">=</span> <span class="n">towardsReflection</span> <span class="o">*</span> <span class="n">specularFalloff</span><span class="p">;</span>

            <span class="c1">//make specular intensity with a hard corner</span>
            <span class="kt">float</span> <span class="n">specularChange</span> <span class="o">=</span> <span class="n">fwidth</span><span class="p">(</span><span class="n">towardsReflection</span><span class="p">);</span>
            <span class="kt">float</span> <span class="n">specularIntensity</span> <span class="o">=</span> <span class="n">smoothstep</span><span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">_SpecularSize</span><span class="p">,</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">_SpecularSize</span> <span class="o">+</span> <span class="n">specularChange</span><span class="p">,</span> <span class="n">towardsReflection</span><span class="p">);</span>
            <span class="c1">//factor inshadows</span>
            <span class="n">specularIntensity</span> <span class="o">=</span> <span class="n">specularIntensity</span> <span class="o">*</span> <span class="n">shadow</span><span class="p">;</span>

            <span class="n">float4</span> <span class="n">color</span><span class="p">;</span>
            <span class="c1">//calculate final color</span>
            <span class="n">color</span><span class="p">.</span><span class="n">rgb</span> <span class="o">=</span> <span class="n">s</span><span class="p">.</span><span class="n">Albedo</span> <span class="o">*</span> <span class="n">lightIntensity</span> <span class="o">*</span> <span class="n">_LightColor0</span><span class="p">.</span><span class="n">rgb</span><span class="p">;</span>
            <span class="n">color</span><span class="p">.</span><span class="n">rgb</span> <span class="o">=</span> <span class="n">lerp</span><span class="p">(</span><span class="n">color</span><span class="p">.</span><span class="n">rgb</span><span class="p">,</span> <span class="n">s</span><span class="p">.</span><span class="n">Specular</span> <span class="o">*</span> <span class="n">_LightColor0</span><span class="p">.</span><span class="n">rgb</span><span class="p">,</span> <span class="n">saturate</span><span class="p">(</span><span class="n">specularIntensity</span><span class="p">));</span>

            <span class="n">color</span><span class="p">.</span><span class="n">a</span> <span class="o">=</span> <span class="n">s</span><span class="p">.</span><span class="n">Alpha</span><span class="p">;</span>
            <span class="k">return</span> <span class="n">color</span><span class="p">;</span>
        <span class="p">}</span>


        <span class="c1">//input struct which is automatically filled by unity</span>
        <span class="k">struct</span> <span class="n">Input</span> <span class="p">{</span>
            <span class="n">float2</span> <span class="n">uv_MainTex</span><span class="p">;</span>
        <span class="p">};</span>

        <span class="c1">//the surface shader function which sets parameters the lighting function then uses</span>
        <span class="kt">void</span> <span class="n">surf</span> <span class="p">(</span><span class="n">Input</span> <span class="n">i</span><span class="p">,</span> <span class="k">inout</span> <span class="n">ToonSurfaceOutput</span> <span class="n">o</span><span class="p">)</span> <span class="p">{</span>
            <span class="c1">//sample and tint albedo texture</span>
            <span class="n">fixed4</span> <span class="n">col</span> <span class="o">=</span> <span class="n">tex2D</span><span class="p">(</span><span class="n">_MainTex</span><span class="p">,</span> <span class="n">i</span><span class="p">.</span><span class="n">uv_MainTex</span><span class="p">);</span>
            <span class="n">col</span> <span class="o">*=</span> <span class="n">_Color</span><span class="p">;</span>
            <span class="n">o</span><span class="p">.</span><span class="n">Albedo</span> <span class="o">=</span> <span class="n">col</span><span class="p">.</span><span class="n">rgb</span><span class="p">;</span>

            <span class="n">o</span><span class="p">.</span><span class="n">Specular</span> <span class="o">=</span> <span class="n">_Specular</span><span class="p">;</span>

            <span class="n">float3</span> <span class="n">shadowColor</span> <span class="o">=</span> <span class="n">col</span><span class="p">.</span><span class="n">rgb</span> <span class="o">*</span> <span class="n">_ShadowTint</span><span class="p">;</span>
            <span class="n">o</span><span class="p">.</span><span class="n">Emission</span> <span class="o">=</span> <span class="n">_Emission</span> <span class="o">+</span> <span class="n">shadowColor</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="n">ENDCG</span>
    <span class="p">}</span>
    <span class="n">FallBack</span> <span class="s">"Standard"</span>
<span class="p">}</span>
</code></pre></div></div>

<p>I mainly concentrated on the lighting function in those tutorials, you can easily expand the shader by writing different values from the surface function and use textures for emissive color or normals. I also think it might be a good call to add the specular size to the surface struct and use that in the lighting function to be able to do drive the look more via textures. Whatever you end up doing I hope this tutorial made you curious about non photorealistic lighting and helped you realise the look you wanted to create.</p>


    <p>
        You can also find me on twitter at <a href="https://www.twitter.com/totallyRonja">@totallyRonja</a>. If you liked my tutorial and want to support me you can do that on Patreon (<a href="https://www.patreon.com/RonjaTutorials">patreon.com/RonjaTutorials</a>) or Ko-Fi (<a href="https://ko-fi.com/RonjaTutorials">ko-fi.com/RonjaTutorials</a>).
    </p>
  </div>

  
    <div id="disqus_thread"></div>
<script>

/**
*  RECOMMENDED CONFIGURATION VARIABLES: EDIT AND UNCOMMENT THE SECTION BELOW TO INSERT DYNAMIC VALUES FROM YOUR PLATFORM OR CMS.
*  LEARN WHY DEFINING THESE VARIABLES IS IMPORTANT: https://disqus.com/admin/universalcode/#configuration-variables*/
/*
var disqus_config = function () {
this.page.url = PAGE_URL;  // Replace PAGE_URL with your page's canonical URL variable
this.page.identifier = PAGE_IDENTIFIER; // Replace PAGE_IDENTIFIER with your page's unique identifier variable
};
*/
(function() { // DON'T EDIT BELOW THIS LINE
var d = document, s = d.createElement('script');
s.src = 'https://ronja-tutorials.disqus.com/embed.js';
s.setAttribute('data-timestamp', +new Date());
(d.head || d.body).appendChild(s);
})();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
                            
  
</article>


      <!-- SVG icons from https://iconmonstr.com -->

      <!-- Twitter icon -->
      <span class="my-span-icon">
          <a href="https://twitter.com/TotallyRonja" aria-label="'s Twitter" title="'s Twitter">
            <svg class="my-svg-icon" xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24" style="margin-top: 12px;margin-left: 13px;"><path d="M12 0c-6.627 0-12 5.373-12 12s5.373 12 12 12 12-5.373 12-12-5.373-12-12-12zm6.066 9.645c.183 4.04-2.83 8.544-8.164 8.544-1.622 0-3.131-.476-4.402-1.291 1.524.18 3.045-.244 4.252-1.189-1.256-.023-2.317-.854-2.684-1.995.451.086.895.061 1.298-.049-1.381-.278-2.335-1.522-2.304-2.853.388.215.83.344 1.301.359-1.279-.855-1.641-2.544-.889-3.835 1.416 1.738 3.533 2.881 5.92 3.001-.419-1.796.944-3.527 2.799-3.527.825 0 1.572.349 2.096.907.654-.128 1.27-.368 1.824-.697-.215.671-.67 1.233-1.263 1.589.581-.07 1.135-.224 1.649-.453-.384.578-.87 1.084-1.433 1.489z"/></svg>
          </a>
        </span>

        <!-- RSS icon -->
        
          <span class="my-span-icon">
            <a href="/feed.xml" aria-label="RSS feed" title="'s RSS feed">
              <svg class="my-svg-icon" xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24"><path d="M12 0c-6.627 0-12 5.373-12 12s5.373 12 12 12 12-5.373 12-12-5.373-12-12-12zm-3.374 17c-.897 0-1.626-.727-1.626-1.624s.729-1.624 1.626-1.624 1.626.727 1.626 1.624-.729 1.624-1.626 1.624zm3.885 0c-.03-3.022-2.485-5.474-5.511-5.504v-2.406c4.361.03 7.889 3.555 7.92 7.91h-2.409zm4.081 0c-.016-5.297-4.303-9.571-9.592-9.594v-2.406c6.623.023 11.985 5.384 12 12h-2.408z"/></svg>
            </a>
          </span>
        
        <!-- Contact icon -->
        
        
          <span class="my-span-icon">
            <a href="/about.html" aria-label="Contact" title="Contact ">
              <svg class="my-svg-icon" xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24"><path d="M12 .02c-6.627 0-12 5.373-12 12s5.373 12 12 12 12-5.373 12-12-5.373-12-12-12zm6.99 6.98l-6.99 5.666-6.991-5.666h13.981zm.01 10h-14v-8.505l7 5.673 7-5.672v8.504z"/></svg>
            </a>
          </span>
        
    </section>

    
      <script type="text/javascript">
        (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
        (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
        m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
        })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

        ga('create', 'UA-124040112-1', 'auto');
        ga('send', 'pageview');
      </script>
    
  </body>
</html>
