<!DOCTYPE html>
<html lang="en">

  <head>

    <!-- Non social metatags -->
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <meta name="theme-color" content="#157878">

    

    <title>2D SDF Shadows</title>

    
      <!-- Update your html tag to include the itemscope and itemtype attributes. -->
<html itemscope itemtype="http://schema.org/Article">












<!-- Place this data between the <head> tags of your website -->

  <meta name="author" content="Ronja Böhringer">

<meta name="description" content="Now that we know the basics on how to combine signed distance functions, we can use them to do cool stuff with them. In this tutorial we’ll use them ..." />





<!-- Schema.org markup for Google+ -->
<meta itemprop="name" content="2D SDF Shadows">
<meta itemprop="description" content="Now that we know the basics on how to combine signed distance functions, we can use them to do cool stuff with them. In this tutorial we’ll use them ...">

  <meta itemprop="image" content="https://www.ronja-tutorials.com/assets/images/posts/037/Result.gif">


<!-- Twitter Card data -->
<meta name="twitter:card" content="summary_large_image">



<meta name="twitter:title" content="2D SDF Shadows">
<meta name="twitter:description" content="Now that we know the basics on how to combine signed distance functions, we can use them to do cool stuff with them. In this tutorial we’ll use them ...">


  <meta name="twitter:creator" content="@TotallyRonja">


<!-- Twitter summary card with large image must be at least 280x150px -->

  <meta name="twitter:image:src" content="https://www.ronja-tutorials.com/assets/images/posts/037/Result.gif">
  <meta property="twitter:image" content="https://www.ronja-tutorials.com/assets/images/posts/037/Result.gif">

<meta property="twitter:url" content="https://www.ronja-tutorials.com/2018/12/01/2d-shadows.html">

<!-- Open Graph data -->
<meta property="og:title" content="2D SDF Shadows" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://www.ronja-tutorials.com/2018/12/01/2d-shadows.html" />

  <meta property="og:image" content="https://www.ronja-tutorials.com/assets/images/posts/037/Result.gif" />

<meta property="og:description" content="Now that we know the basics on how to combine signed distance functions, we can use them to do cool stuff with them. In this tutorial we’ll use them ..." />
<meta property="og:site_name" content="Ronja's Shader Tutorials" />

  <meta property="article:published_time" content="2018-12-01T00:00:00+01:00" />














  





  




    

    <link rel="canonical" href="https://www.ronja-tutorials.com/2018/12/01/2d-shadows.html">

    

    <!-- <link rel="shortcut icon" href="https://www.ronja-tutorials.com/favicon.ico"> -->
    <meta name="robots" content="noarchive">

    <!-- <link rel="alternate" media="only screen and (max-width: 640px)" href="">
    <link rel="alternate" media="handheld" href=""> -->


    <link href='https://fonts.googleapis.com/css?family=Open+Sans:400,700' rel='stylesheet' type='text/css'>
    <script async defer data-website-id="fb34d410-ef67-4a3a-8fdc-01a05f5e22b2" src="https://stats.ruby0x1.ca/umami.js" ></script>
    <link rel="stylesheet" href="/assets/css/style.css?v=">
  </head>
  <body>

    <header class="site-header" role="banner">

  <div class="wrapper">
    
    

    
      <a class="site-title" href="/">Ronja&#39;s Shader Tutorials</a>
    
    <!-- SVG icons from https://iconmonstr.com -->

    <!-- Twitter icon -->
    <span class="my-span-icon">
        <a href="https://twitter.com/TotallyRonja" aria-label="'s Twitter" title="'s Twitter">
          <svg class="my-svg-icon" xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24" style="margin-top: 12px;margin-left: 13px;"><path d="M12 0c-6.627 0-12 5.373-12 12s5.373 12 12 12 12-5.373 12-12-5.373-12-12-12zm6.066 9.645c.183 4.04-2.83 8.544-8.164 8.544-1.622 0-3.131-.476-4.402-1.291 1.524.18 3.045-.244 4.252-1.189-1.256-.023-2.317-.854-2.684-1.995.451.086.895.061 1.298-.049-1.381-.278-2.335-1.522-2.304-2.853.388.215.83.344 1.301.359-1.279-.855-1.641-2.544-.889-3.835 1.416 1.738 3.533 2.881 5.92 3.001-.419-1.796.944-3.527 2.799-3.527.825 0 1.572.349 2.096.907.654-.128 1.27-.368 1.824-.697-.215.671-.67 1.233-1.263 1.589.581-.07 1.135-.224 1.649-.453-.384.578-.87 1.084-1.433 1.489z"/></svg>
        </a>
      </span>

      <!-- RSS icon -->
      
        <span class="my-span-icon">
          <a href="/feed.xml" aria-label="RSS feed" title="'s RSS feed">
            <svg class="my-svg-icon" xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24"><path d="M12 0c-6.627 0-12 5.373-12 12s5.373 12 12 12 12-5.373 12-12-5.373-12-12-12zm-3.374 17c-.897 0-1.626-.727-1.626-1.624s.729-1.624 1.626-1.624 1.626.727 1.626 1.624-.729 1.624-1.626 1.624zm3.885 0c-.03-3.022-2.485-5.474-5.511-5.504v-2.406c4.361.03 7.889 3.555 7.92 7.91h-2.409zm4.081 0c-.016-5.297-4.303-9.571-9.592-9.594v-2.406c6.623.023 11.985 5.384 12 12h-2.408z"/></svg>
          </a>
        </span>
      
      <!-- Contact icon -->
      
      
        <span class="my-span-icon">
          <a href="/about.html" aria-label="Contact" title="Contact ">
            <svg class="my-svg-icon" xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24"><path d="M12 .02c-6.627 0-12 5.373-12 12s5.373 12 12 12 12-5.373 12-12-5.373-12-12-12zm6.99 6.98l-6.99 5.666-6.991-5.666h13.981zm.01 10h-14v-8.505l7 5.673 7-5.672v8.504z"/></svg>
          </a>
        </span>
      

    
      <nav class="site-nav">
        <input type="checkbox" id="nav-trigger" class="nav-trigger" />
        <label for="nav-trigger">
          <span class="menu-icon">
            <svg viewBox="0 0 18 15" width="18px" height="15px">
              <path fill="#424242" d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.031C17.335,0,18,0.665,18,1.484L18,1.484z"/>
              <path fill="#424242" d="M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0c0-0.82,0.665-1.484,1.484-1.484 h15.031C17.335,6.031,18,6.696,18,7.516L18,7.516z"/>
              <path fill="#424242" d="M18,13.516C18,14.335,17.335,15,16.516,15H1.484C0.665,15,0,14.335,0,13.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.031C17.335,12.031,18,12.696,18,13.516L18,13.516z"/>
            </svg>
          </span>
        </label>

        <div class="trigger">
          
            
            
              
              
            
          
            
            
          
            
            
              
                <a class="page-link" href="/about.html">About</a>
              
            
          
            
            
          
            
            
          
            
            
          
            
            
          
            
            
              
                <a class="page-link" href="/2018/03/20/hlsl-basics.html"></a>
              
            
          
            
            
              
                <a class="page-link" href="/2018/03/20/hlsl-basics.html"></a>
              
            
          
            
            
              
                <a class="page-link" href="/2018/03/20/hlsl-basics.html"></a>
              
            
          
            
            
              
                <a class="page-link" href="/2018/03/20/hlsl-basics.html"></a>
              
            
          
            
            
          
            
            
          
        </div>
      </nav>
    
  </div>
</header>


    
    
    

    <section class="page-header">
      <h1 class="project-name">2D SDF Shadows</h1>
      <h2 class="project-tagline"></h2>
      
      <!-- Post tagline -->
      
        <h2 class="project-date">
        <time datetime="2018-12-01T00:00:00+01:00" itemprop="datePublished">
          
          Dec 1, 2018
        </time>
        
        
          • <span itemprop="author" itemscope itemtype="http://schema.org/Person"><span itemprop="name">Ronja Böhringer</span></span>
        
        </h2>
      
      <!-- End: Post tagline -->
    </section>

    <section class="main-content">

      <article itemscope itemtype="http://schema.org/BlogPosting">

  <!-- <header class="post-header">
    <h1 class="post-title" itemprop="name headline">2D SDF Shadows</h1>
    <p class="post-meta">
      <time datetime="2018-12-01T00:00:00+01:00" itemprop="datePublished">
        
        Dec 1, 2018
      </time>
      </p>
  </header> -->

  
<ul>
  <li><a href="#base-setup">Base Setup</a></li>
  <li><a href="#simple-shadows">Simple Shadows</a></li>
  <li><a href="#soft-shadows">Soft Shadows</a></li>
  <li><a href="#multiple-lights">Multiple lights</a></li>
  <li><a href="#source">Source</a>
    <ul>
      <li><a href="#2d-sdf-library-unchanged-but-used-here">2D SDF Library (unchanged but used here)</a></li>
      <li><a href="#2d-soft-shadows">2D Soft Shadows</a></li>
    </ul>
  </li>
</ul>

  <div itemprop="articleBody">
    <p>Now that we know the basics on how to combine signed distance functions, we can use them to do cool stuff with them. In this tutorial we’ll use them to render 2d soft shadows. If you haven’t read my previous tutorials about signed distance fields yet, I highly recommend you do that first, starting at the <a href="/2018/11/10/2d-sdf-basics.html">tutorial about how to create simple shapes</a>.</p>

<p><img src="/assets/images/posts/037/Result.gif" alt="" /></p>

<h2 id="base-setup">Base Setup</h2>

<p>I did a simple room setup here, it uses the techniques described in earlier tutorials. Two things I used that I didn’t explicitely mention previously are that I used a <code class="language-plaintext highlighter-rouge">abs</code> on a vector2 to mirror the position around both the x and y axis and that I negated a shape distance to flip the inside and outside.</p>

<p>We also copy the <a href="https://github.com/ronja-tutorials/ShaderTutorials/blob/master/Assets/037_SDF_2D_Shadows/2D_SDF.cginc">2D_SDF.cginc</a> file from the previous tutorial to the same folder as the shader we’re writing for this one.</p>

<div class="language-glsl highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">Shader</span> <span class="s">"Tutorial/037_2D_SDF_Shadows"</span><span class="p">{</span>
    <span class="n">Properties</span><span class="p">{</span>
    <span class="p">}</span>

    <span class="n">SubShader</span><span class="p">{</span>
        <span class="c1">//the material is completely non-transparent and is rendered at the same time as the other opaque geometry</span>
        <span class="n">Tags</span><span class="p">{</span> <span class="s">"RenderType"</span><span class="o">=</span><span class="s">"Opaque"</span> <span class="s">"Queue"</span><span class="o">=</span><span class="s">"Geometry"</span><span class="p">}</span>

        <span class="n">Pass</span><span class="p">{</span>
            <span class="n">CGPROGRAM</span>

            <span class="cp">#include "UnityCG.cginc"
</span>            <span class="cp">#include "2D_SDF.cginc"
</span>
            <span class="cp">#pragma vertex vert
</span>            <span class="cp">#pragma fragment frag
</span>
            <span class="k">struct</span> <span class="n">appdata</span><span class="p">{</span>
                <span class="n">float4</span> <span class="n">vertex</span> <span class="o">:</span> <span class="n">POSITION</span><span class="p">;</span>
            <span class="p">};</span>

            <span class="k">struct</span> <span class="n">v2f</span><span class="p">{</span>
                <span class="n">float4</span> <span class="n">position</span> <span class="o">:</span> <span class="n">SV_POSITION</span><span class="p">;</span>
                <span class="n">float4</span> <span class="n">worldPos</span> <span class="o">:</span> <span class="n">TEXCOORD0</span><span class="p">;</span>
            <span class="p">};</span>

            <span class="n">v2f</span> <span class="n">vert</span><span class="p">(</span><span class="n">appdata</span> <span class="n">v</span><span class="p">){</span>
                <span class="n">v2f</span> <span class="n">o</span><span class="p">;</span>
                <span class="c1">//calculate the position in clip space to render the object</span>
                <span class="n">o</span><span class="p">.</span><span class="n">position</span> <span class="o">=</span> <span class="n">UnityObjectToClipPos</span><span class="p">(</span><span class="n">v</span><span class="p">.</span><span class="n">vertex</span><span class="p">);</span>
                <span class="c1">//calculate world position of vertex</span>
                <span class="n">o</span><span class="p">.</span><span class="n">worldPos</span> <span class="o">=</span> <span class="n">mul</span><span class="p">(</span><span class="n">unity_ObjectToWorld</span><span class="p">,</span> <span class="n">v</span><span class="p">.</span><span class="n">vertex</span><span class="p">);</span>
                <span class="k">return</span> <span class="n">o</span><span class="p">;</span>
            <span class="p">}</span>

            <span class="kt">float</span> <span class="n">scene</span><span class="p">(</span><span class="n">float2</span> <span class="n">position</span><span class="p">)</span> <span class="p">{</span>
                <span class="kt">float</span> <span class="n">bounds</span> <span class="o">=</span> <span class="o">-</span><span class="n">rectangle</span><span class="p">(</span><span class="n">position</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>

                <span class="n">float2</span> <span class="n">quarterPos</span> <span class="o">=</span> <span class="n">abs</span><span class="p">(</span><span class="n">position</span><span class="p">);</span>

                <span class="kt">float</span> <span class="n">corner</span> <span class="o">=</span> <span class="n">rectangle</span><span class="p">(</span><span class="n">translate</span><span class="p">(</span><span class="n">quarterPos</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="mi">0</span><span class="p">.</span><span class="mi">5</span><span class="p">);</span>
                <span class="n">corner</span> <span class="o">=</span> <span class="n">subtract</span><span class="p">(</span><span class="n">corner</span><span class="p">,</span> <span class="n">rectangle</span><span class="p">(</span><span class="n">position</span><span class="p">,</span> <span class="mi">1</span><span class="p">.</span><span class="mi">2</span><span class="p">));</span>

                <span class="kt">float</span> <span class="n">diamond</span> <span class="o">=</span> <span class="n">rectangle</span><span class="p">(</span><span class="n">rotate</span><span class="p">(</span><span class="n">position</span><span class="p">,</span> <span class="mi">0</span><span class="p">.</span><span class="mi">125</span><span class="p">),</span> <span class="p">.</span><span class="mi">5</span><span class="p">);</span>

                <span class="kt">float</span> <span class="n">world</span> <span class="o">=</span> <span class="n">merge</span><span class="p">(</span><span class="n">bounds</span><span class="p">,</span> <span class="n">corner</span><span class="p">);</span>
                <span class="n">world</span> <span class="o">=</span> <span class="n">merge</span><span class="p">(</span><span class="n">world</span><span class="p">,</span> <span class="n">diamond</span><span class="p">);</span>

                <span class="k">return</span> <span class="n">world</span><span class="p">;</span>
            <span class="p">}</span>

            <span class="n">fixed4</span> <span class="n">frag</span><span class="p">(</span><span class="n">v2f</span> <span class="n">i</span><span class="p">)</span> <span class="o">:</span> <span class="n">SV_TARGET</span><span class="p">{</span>
                <span class="kt">float</span> <span class="n">dist</span> <span class="o">=</span> <span class="n">scene</span><span class="p">(</span><span class="n">i</span><span class="p">.</span><span class="n">worldPos</span><span class="p">.</span><span class="n">xz</span><span class="p">);</span>
                <span class="k">return</span> <span class="n">dist</span><span class="p">;</span>
            <span class="p">}</span>

            <span class="n">ENDCG</span>
        <span class="p">}</span>
    <span class="p">}</span>
    <span class="n">FallBack</span> <span class="s">"Standard"</span> <span class="c1">//fallback adds a shadow pass so we get shadows on other objects</span>
<span class="p">}</span>
</code></pre></div></div>

<p>If we still used the visualisation technique we used in the previous tutorials, this shape would look like this:</p>

<p><img src="/assets/images/posts/037/SDF_Shape.png" alt="" /></p>

<h2 id="simple-shadows">Simple Shadows</h2>

<p>For hard shadows, we walk the space from the sample position to he light position. If we find a object on the way there we decide that the pixel should be shadowed and if we get to the light without being interrupted we say that it’s not shadowed.</p>

<p>We start by calculating the base parameters of a ray. We already have the origin (the position of the pixel we’re rendering) and the goal (the position of the light) of the ray. What we need is the length and the normalised direction. We can get the direction by subtracting the start from the destination and normalising the result and the length by subtracting the positions and passing it to the <code class="language-plaintext highlighter-rouge">length</code> method.</p>

<div class="language-glsl highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">float</span> <span class="nf">traceShadow</span><span class="p">(</span><span class="n">float2</span> <span class="n">position</span><span class="p">,</span> <span class="n">float2</span> <span class="n">lightPosition</span><span class="p">){</span>
    <span class="kt">float</span> <span class="n">direction</span> <span class="o">=</span> <span class="n">normalise</span><span class="p">(</span><span class="n">lightPosition</span> <span class="o">-</span> <span class="n">position</span><span class="p">);</span>
    <span class="kt">float</span> <span class="n">distance</span> <span class="o">=</span> <span class="n">length</span><span class="p">(</span><span class="n">lightPosition</span> <span class="o">-</span> <span class="n">position</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div></div>

<p>Then we iterate through the ray in a for loop. We’ll set the iterations of the loop via a define declaration, this allows us to adjust the maximum amount of iterations later and also allows the compiler to optimise the shader a bit by unrolling the loop.</p>

<p>In the loop we need a position at which we currently are, so we declare that outside of the loop with a start value of 0. Then back in the loop we can calculate the sample position by adding the ray progress multiplied by the ray direction to the base position. Then we sample the signed distance function at the position we just calculated.</p>

<div class="language-glsl highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// outside of function</span>
<span class="cp">#define SAMPLES 32
</span>
<span class="c1">// in shadow function</span>
<span class="kt">float</span> <span class="n">rayDistance</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="k">for</span><span class="p">(</span><span class="kt">int</span> <span class="n">i</span><span class="o">=</span><span class="mi">0</span> <span class="p">;</span><span class="n">i</span><span class="o">&lt;</span><span class="n">SAMPLES</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">){</span>
    <span class="kt">float</span> <span class="n">sceneDist</span> <span class="o">=</span> <span class="n">scene</span><span class="p">(</span><span class="n">pos</span> <span class="o">+</span> <span class="n">direction</span> <span class="o">*</span> <span class="n">rayDistance</span><span class="p">);</span>

    <span class="c1">//do other stuff and move the ray further</span>
<span class="p">}</span>
</code></pre></div></div>

<p>Then we can do checks whether we’re already at the point where we can abort the loop. If the scene distance of the signed distance function is near 1, we can assume the ray was blocked by a shape and we return 0. If the ray progress is bigger than the light distance, we can assume that we reached the light without any collisions and return a value of 1.</p>

<p>If we didn’t return yet, we then have to calculate the next sample position. We do that by adding the distance of the scene to the ray progress. The reason for this is that the scene distance gives us the distance to the nearest shape, so if we add that amount to our ray, we can’t possibly cast our ray further than the nearest shape, or even beyond it, which would allow for shadow leaking.</p>

<p>In case we don’t hit anything and also don’t find the light by the time we used our whole sample budget (the loop ended), we also have to return a value. Because this mainly happens near shapes, shortly before the pixel would count as occluded anyways, we’ll use a return value of 0 here.</p>

<div class="language-glsl highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">#define SAMPLES 32
</span>
<span class="kt">float</span> <span class="nf">traceShadows</span><span class="p">(</span><span class="n">float2</span> <span class="n">position</span><span class="p">,</span> <span class="n">float2</span> <span class="n">lightPosition</span><span class="p">){</span>
    <span class="n">float2</span> <span class="n">direction</span> <span class="o">=</span> <span class="n">normalize</span><span class="p">(</span><span class="n">lightPosition</span> <span class="o">-</span> <span class="n">position</span><span class="p">);</span>
    <span class="kt">float</span> <span class="n">lightDistance</span> <span class="o">=</span> <span class="n">length</span><span class="p">(</span><span class="n">lightPosition</span> <span class="o">-</span> <span class="n">position</span><span class="p">);</span>

    <span class="kt">float</span> <span class="n">rayProgress</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="k">for</span><span class="p">(</span><span class="kt">int</span> <span class="n">i</span><span class="o">=</span><span class="mi">0</span> <span class="p">;</span><span class="n">i</span><span class="o">&lt;</span><span class="n">SAMPLES</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">){</span>
        <span class="kt">float</span> <span class="n">sceneDist</span> <span class="o">=</span> <span class="n">scene</span><span class="p">(</span><span class="n">position</span> <span class="o">+</span> <span class="n">direction</span> <span class="o">*</span> <span class="n">rayProgress</span><span class="p">);</span>

        <span class="k">if</span><span class="p">(</span><span class="n">sceneDist</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">){</span>
            <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="k">if</span><span class="p">(</span><span class="n">rayProgress</span> <span class="o">&gt;</span> <span class="n">lightDistance</span><span class="p">){</span>
            <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="n">rayProgress</span> <span class="o">=</span> <span class="n">rayProgress</span> <span class="o">+</span> <span class="n">sceneDist</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>

<p>To use the function, we call it in the fragment function with the pixel position and the light position. Then we can multiply the result with any color to tint it in the lights color.</p>

<p>I used the technique described in <a href="/2018/11/10/2d-sdf-basics.html#hard-shape">the first tutorial I made about signed distance fields</a> to also visualise the geometry. Then I simply added the shadows and the geometry. We can use a simple add operation here instead of doing a linear interpolation or similar because the shape color is black everywhere where there’s no shape and the shadow color is black everywhere where there is a shape.</p>

<p>fixed4 frag(v2f i) : SV_TARGET{
    float2 position = i.worldPos.xz;</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>float2 lightPos;
sincos(_Time.y, lightPos.x /*sine of time*/, lightPos.y /*cosine of time*/);
float shadows = traceShadows(position, lightPos);
float3 light = shadows * float3(.6, .6, 1);

float sceneDistance = scene(position);
float distanceChange = fwidth(sceneDistance) * 0.5;
float binaryScene = smoothstep(distanceChange, -distanceChange, sceneDistance);
float3 geometry = binaryScene * float3(0, 0.3, 0.1);

float3 col = geometry + light;

return float4(col, 1); }
</code></pre></div></div>

<p><img src="/assets/images/posts/037/HardShadows.gif" alt="" /></p>

<h2 id="soft-shadows">Soft Shadows</h2>

<p>The upgrade from those hard shadows to softer, more realistic ones is pretty straightforward and doesn’t make the shader much more performance intensive.</p>

<p>Out first take on this will just get the distance to the nearest scene object for every sample we go through and get the nearest one, then where we previously returned just 1, we can return the distance to the nearest shape. To prevent the shadow intensity to get too high and lead to weird colors when used, we pass it through the <code class="language-plaintext highlighter-rouge">saturate</code> method which clamps it between 0 and 1. We get the minimum between the current nearest shape and the next one after the check wether the progress reached the light already, otherwise we could take samples that overshot to behind the light and get weird artefacts.</p>

<div class="language-glsl highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">float</span> <span class="nf">traceShadows</span><span class="p">(</span><span class="n">float2</span> <span class="n">position</span><span class="p">,</span> <span class="n">float2</span> <span class="n">lightPosition</span><span class="p">){</span>
    <span class="n">float2</span> <span class="n">direction</span> <span class="o">=</span> <span class="n">normalize</span><span class="p">(</span><span class="n">lightPosition</span> <span class="o">-</span> <span class="n">position</span><span class="p">);</span>
    <span class="kt">float</span> <span class="n">lightDistance</span> <span class="o">=</span> <span class="n">length</span><span class="p">(</span><span class="n">lightPosition</span> <span class="o">-</span> <span class="n">position</span><span class="p">);</span>

    <span class="kt">float</span> <span class="n">rayProgress</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="kt">float</span> <span class="n">nearest</span> <span class="o">=</span> <span class="mi">9999</span><span class="p">;</span>
    <span class="k">for</span><span class="p">(</span><span class="kt">int</span> <span class="n">i</span><span class="o">=</span><span class="mi">0</span> <span class="p">;</span><span class="n">i</span><span class="o">&lt;</span><span class="n">SAMPLES</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">){</span>
        <span class="kt">float</span> <span class="n">sceneDist</span> <span class="o">=</span> <span class="n">scene</span><span class="p">(</span><span class="n">position</span> <span class="o">+</span> <span class="n">direction</span> <span class="o">*</span> <span class="n">rayProgress</span><span class="p">);</span>

        <span class="k">if</span><span class="p">(</span><span class="n">sceneDist</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">){</span>
            <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="k">if</span><span class="p">(</span><span class="n">rayProgress</span> <span class="o">&gt;</span> <span class="n">lightDistance</span><span class="p">){</span>
            <span class="k">return</span> <span class="n">saturate</span><span class="p">(</span><span class="n">nearest</span><span class="p">);</span>
        <span class="p">}</span>

        <span class="n">nearest</span> <span class="o">=</span> <span class="n">min</span><span class="p">(</span><span class="n">nearest</span><span class="p">,</span> <span class="n">sceneDist</span><span class="p">);</span>

        <span class="n">rayProgress</span> <span class="o">=</span> <span class="n">rayProgress</span> <span class="o">+</span> <span class="n">sceneDist</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>

<p><img src="/assets/images/posts/037/HardCuts.png" alt="" /></p>

<p>The first thing we notice when we do this is the weird “teeth” in the shadows. The reason they appear is that the distance to the scene from the light is less than 1. I tried a lot to counteract that, but didn’t find a solution. What we can do instead is to implement the hardness of the shadows. The hardness will be another parameter in the shadow function. In the loop we multiply the scene distance with the hardness, so with a hardness of 2, the soft, grey part of the shadow is only half as big as before. When using the hardness, the light is allowed to be 1 divided by the hardness close to a shape until the artefacts appear. So if we now use a hardness of 20, we have a distance of 0.05 units we should respect.</p>

<div class="language-glsl highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">float</span> <span class="nf">traceShadows</span><span class="p">(</span><span class="n">float2</span> <span class="n">position</span><span class="p">,</span> <span class="n">float2</span> <span class="n">lightPosition</span><span class="p">,</span> <span class="kt">float</span> <span class="n">hardness</span><span class="p">){</span>
    <span class="n">float2</span> <span class="n">direction</span> <span class="o">=</span> <span class="n">normalize</span><span class="p">(</span><span class="n">lightPosition</span> <span class="o">-</span> <span class="n">position</span><span class="p">);</span>
    <span class="kt">float</span> <span class="n">lightDistance</span> <span class="o">=</span> <span class="n">length</span><span class="p">(</span><span class="n">lightPosition</span> <span class="o">-</span> <span class="n">position</span><span class="p">);</span>

    <span class="kt">float</span> <span class="n">rayProgress</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="kt">float</span> <span class="n">nearest</span> <span class="o">=</span> <span class="mi">9999</span><span class="p">;</span>
    <span class="k">for</span><span class="p">(</span><span class="kt">int</span> <span class="n">i</span><span class="o">=</span><span class="mi">0</span> <span class="p">;</span><span class="n">i</span><span class="o">&lt;</span><span class="n">SAMPLES</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">){</span>
        <span class="kt">float</span> <span class="n">sceneDist</span> <span class="o">=</span> <span class="n">scene</span><span class="p">(</span><span class="n">position</span> <span class="o">+</span> <span class="n">direction</span> <span class="o">*</span> <span class="n">rayProgress</span><span class="p">);</span>

        <span class="k">if</span><span class="p">(</span><span class="n">sceneDist</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">){</span>
            <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="k">if</span><span class="p">(</span><span class="n">rayProgress</span> <span class="o">&gt;</span> <span class="n">lightDistance</span><span class="p">){</span>
            <span class="k">return</span> <span class="n">saturate</span><span class="p">(</span><span class="n">nearest</span><span class="p">);</span>
        <span class="p">}</span>

        <span class="n">nearest</span> <span class="o">=</span> <span class="n">min</span><span class="p">(</span><span class="n">nearest</span><span class="p">,</span> <span class="n">hardness</span> <span class="o">*</span> <span class="n">sceneDist</span><span class="p">);</span>

        <span class="n">rayProgress</span> <span class="o">=</span> <span class="n">rayProgress</span> <span class="o">+</span> <span class="n">sceneDist</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>

<div class="language-glsl highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">//in fragment function</span>
<span class="kt">float</span> <span class="n">shadows</span> <span class="o">=</span> <span class="n">traceShadows</span><span class="p">(</span><span class="n">position</span><span class="p">,</span> <span class="n">lightPos</span><span class="p">,</span> <span class="mi">20</span><span class="p">);</span>
</code></pre></div></div>

<p><img src="/assets/images/posts/037/HarderWrongSoftShadows.png" alt="" /></p>

<p>With this problem minimised, the next thing we see is that even in the areas that shouldn’t be shadowed, we still see a falloff near walls. Also the softness of the shadow seems similar over the whole shadow, not hard near the shape and softer the further away the point is from the caster.</p>

<p>The way we fix this is by dividing the scene distance by the ray progress. By doing this we divide the distance by very small numbers where the ray starts, that means we still get high numbers and a nice crisp shadow. When we find the nearest point to the ray at a later point on the ray, the nearest point gets divided by a bigger number, making the shadow softer. Because this doesn’t have that much to do with the nearest distance, we’ll also rename the variable to <code class="language-plaintext highlighter-rouge">shadow</code>.</p>

<p>Another small change we’ll make is that because we’re dividing by rayProgress, starting at 0 is a bad idea (dividing by zero is almost always a bad idea). Any very small number is fine as a start here.</p>

<div class="language-glsl highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">float</span> <span class="nf">traceShadows</span><span class="p">(</span><span class="n">float2</span> <span class="n">position</span><span class="p">,</span> <span class="n">float2</span> <span class="n">lightPosition</span><span class="p">,</span> <span class="kt">float</span> <span class="n">hardness</span><span class="p">){</span>
    <span class="n">float2</span> <span class="n">direction</span> <span class="o">=</span> <span class="n">normalize</span><span class="p">(</span><span class="n">lightPosition</span> <span class="o">-</span> <span class="n">position</span><span class="p">);</span>
    <span class="kt">float</span> <span class="n">lightDistance</span> <span class="o">=</span> <span class="n">length</span><span class="p">(</span><span class="n">lightPosition</span> <span class="o">-</span> <span class="n">position</span><span class="p">);</span>

    <span class="kt">float</span> <span class="n">rayProgress</span> <span class="o">=</span> <span class="mi">0</span><span class="p">.</span><span class="mo">0001</span><span class="p">;</span>
    <span class="kt">float</span> <span class="n">shadow</span> <span class="o">=</span> <span class="mi">9999</span><span class="p">;</span>
    <span class="k">for</span><span class="p">(</span><span class="kt">int</span> <span class="n">i</span><span class="o">=</span><span class="mi">0</span> <span class="p">;</span><span class="n">i</span><span class="o">&lt;</span><span class="n">SAMPLES</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">){</span>
        <span class="kt">float</span> <span class="n">sceneDist</span> <span class="o">=</span> <span class="n">scene</span><span class="p">(</span><span class="n">position</span> <span class="o">+</span> <span class="n">direction</span> <span class="o">*</span> <span class="n">rayProgress</span><span class="p">);</span>

        <span class="k">if</span><span class="p">(</span><span class="n">sceneDist</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">){</span>
            <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="k">if</span><span class="p">(</span><span class="n">rayProgress</span> <span class="o">&gt;</span> <span class="n">lightDistance</span><span class="p">){</span>
            <span class="k">return</span> <span class="n">saturate</span><span class="p">(</span><span class="n">shadow</span><span class="p">);</span>
        <span class="p">}</span>

        <span class="n">shadow</span> <span class="o">=</span> <span class="n">min</span><span class="p">(</span><span class="n">shadow</span><span class="p">,</span> <span class="n">hardness</span> <span class="o">*</span> <span class="n">sceneDist</span> <span class="o">/</span> <span class="n">rayProgress</span><span class="p">);</span>

        <span class="n">rayProgress</span> <span class="o">=</span> <span class="n">rayProgress</span> <span class="o">+</span> <span class="n">sceneDist</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>

<p><img src="/assets/images/posts/037/SoftShadows.png" alt="" /></p>

<h2 id="multiple-lights">Multiple lights</h2>

<p>In this simple one-shader implementation the easiest way to get multiple lights is to calculate them separately and then add all of the results.</p>

<div class="language-glsl highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">fixed4</span> <span class="n">frag</span><span class="p">(</span><span class="n">v2f</span> <span class="n">i</span><span class="p">)</span> <span class="o">:</span> <span class="n">SV_TARGET</span><span class="p">{</span>
    <span class="n">float2</span> <span class="n">position</span> <span class="o">=</span> <span class="n">i</span><span class="p">.</span><span class="n">worldPos</span><span class="p">.</span><span class="n">xz</span><span class="p">;</span>

    <span class="n">float2</span> <span class="n">lightPos1</span> <span class="o">=</span> <span class="n">float2</span><span class="p">(</span><span class="n">sin</span><span class="p">(</span><span class="n">_Time</span><span class="p">.</span><span class="n">y</span><span class="p">),</span> <span class="o">-</span><span class="mi">1</span><span class="p">);</span>
    <span class="kt">float</span> <span class="n">shadows1</span> <span class="o">=</span> <span class="n">traceShadows</span><span class="p">(</span><span class="n">position</span><span class="p">,</span> <span class="n">lightPos1</span><span class="p">,</span> <span class="mi">20</span><span class="p">);</span>
    <span class="n">float3</span> <span class="n">light1</span> <span class="o">=</span> <span class="n">shadows1</span> <span class="o">*</span> <span class="n">float3</span><span class="p">(.</span><span class="mi">6</span><span class="p">,</span> <span class="p">.</span><span class="mi">6</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

    <span class="n">float2</span> <span class="n">lightPos2</span> <span class="o">=</span> <span class="n">float2</span><span class="p">(</span><span class="o">-</span><span class="n">sin</span><span class="p">(</span><span class="n">_Time</span><span class="p">.</span><span class="n">y</span><span class="p">)</span> <span class="o">*</span> <span class="mi">1</span><span class="p">.</span><span class="mi">75</span><span class="p">,</span> <span class="mi">1</span><span class="p">.</span><span class="mi">75</span><span class="p">);</span>
    <span class="kt">float</span> <span class="n">shadows2</span> <span class="o">=</span> <span class="n">traceShadows</span><span class="p">(</span><span class="n">position</span><span class="p">,</span> <span class="n">lightPos2</span><span class="p">,</span> <span class="mi">10</span><span class="p">);</span>
    <span class="n">float3</span> <span class="n">light2</span> <span class="o">=</span> <span class="n">shadows2</span> <span class="o">*</span> <span class="n">float3</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="p">.</span><span class="mi">6</span><span class="p">,</span> <span class="p">.</span><span class="mi">6</span><span class="p">);</span>

    <span class="kt">float</span> <span class="n">sceneDistance</span> <span class="o">=</span> <span class="n">scene</span><span class="p">(</span><span class="n">position</span><span class="p">);</span>
    <span class="kt">float</span> <span class="n">distanceChange</span> <span class="o">=</span> <span class="n">fwidth</span><span class="p">(</span><span class="n">sceneDistance</span><span class="p">)</span> <span class="o">*</span> <span class="mi">0</span><span class="p">.</span><span class="mi">5</span><span class="p">;</span>
    <span class="kt">float</span> <span class="n">binaryScene</span> <span class="o">=</span> <span class="n">smoothstep</span><span class="p">(</span><span class="n">distanceChange</span><span class="p">,</span> <span class="o">-</span><span class="n">distanceChange</span><span class="p">,</span> <span class="n">sceneDistance</span><span class="p">);</span>
    <span class="n">float3</span> <span class="n">geometry</span> <span class="o">=</span> <span class="n">binaryScene</span> <span class="o">*</span> <span class="n">float3</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">.</span><span class="mi">3</span><span class="p">,</span> <span class="mi">0</span><span class="p">.</span><span class="mi">1</span><span class="p">);</span>

    <span class="n">float3</span> <span class="n">col</span> <span class="o">=</span> <span class="n">geometry</span> <span class="o">+</span> <span class="n">light1</span> <span class="o">+</span> <span class="n">light2</span><span class="p">;</span>

    <span class="k">return</span> <span class="n">float4</span><span class="p">(</span><span class="n">col</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div></div>

<p><img src="/assets/images/posts/037/Result.gif" alt="" /></p>

<h2 id="source">Source</h2>

<h3 id="2d-sdf-library-unchanged-but-used-here">2D SDF Library (unchanged but used here)</h3>

<ul>
  <li><a href="https://github.com/ronja-tutorials/ShaderTutorials/blob/master/Assets/037_SDF_2D_Shadows/2D_SDF.cginc">https://github.com/ronja-tutorials/ShaderTutorials/blob/master/Assets/037_SDF_2D_Shadows/2D_SDF.cginc</a></li>
</ul>

<h3 id="2d-soft-shadows">2D Soft Shadows</h3>

<ul>
  <li><a href="https://github.com/ronja-tutorials/ShaderTutorials/blob/master/Assets/037_SDF_2D_Shadows/2D_SDF_Shadows.shader">https://github.com/ronja-tutorials/ShaderTutorials/blob/master/Assets/037_SDF_2D_Shadows/2D_SDF_Shadows.shader</a></li>
</ul>

<div class="language-glsl highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">Shader</span> <span class="s">"Tutorial/037_2D_SDF_Shadows"</span><span class="p">{</span>
    <span class="n">Properties</span><span class="p">{</span>
    <span class="p">}</span>

    <span class="n">SubShader</span><span class="p">{</span>
        <span class="c1">//the material is completely non-transparent and is rendered at the same time as the other opaque geometry</span>
        <span class="n">Tags</span><span class="p">{</span> <span class="s">"RenderType"</span><span class="o">=</span><span class="s">"Opaque"</span> <span class="s">"Queue"</span><span class="o">=</span><span class="s">"Geometry"</span><span class="p">}</span>

        <span class="n">Pass</span><span class="p">{</span>
            <span class="n">CGPROGRAM</span>

            <span class="cp">#include "UnityCG.cginc"
</span>            <span class="cp">#include "2D_SDF.cginc"
</span>
            <span class="cp">#pragma vertex vert
</span>            <span class="cp">#pragma fragment frag
</span>
            <span class="k">struct</span> <span class="n">appdata</span><span class="p">{</span>
                <span class="n">float4</span> <span class="n">vertex</span> <span class="o">:</span> <span class="n">POSITION</span><span class="p">;</span>
            <span class="p">};</span>

            <span class="k">struct</span> <span class="n">v2f</span><span class="p">{</span>
                <span class="n">float4</span> <span class="n">position</span> <span class="o">:</span> <span class="n">SV_POSITION</span><span class="p">;</span>
                <span class="n">float4</span> <span class="n">worldPos</span> <span class="o">:</span> <span class="n">TEXCOORD0</span><span class="p">;</span>
            <span class="p">};</span>

            <span class="n">v2f</span> <span class="n">vert</span><span class="p">(</span><span class="n">appdata</span> <span class="n">v</span><span class="p">){</span>
                <span class="n">v2f</span> <span class="n">o</span><span class="p">;</span>
                <span class="c1">//calculate the position in clip space to render the object</span>
                <span class="n">o</span><span class="p">.</span><span class="n">position</span> <span class="o">=</span> <span class="n">UnityObjectToClipPos</span><span class="p">(</span><span class="n">v</span><span class="p">.</span><span class="n">vertex</span><span class="p">);</span>
                <span class="c1">//calculate world position of vertex</span>
                <span class="n">o</span><span class="p">.</span><span class="n">worldPos</span> <span class="o">=</span> <span class="n">mul</span><span class="p">(</span><span class="n">unity_ObjectToWorld</span><span class="p">,</span> <span class="n">v</span><span class="p">.</span><span class="n">vertex</span><span class="p">);</span>
                <span class="k">return</span> <span class="n">o</span><span class="p">;</span>
            <span class="p">}</span>

            <span class="kt">float</span> <span class="n">scene</span><span class="p">(</span><span class="n">float2</span> <span class="n">position</span><span class="p">)</span> <span class="p">{</span>
                <span class="kt">float</span> <span class="n">bounds</span> <span class="o">=</span> <span class="o">-</span><span class="n">rectangle</span><span class="p">(</span><span class="n">position</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>

                <span class="n">float2</span> <span class="n">quarterPos</span> <span class="o">=</span> <span class="n">abs</span><span class="p">(</span><span class="n">position</span><span class="p">);</span>

                <span class="kt">float</span> <span class="n">corner</span> <span class="o">=</span> <span class="n">rectangle</span><span class="p">(</span><span class="n">translate</span><span class="p">(</span><span class="n">quarterPos</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="mi">0</span><span class="p">.</span><span class="mi">5</span><span class="p">);</span>
                <span class="n">corner</span> <span class="o">=</span> <span class="n">subtract</span><span class="p">(</span><span class="n">corner</span><span class="p">,</span> <span class="n">rectangle</span><span class="p">(</span><span class="n">position</span><span class="p">,</span> <span class="mi">1</span><span class="p">.</span><span class="mi">2</span><span class="p">));</span>

                <span class="kt">float</span> <span class="n">diamond</span> <span class="o">=</span> <span class="n">rectangle</span><span class="p">(</span><span class="n">rotate</span><span class="p">(</span><span class="n">position</span><span class="p">,</span> <span class="mi">0</span><span class="p">.</span><span class="mi">125</span><span class="p">),</span> <span class="p">.</span><span class="mi">5</span><span class="p">);</span>

                <span class="kt">float</span> <span class="n">world</span> <span class="o">=</span> <span class="n">merge</span><span class="p">(</span><span class="n">bounds</span><span class="p">,</span> <span class="n">corner</span><span class="p">);</span>
                <span class="n">world</span> <span class="o">=</span> <span class="n">merge</span><span class="p">(</span><span class="n">world</span><span class="p">,</span> <span class="n">diamond</span><span class="p">);</span>

                <span class="k">return</span> <span class="n">world</span><span class="p">;</span>
            <span class="p">}</span>

            <span class="cp">#define STARTDISTANCE 0.00001
</span>            <span class="cp">#define MINSTEPDIST 0.02
</span>            <span class="cp">#define SAMPLES 32
</span>
            <span class="kt">float</span> <span class="n">traceShadows</span><span class="p">(</span><span class="n">float2</span> <span class="n">position</span><span class="p">,</span> <span class="n">float2</span> <span class="n">lightPosition</span><span class="p">,</span> <span class="kt">float</span> <span class="n">hardness</span><span class="p">){</span>
                <span class="n">float2</span> <span class="n">direction</span> <span class="o">=</span> <span class="n">normalize</span><span class="p">(</span><span class="n">lightPosition</span> <span class="o">-</span> <span class="n">position</span><span class="p">);</span>
                <span class="kt">float</span> <span class="n">lightDistance</span> <span class="o">=</span> <span class="n">length</span><span class="p">(</span><span class="n">lightPosition</span> <span class="o">-</span> <span class="n">position</span><span class="p">);</span>

                <span class="kt">float</span> <span class="n">lightSceneDistance</span> <span class="o">=</span> <span class="n">scene</span><span class="p">(</span><span class="n">lightPosition</span><span class="p">)</span> <span class="o">*</span> <span class="mi">0</span><span class="p">.</span><span class="mi">8</span><span class="p">;</span>

                <span class="kt">float</span> <span class="n">rayProgress</span> <span class="o">=</span> <span class="mi">0</span><span class="p">.</span><span class="mo">0001</span><span class="p">;</span>
                <span class="kt">float</span> <span class="n">shadow</span> <span class="o">=</span> <span class="mi">9999</span><span class="p">;</span>
                <span class="k">for</span><span class="p">(</span><span class="kt">int</span> <span class="n">i</span><span class="o">=</span><span class="mi">0</span> <span class="p">;</span><span class="n">i</span><span class="o">&lt;</span><span class="n">SAMPLES</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">){</span>
                    <span class="kt">float</span> <span class="n">sceneDist</span> <span class="o">=</span> <span class="n">scene</span><span class="p">(</span><span class="n">position</span> <span class="o">+</span> <span class="n">direction</span> <span class="o">*</span> <span class="n">rayProgress</span><span class="p">);</span>

                    <span class="k">if</span><span class="p">(</span><span class="n">sceneDist</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">){</span>
                        <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
                    <span class="p">}</span>
                    <span class="k">if</span><span class="p">(</span><span class="n">rayProgress</span> <span class="o">&gt;</span> <span class="n">lightDistance</span><span class="p">){</span>
                        <span class="k">return</span> <span class="n">saturate</span><span class="p">(</span><span class="n">shadow</span><span class="p">);</span>
                    <span class="p">}</span>

                    <span class="n">shadow</span> <span class="o">=</span> <span class="n">min</span><span class="p">(</span><span class="n">shadow</span><span class="p">,</span> <span class="n">hardness</span> <span class="o">*</span> <span class="n">sceneDist</span> <span class="o">/</span> <span class="n">rayProgress</span><span class="p">);</span>
                    <span class="n">rayProgress</span> <span class="o">=</span> <span class="n">rayProgress</span> <span class="o">+</span> <span class="n">max</span><span class="p">(</span><span class="n">sceneDist</span><span class="p">,</span> <span class="mi">0</span><span class="p">.</span><span class="mo">02</span><span class="p">);</span>
                <span class="p">}</span>

                <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
            <span class="p">}</span>

            <span class="n">fixed4</span> <span class="n">frag</span><span class="p">(</span><span class="n">v2f</span> <span class="n">i</span><span class="p">)</span> <span class="o">:</span> <span class="n">SV_TARGET</span><span class="p">{</span>
                <span class="n">float2</span> <span class="n">position</span> <span class="o">=</span> <span class="n">i</span><span class="p">.</span><span class="n">worldPos</span><span class="p">.</span><span class="n">xz</span><span class="p">;</span>

                <span class="n">float2</span> <span class="n">lightPos1</span> <span class="o">=</span> <span class="n">float2</span><span class="p">(</span><span class="n">sin</span><span class="p">(</span><span class="n">_Time</span><span class="p">.</span><span class="n">y</span><span class="p">),</span> <span class="o">-</span><span class="mi">1</span><span class="p">);</span>
                <span class="kt">float</span> <span class="n">shadows1</span> <span class="o">=</span> <span class="n">traceShadows</span><span class="p">(</span><span class="n">position</span><span class="p">,</span> <span class="n">lightPos1</span><span class="p">,</span> <span class="mi">20</span><span class="p">);</span>
                <span class="n">float3</span> <span class="n">light1</span> <span class="o">=</span> <span class="n">shadows1</span> <span class="o">*</span> <span class="n">float3</span><span class="p">(.</span><span class="mi">6</span><span class="p">,</span> <span class="p">.</span><span class="mi">6</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

                <span class="n">float2</span> <span class="n">lightPos2</span> <span class="o">=</span> <span class="n">float2</span><span class="p">(</span><span class="o">-</span><span class="n">sin</span><span class="p">(</span><span class="n">_Time</span><span class="p">.</span><span class="n">y</span><span class="p">)</span> <span class="o">*</span> <span class="mi">1</span><span class="p">.</span><span class="mi">75</span><span class="p">,</span> <span class="mi">1</span><span class="p">.</span><span class="mi">75</span><span class="p">);</span>
                <span class="kt">float</span> <span class="n">shadows2</span> <span class="o">=</span> <span class="n">traceShadows</span><span class="p">(</span><span class="n">position</span><span class="p">,</span> <span class="n">lightPos2</span><span class="p">,</span> <span class="mi">10</span><span class="p">);</span>
                <span class="n">float3</span> <span class="n">light2</span> <span class="o">=</span> <span class="n">shadows2</span> <span class="o">*</span> <span class="n">float3</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="p">.</span><span class="mi">6</span><span class="p">,</span> <span class="p">.</span><span class="mi">6</span><span class="p">);</span>

                <span class="kt">float</span> <span class="n">sceneDistance</span> <span class="o">=</span> <span class="n">scene</span><span class="p">(</span><span class="n">position</span><span class="p">);</span>
                <span class="kt">float</span> <span class="n">distanceChange</span> <span class="o">=</span> <span class="n">fwidth</span><span class="p">(</span><span class="n">sceneDistance</span><span class="p">)</span> <span class="o">*</span> <span class="mi">0</span><span class="p">.</span><span class="mi">5</span><span class="p">;</span>
                <span class="kt">float</span> <span class="n">binaryScene</span> <span class="o">=</span> <span class="n">smoothstep</span><span class="p">(</span><span class="n">distanceChange</span><span class="p">,</span> <span class="o">-</span><span class="n">distanceChange</span><span class="p">,</span> <span class="n">sceneDistance</span><span class="p">);</span>
                <span class="n">float3</span> <span class="n">geometry</span> <span class="o">=</span> <span class="n">binaryScene</span> <span class="o">*</span> <span class="n">float3</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">.</span><span class="mi">3</span><span class="p">,</span> <span class="mi">0</span><span class="p">.</span><span class="mi">1</span><span class="p">);</span>

                <span class="n">float3</span> <span class="n">col</span> <span class="o">=</span> <span class="n">geometry</span> <span class="o">+</span> <span class="n">light1</span> <span class="o">+</span> <span class="n">light2</span><span class="p">;</span>

                <span class="k">return</span> <span class="n">float4</span><span class="p">(</span><span class="n">col</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
            <span class="p">}</span>

            <span class="n">ENDCG</span>
        <span class="p">}</span>
    <span class="p">}</span>
    <span class="n">FallBack</span> <span class="s">"Standard"</span>
<span class="p">}</span>
</code></pre></div></div>

<p>This is only one of many uses of signed distance fields. So far they’re a bit unweildy because all shapes have to be hardcoded into a shader or passed via shader properties, but I have a few ideas on how to make them more usable with future tutorials.</p>


    <p>
        You can also find me on twitter at <a href="https://www.twitter.com/totallyRonja">@totallyRonja</a>. If you liked my tutorial and want to support me you can do that on Patreon (<a href="https://www.patreon.com/RonjaTutorials">patreon.com/RonjaTutorials</a>) or Ko-Fi (<a href="https://ko-fi.com/RonjaTutorials">ko-fi.com/RonjaTutorials</a>).
    </p>
  </div>

  
    <div id="disqus_thread"></div>
<script>

/**
*  RECOMMENDED CONFIGURATION VARIABLES: EDIT AND UNCOMMENT THE SECTION BELOW TO INSERT DYNAMIC VALUES FROM YOUR PLATFORM OR CMS.
*  LEARN WHY DEFINING THESE VARIABLES IS IMPORTANT: https://disqus.com/admin/universalcode/#configuration-variables*/
/*
var disqus_config = function () {
this.page.url = PAGE_URL;  // Replace PAGE_URL with your page's canonical URL variable
this.page.identifier = PAGE_IDENTIFIER; // Replace PAGE_IDENTIFIER with your page's unique identifier variable
};
*/
(function() { // DON'T EDIT BELOW THIS LINE
var d = document, s = d.createElement('script');
s.src = 'https://ronja-tutorials.disqus.com/embed.js';
s.setAttribute('data-timestamp', +new Date());
(d.head || d.body).appendChild(s);
})();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
                            
  
</article>


      <!-- SVG icons from https://iconmonstr.com -->

      <!-- Twitter icon -->
      <span class="my-span-icon">
          <a href="https://twitter.com/TotallyRonja" aria-label="'s Twitter" title="'s Twitter">
            <svg class="my-svg-icon" xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24" style="margin-top: 12px;margin-left: 13px;"><path d="M12 0c-6.627 0-12 5.373-12 12s5.373 12 12 12 12-5.373 12-12-5.373-12-12-12zm6.066 9.645c.183 4.04-2.83 8.544-8.164 8.544-1.622 0-3.131-.476-4.402-1.291 1.524.18 3.045-.244 4.252-1.189-1.256-.023-2.317-.854-2.684-1.995.451.086.895.061 1.298-.049-1.381-.278-2.335-1.522-2.304-2.853.388.215.83.344 1.301.359-1.279-.855-1.641-2.544-.889-3.835 1.416 1.738 3.533 2.881 5.92 3.001-.419-1.796.944-3.527 2.799-3.527.825 0 1.572.349 2.096.907.654-.128 1.27-.368 1.824-.697-.215.671-.67 1.233-1.263 1.589.581-.07 1.135-.224 1.649-.453-.384.578-.87 1.084-1.433 1.489z"/></svg>
          </a>
        </span>

        <!-- RSS icon -->
        
          <span class="my-span-icon">
            <a href="/feed.xml" aria-label="RSS feed" title="'s RSS feed">
              <svg class="my-svg-icon" xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24"><path d="M12 0c-6.627 0-12 5.373-12 12s5.373 12 12 12 12-5.373 12-12-5.373-12-12-12zm-3.374 17c-.897 0-1.626-.727-1.626-1.624s.729-1.624 1.626-1.624 1.626.727 1.626 1.624-.729 1.624-1.626 1.624zm3.885 0c-.03-3.022-2.485-5.474-5.511-5.504v-2.406c4.361.03 7.889 3.555 7.92 7.91h-2.409zm4.081 0c-.016-5.297-4.303-9.571-9.592-9.594v-2.406c6.623.023 11.985 5.384 12 12h-2.408z"/></svg>
            </a>
          </span>
        
        <!-- Contact icon -->
        
        
          <span class="my-span-icon">
            <a href="/about.html" aria-label="Contact" title="Contact ">
              <svg class="my-svg-icon" xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24"><path d="M12 .02c-6.627 0-12 5.373-12 12s5.373 12 12 12 12-5.373 12-12-5.373-12-12-12zm6.99 6.98l-6.99 5.666-6.991-5.666h13.981zm.01 10h-14v-8.505l7 5.673 7-5.672v8.504z"/></svg>
            </a>
          </span>
        
    </section>

    
      <script type="text/javascript">
        (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
        (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
        m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
        })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

        ga('create', 'UA-124040112-1', 'auto');
        ga('send', 'pageview');
      </script>
    
  </body>
</html>
