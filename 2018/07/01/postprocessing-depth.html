<!DOCTYPE html>
<html lang="en">

  <head>

    <!-- Non social metatags -->
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <meta name="theme-color" content="#157878">

    

    <title>Postprocessing with the Depth Texture</title>

    
      <!-- Update your html tag to include the itemscope and itemtype attributes. -->
<html itemscope itemtype="http://schema.org/Article">












<!-- Place this data between the <head> tags of your website -->

  <meta name="author" content="Ronja Böhringer">

<meta name="description" content="Summary" />





<!-- Schema.org markup for Google+ -->
<meta itemprop="name" content="Postprocessing with the Depth Texture">
<meta itemprop="description" content="Summary">

  <meta itemprop="image" content="https://www.ronja-tutorials.com/assets/images/posts/017/Result.gif">


<!-- Twitter Card data -->
<meta name="twitter:card" content="summary_large_image">



<meta name="twitter:title" content="Postprocessing with the Depth Texture">
<meta name="twitter:description" content="Summary">


  <meta name="twitter:creator" content="@TotallyRonja">


<!-- Twitter summary card with large image must be at least 280x150px -->

  <meta name="twitter:image:src" content="https://www.ronja-tutorials.com/assets/images/posts/017/Result.gif">
  <meta property="twitter:image" content="https://www.ronja-tutorials.com/assets/images/posts/017/Result.gif">

<meta property="twitter:url" content="https://www.ronja-tutorials.com/2018/07/01/postprocessing-depth.html">

<!-- Open Graph data -->
<meta property="og:title" content="Postprocessing with the Depth Texture" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://www.ronja-tutorials.com/2018/07/01/postprocessing-depth.html" />

  <meta property="og:image" content="https://www.ronja-tutorials.com/assets/images/posts/017/Result.gif" />

<meta property="og:description" content="Summary" />
<meta property="og:site_name" content="Ronja's Shader Tutorials" />

  <meta property="article:published_time" content="2018-07-01T00:00:00+02:00" />














  





  




    

    <link rel="canonical" href="https://www.ronja-tutorials.com/2018/07/01/postprocessing-depth.html">

    

    <!-- <link rel="shortcut icon" href="https://www.ronja-tutorials.com/favicon.ico"> -->
    <meta name="robots" content="noarchive">

    <!-- <link rel="alternate" media="only screen and (max-width: 640px)" href="">
    <link rel="alternate" media="handheld" href=""> -->


    <link href='https://fonts.googleapis.com/css?family=Open+Sans:400,700' rel='stylesheet' type='text/css'>
    <script async defer data-website-id="fb34d410-ef67-4a3a-8fdc-01a05f5e22b2" src="https://stats.ruby0x1.ca/umami.js" ></script>
    <link rel="stylesheet" href="/assets/css/style.css?v=">
  </head>
  <body>

    <header class="site-header" role="banner">

  <div class="wrapper">
    
    

    
      <a class="site-title" href="/">Ronja&#39;s Shader Tutorials</a>
    
    <!-- SVG icons from https://iconmonstr.com -->

    <!-- Twitter icon -->
    <span class="my-span-icon">
        <a href="https://twitter.com/TotallyRonja" aria-label="'s Twitter" title="'s Twitter">
          <svg class="my-svg-icon" xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24" style="margin-top: 12px;margin-left: 13px;"><path d="M12 0c-6.627 0-12 5.373-12 12s5.373 12 12 12 12-5.373 12-12-5.373-12-12-12zm6.066 9.645c.183 4.04-2.83 8.544-8.164 8.544-1.622 0-3.131-.476-4.402-1.291 1.524.18 3.045-.244 4.252-1.189-1.256-.023-2.317-.854-2.684-1.995.451.086.895.061 1.298-.049-1.381-.278-2.335-1.522-2.304-2.853.388.215.83.344 1.301.359-1.279-.855-1.641-2.544-.889-3.835 1.416 1.738 3.533 2.881 5.92 3.001-.419-1.796.944-3.527 2.799-3.527.825 0 1.572.349 2.096.907.654-.128 1.27-.368 1.824-.697-.215.671-.67 1.233-1.263 1.589.581-.07 1.135-.224 1.649-.453-.384.578-.87 1.084-1.433 1.489z"/></svg>
        </a>
      </span>

      <!-- RSS icon -->
      
        <span class="my-span-icon">
          <a href="/feed.xml" aria-label="RSS feed" title="'s RSS feed">
            <svg class="my-svg-icon" xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24"><path d="M12 0c-6.627 0-12 5.373-12 12s5.373 12 12 12 12-5.373 12-12-5.373-12-12-12zm-3.374 17c-.897 0-1.626-.727-1.626-1.624s.729-1.624 1.626-1.624 1.626.727 1.626 1.624-.729 1.624-1.626 1.624zm3.885 0c-.03-3.022-2.485-5.474-5.511-5.504v-2.406c4.361.03 7.889 3.555 7.92 7.91h-2.409zm4.081 0c-.016-5.297-4.303-9.571-9.592-9.594v-2.406c6.623.023 11.985 5.384 12 12h-2.408z"/></svg>
          </a>
        </span>
      
      <!-- Contact icon -->
      
      
        <span class="my-span-icon">
          <a href="/about.html" aria-label="Contact" title="Contact ">
            <svg class="my-svg-icon" xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24"><path d="M12 .02c-6.627 0-12 5.373-12 12s5.373 12 12 12 12-5.373 12-12-5.373-12-12-12zm6.99 6.98l-6.99 5.666-6.991-5.666h13.981zm.01 10h-14v-8.505l7 5.673 7-5.672v8.504z"/></svg>
          </a>
        </span>
      

    
      <nav class="site-nav">
        <input type="checkbox" id="nav-trigger" class="nav-trigger" />
        <label for="nav-trigger">
          <span class="menu-icon">
            <svg viewBox="0 0 18 15" width="18px" height="15px">
              <path fill="#424242" d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.031C17.335,0,18,0.665,18,1.484L18,1.484z"/>
              <path fill="#424242" d="M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0c0-0.82,0.665-1.484,1.484-1.484 h15.031C17.335,6.031,18,6.696,18,7.516L18,7.516z"/>
              <path fill="#424242" d="M18,13.516C18,14.335,17.335,15,16.516,15H1.484C0.665,15,0,14.335,0,13.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.031C17.335,12.031,18,12.696,18,13.516L18,13.516z"/>
            </svg>
          </span>
        </label>

        <div class="trigger">
          
            
            
              
              
            
          
            
            
          
            
            
              
                <a class="page-link" href="/about.html">About</a>
              
            
          
            
            
          
            
            
          
            
            
          
            
            
          
            
            
              
                <a class="page-link" href="/2018/03/20/hlsl-basics.html"></a>
              
            
          
            
            
              
                <a class="page-link" href="/2018/03/20/hlsl-basics.html"></a>
              
            
          
            
            
              
                <a class="page-link" href="/2018/03/20/hlsl-basics.html"></a>
              
            
          
            
            
              
                <a class="page-link" href="/2018/03/20/hlsl-basics.html"></a>
              
            
          
            
            
          
            
            
          
        </div>
      </nav>
    
  </div>
</header>


    
    
    

    <section class="page-header">
      <h1 class="project-name">Postprocessing with the Depth Texture</h1>
      <h2 class="project-tagline"></h2>
      
      <!-- Post tagline -->
      
        <h2 class="project-date">
        <time datetime="2018-07-01T00:00:00+02:00" itemprop="datePublished">
          
          Jul 1, 2018
        </time>
        
        
          • <span itemprop="author" itemscope itemtype="http://schema.org/Person"><span itemprop="name">Ronja Böhringer</span></span>
        
        </h2>
      
      <!-- End: Post tagline -->
    </section>

    <section class="main-content">

      <article itemscope itemtype="http://schema.org/BlogPosting">

  <!-- <header class="post-header">
    <h1 class="post-title" itemprop="name headline">Postprocessing with the Depth Texture</h1>
    <p class="post-meta">
      <time datetime="2018-07-01T00:00:00+02:00" itemprop="datePublished">
        
        Jul 1, 2018
      </time>
      </p>
  </header> -->

  
<ul>
  <li><a href="#summary">Summary</a></li>
  <li><a href="#read-depth">Read Depth</a></li>
  <li><a href="#generate-wave">Generate Wave</a></li>
</ul>

  <div itemprop="articleBody">
    <h2 id="summary">Summary</h2>

<p>In the last tutorial I explained how to do very simple postprocessing effects. One important tool to do more advanced effects is access to the depth buffer. It’s a texture in which the distance of pixels from the camera is saved in.</p>

<p>To understand how postprocessing effects with access to the depth buffer work it’s best to understand how postprocessing works in general in unity. I have a tutorial on that <a href="/2018/06/23/postprocessing-basics.html">here</a>.</p>

<p><img src="/assets/images/posts/017/Result.gif" alt="Result" /></p>

<h2 id="read-depth">Read Depth</h2>

<p>We will start this with the files we made in the simple postprocessing tutorial and go from there.</p>

<p>The first thing we expand is the C# script which inserts our material into the rendering pipeline. We will expand it so when it starts up it will look for the camera on the same gameobject as itself and tell it to generate a depth buffer for us to use. This is done via the depthtexture mode flags. We could just set it to render the depth buffer, but what we’re going to do is take the existing value and take a bit-or with the flag we want to set, this way we don’t overwrite the flags other scripts might set to render their own effects. (you can read up on bitmasks if you’re curious how that works)</p>

<div class="language-cs highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">private</span> <span class="k">void</span> <span class="nf">Start</span><span class="p">(){</span>
    <span class="n">Camera</span> <span class="n">cam</span> <span class="p">=</span> <span class="n">GetComponent</span><span class="p">&lt;</span><span class="n">Camera</span><span class="p">&gt;();</span>
    <span class="n">cam</span><span class="p">.</span><span class="n">depthTextureMode</span> <span class="p">=</span> <span class="n">cam</span><span class="p">.</span><span class="n">depthTextureMode</span> <span class="p">|</span> <span class="n">DepthTextureMode</span><span class="p">.</span><span class="n">Depth</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>

<p>That’s already everything we have to change on the C# side to get access to the depth texture, so we can now start writing our shader.</p>

<p>We get access to the depth texture by creating a new texture sampler which we call _CameraDepthTexture. We can read from the sampler like any other texture, so we can just do that and look at how the depth texture looks like. Because the depth is just a single value, it’s only saved in the red value of the texture and the other color channels are empty so we just take the red value.</p>

<div class="language-glsl highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">//the depth texture</span>
<span class="kt">sampler2D</span> <span class="n">_CameraDepthTexture</span><span class="p">;</span>
</code></pre></div></div>

<div class="language-glsl highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">//the fragment shader</span>
<span class="n">fixed4</span> <span class="n">frag</span><span class="p">(</span><span class="n">v2f</span> <span class="n">i</span><span class="p">)</span> <span class="o">:</span> <span class="n">SV_TARGET</span><span class="p">{</span>
    <span class="c1">//get depth from depth texture</span>
    <span class="kt">float</span> <span class="n">depth</span> <span class="o">=</span> <span class="n">tex2D</span><span class="p">(</span><span class="n">_CameraDepthTexture</span><span class="p">,</span> <span class="n">i</span><span class="p">.</span><span class="n">uv</span><span class="p">).</span><span class="n">r</span><span class="p">;</span>

    <span class="k">return</span> <span class="n">depth</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>

<p>After doing this and starting the game, chances are high that the game looks mostly black. That’s because the depth isn’t encoded linearly, the distances closer to the camera are more precise than the ones further away because that’s where more precision is needed. If we put the camera very close to objects we should still be able to see some brighter color, indicating that the object is close to the camera. (if you still see black/mostly black when putting the camera close to objects and would like to, try increasing your near clipping distance)</p>

<p><img src="/assets/images/posts/017/Short.png" alt="a image where close objects are bright and then quickly fall off to black as theyre further away" /></p>

<p>To make this more usable for ourselves we have to decode the depth. Luckily unity provides a method for us that takes the depth as we have it now and returns the linear depth between 0 and 1, 0 being in the camera and 1 being at the far clipping plane. (if your image is mostly black with a white skybox here, you can try to lower the far clipping plane of your camera to see more shades)</p>

<div class="language-glsl highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">//the fragment shader</span>
<span class="n">fixed4</span> <span class="n">frag</span><span class="p">(</span><span class="n">v2f</span> <span class="n">i</span><span class="p">)</span> <span class="o">:</span> <span class="n">SV_TARGET</span><span class="p">{</span>
    <span class="c1">//get depth from depth texture</span>
    <span class="kt">float</span> <span class="n">depth</span> <span class="o">=</span> <span class="n">tex2D</span><span class="p">(</span><span class="n">_CameraDepthTexture</span><span class="p">,</span> <span class="n">i</span><span class="p">.</span><span class="n">uv</span><span class="p">).</span><span class="n">r</span><span class="p">;</span>
    <span class="c1">//linear depth between camera and far clipping plane</span>
    <span class="n">depth</span> <span class="o">=</span> <span class="n">Linear01Depth</span><span class="p">(</span><span class="n">depth</span><span class="p">);</span>

    <span class="k">return</span> <span class="n">depth</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>

<p><img src="/assets/images/posts/017/LinearDepth.png" alt="a image where close objects are bright and then fall off to black as theyre further away" /></p>

<p>The next step is to completely decouple the depth we have from the camera settings so we can change them again without changing the results of our effects. We archieve that by simply multiplying the linear depth we have now with the distance of the far clipping plane. The near and far clipping planes are provided to us by unity via the projectionparams variable, the far clipping plane is in the z component.</p>

<div class="language-glsl highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">//the fragment shader</span>
<span class="n">fixed4</span> <span class="n">frag</span><span class="p">(</span><span class="n">v2f</span> <span class="n">i</span><span class="p">)</span> <span class="o">:</span> <span class="n">SV_TARGET</span><span class="p">{</span>
    <span class="c1">//get depth from depth texture</span>
    <span class="kt">float</span> <span class="n">depth</span> <span class="o">=</span> <span class="n">tex2D</span><span class="p">(</span><span class="n">_CameraDepthTexture</span><span class="p">,</span> <span class="n">i</span><span class="p">.</span><span class="n">uv</span><span class="p">).</span><span class="n">r</span><span class="p">;</span>
    <span class="c1">//linear depth between camera and far clipping plane</span>
    <span class="n">depth</span> <span class="o">=</span> <span class="n">Linear01Depth</span><span class="p">(</span><span class="n">depth</span><span class="p">);</span>
    <span class="c1">//depth as distance from camera in units</span>
    <span class="n">depth</span> <span class="o">=</span> <span class="n">depth</span> <span class="o">*</span> <span class="n">_ProjectionParams</span><span class="p">.</span><span class="n">z</span><span class="p">;</span>

    <span class="k">return</span> <span class="n">depth</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>

<p><img src="/assets/images/posts/017/CorrectDepth.png" alt="a image where close objects are dark and then quickly fall off to white as theyre further away, most of the image is plain white" /></p>

<p>Because most objects are further away than 1 unit from the camera, the image will be primarily white again, but we now have a value we can use that’s independent of the clipping planes of the camera and in a unit of measurement we can understand (unity units).</p>

<h2 id="generate-wave">Generate Wave</h2>

<p>Next I’m going to show you how to use this information to make a wave effect that seemingly wanders through the world, away from the player. We will be able to customize the distance from the player the wave has at the moment, the length of the trail of the wave, and the color of the wave. So the first step we take is to add those variables to the properties and as variables to our shader. We use the header attribute here to write wave in bold letters over the part with variables for the wave in the inspector, it doesn’t change the functionality of the shader at all.</p>

<div class="language-glsl highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">//show values to edit in inspector</span>
<span class="n">Properties</span><span class="p">{</span>
    <span class="p">[</span><span class="n">HideInInspector</span><span class="p">]</span><span class="n">_MainTex</span> <span class="p">(</span><span class="s">"Texture"</span><span class="p">,</span> <span class="mi">2</span><span class="n">D</span><span class="p">)</span> <span class="o">=</span> <span class="s">"white"</span> <span class="p">{}</span>
    <span class="p">[</span><span class="n">Header</span><span class="p">(</span><span class="n">Wave</span><span class="p">)]</span>
    <span class="n">_WaveDistance</span> <span class="p">(</span><span class="s">"Distance from player"</span><span class="p">,</span> <span class="kt">float</span><span class="p">)</span> <span class="o">=</span> <span class="mi">10</span>
    <span class="n">_WaveTrail</span> <span class="p">(</span><span class="s">"Length of the trail"</span><span class="p">,</span> <span class="n">Range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">5</span><span class="p">))</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="n">_WaveColor</span> <span class="p">(</span><span class="s">"Color"</span><span class="p">,</span> <span class="n">Color</span><span class="p">)</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
<span class="p">}</span>
</code></pre></div></div>

<div class="language-glsl highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">//variables to control the wave</span>
<span class="kt">float</span> <span class="n">_WaveDistance</span><span class="p">;</span>
<span class="kt">float</span> <span class="n">_WaveTrail</span><span class="p">;</span>
<span class="n">float4</span> <span class="n">_WaveColor</span><span class="p">;</span>
</code></pre></div></div>

<p><img src="/assets/images/posts/017/Inspector.png" alt="a image of the inspector with the variables" /></p>

<p>The wave example will have a hard cut at it’s front end and a smooth tail behind that. We start by making a hard cut based on the distance. For this we use the step function which returns 0 if the second value is greater or 1 otherwise.</p>

<div class="language-glsl highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    <span class="c1">//calculate wave</span>
    <span class="kt">float</span> <span class="n">waveFront</span> <span class="o">=</span> <span class="n">step</span><span class="p">(</span><span class="n">depth</span><span class="p">,</span> <span class="n">_WaveDistance</span><span class="p">);</span>

    <span class="k">return</span> <span class="n">waveFront</span><span class="p">;</span>
<span class="err">}</span>
</code></pre></div></div>

<p><img src="/assets/images/posts/017/Cutoff.gif" alt="a line at a specific depth that falls off" /></p>

<p>Then to define the trail we use a smoothstep function which is similar to the step function, except we can define two values to compare the third value to, if the third value is less than the first, the function returns 0, if it’s bigger than the second it returns 1, other values return values between 0 and 1. I like to imagine it like a inverse linear interpolation because you can take the result of the smoothstep and put it into a lerp with the same minimum and maximum values as the smoothstep to get the value of teh third argument.</p>

<p>In this case the value we want to compare to is the depth, our maximum is the wave distance and the minimum is the wave distance minus the trail length.</p>

<div class="language-glsl highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    <span class="kt">float</span> <span class="n">waveTrail</span> <span class="o">=</span> <span class="n">smoothstep</span><span class="p">(</span><span class="n">_WaveDistance</span> <span class="o">-</span> <span class="n">_WaveTrail</span><span class="p">,</span> <span class="n">_WaveDistance</span><span class="p">,</span> <span class="n">depth</span><span class="p">);</span>
    <span class="k">return</span> <span class="n">waveTrail</span><span class="p">;</span>
<span class="err">}</span>
</code></pre></div></div>

<p><img src="/assets/images/posts/017/Trail.gif" alt="a smooth line at a specific depth that falls off" /></p>

<p>You might notive that the front and the trail of the wave are opposite, it would be easy to fix that (flip the two arguments of the clip or flip the min orthe max of the smoothstep), but in this case it’s on purpose. Because if we multiply any number by zero it becomes zero, we can now multiply the front and the trail of the wave and it will become zero in front and behind the wave with only a small white wave in the middle at our defined distance.</p>

<div class="language-glsl highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">//calculate wave</span>
    <span class="kt">float</span> <span class="n">waveFront</span> <span class="o">=</span> <span class="n">step</span><span class="p">(</span><span class="n">depth</span><span class="p">,</span> <span class="n">_WaveDistance</span><span class="p">);</span>
    <span class="kt">float</span> <span class="n">waveTrail</span> <span class="o">=</span> <span class="n">smoothstep</span><span class="p">(</span><span class="n">_WaveDistance</span> <span class="o">-</span> <span class="n">_WaveTrail</span><span class="p">,</span> <span class="n">_WaveDistance</span><span class="p">,</span> <span class="n">depth</span><span class="p">);</span>
    <span class="kt">float</span> <span class="n">wave</span> <span class="o">=</span> <span class="n">waveFront</span> <span class="o">*</span> <span class="n">waveTrail</span><span class="p">;</span>

    <span class="k">return</span> <span class="n">wave</span><span class="p">;</span>
<span class="err">}</span>
</code></pre></div></div>

<p><img src="/assets/images/posts/017/WhiteWave.gif" alt="a line at a specific depth that falls off" /></p>

<p>Now that we have defined our wave, we can bring back color to the image. For that we first have to sample our source image again and then we do a linear interpolation from the source image to our wave color based on the wave parameter we just calculated.</p>

<div class="language-glsl highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">//mix wave into source color</span>
<span class="n">fixed4</span> <span class="n">col</span> <span class="o">=</span> <span class="n">lerp</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="n">_WaveColor</span><span class="p">,</span> <span class="n">wave</span><span class="p">);</span>

<span class="k">return</span> <span class="n">col</span><span class="p">;</span>
</code></pre></div></div>

<p><img src="/assets/images/posts/017/HitSky.gif" alt="a line at a specific depth that falls off" /></p>

<p>As you can see we have a artefact with this approach when the distance reaches the far clipping plane. Even though the skybox is technically at the distance of the far clipping plane, we don’t want to show the wave when it reaches it.</p>

<p>To fix this we read the source color just after we calculate the depth and return it instantly if the depth is at the far clipping plane.</p>

<div class="language-glsl highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">//the fragment shader</span>
<span class="n">fixed4</span> <span class="n">frag</span><span class="p">(</span><span class="n">v2f</span> <span class="n">i</span><span class="p">)</span> <span class="o">:</span> <span class="n">SV_TARGET</span><span class="p">{</span>
    <span class="c1">//get depth from depth texture</span>
    <span class="kt">float</span> <span class="n">depth</span> <span class="o">=</span> <span class="n">tex2D</span><span class="p">(</span><span class="n">_CameraDepthTexture</span><span class="p">,</span> <span class="n">i</span><span class="p">.</span><span class="n">uv</span><span class="p">).</span><span class="n">r</span><span class="p">;</span>
    <span class="c1">//linear depth between camera and far clipping plane</span>
    <span class="n">depth</span> <span class="o">=</span> <span class="n">Linear01Depth</span><span class="p">(</span><span class="n">depth</span><span class="p">);</span>
    <span class="c1">//depth as distance from camera in units</span>
    <span class="n">depth</span> <span class="o">=</span> <span class="n">depth</span> <span class="o">*</span> <span class="n">_ProjectionParams</span><span class="p">.</span><span class="n">z</span><span class="p">;</span>

    <span class="c1">//get source color</span>
    <span class="n">fixed4</span> <span class="n">source</span> <span class="o">=</span> <span class="n">tex2D</span><span class="p">(</span><span class="n">_MainTex</span><span class="p">,</span> <span class="n">i</span><span class="p">.</span><span class="n">uv</span><span class="p">);</span>
    <span class="c1">//skip wave and return source color if we're at the skybox</span>
    <span class="k">if</span><span class="p">(</span><span class="n">depth</span> <span class="o">&gt;=</span> <span class="n">_ProjectionParams</span><span class="p">.</span><span class="n">z</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">source</span><span class="p">;</span>

    <span class="c1">//calculate wave</span>
    <span class="kt">float</span> <span class="n">waveFront</span> <span class="o">=</span> <span class="n">step</span><span class="p">(</span><span class="n">depth</span><span class="p">,</span> <span class="n">_WaveDistance</span><span class="p">);</span>
    <span class="kt">float</span> <span class="n">waveTrail</span> <span class="o">=</span> <span class="n">smoothstep</span><span class="p">(</span><span class="n">_WaveDistance</span> <span class="o">-</span> <span class="n">_WaveTrail</span><span class="p">,</span> <span class="n">_WaveDistance</span><span class="p">,</span> <span class="n">depth</span><span class="p">);</span>
    <span class="kt">float</span> <span class="n">wave</span> <span class="o">=</span> <span class="n">waveFront</span> <span class="o">*</span> <span class="n">waveTrail</span><span class="p">;</span>

    <span class="c1">//mix wave into source color</span>
    <span class="n">fixed4</span> <span class="n">col</span> <span class="o">=</span> <span class="n">lerp</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="n">_WaveColor</span><span class="p">,</span> <span class="n">wave</span><span class="p">);</span>

    <span class="k">return</span> <span class="n">col</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>

<p>One last thing I’d like to do is expand the C# script to automatically set the distance for us and make it slowly go away from the player. I’d like to control the speed the wave travels and if the wave is active. Also we have to remember the current distance of the wave. For all of that we add a few new class variables to our script.</p>

<div class="language-cs highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">[</span><span class="n">SerializeField</span><span class="p">]</span>
<span class="k">private</span> <span class="n">Material</span> <span class="n">postprocessMaterial</span><span class="p">;</span>
<span class="p">[</span><span class="n">SerializeField</span><span class="p">]</span>
<span class="k">private</span> <span class="kt">float</span> <span class="n">waveSpeed</span><span class="p">;</span>
<span class="p">[</span><span class="n">SerializeField</span><span class="p">]</span>
<span class="k">private</span> <span class="kt">bool</span> <span class="n">waveActive</span><span class="p">;</span>
</code></pre></div></div>

<p>Then we add the update method which is called by unity automatically every frame. In it we increase the distance of the wave if it’S active and set it to zero when it isn’t, this way the wave is reset and comes from the player every time we enable it again.</p>

<div class="language-cs highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">private</span> <span class="k">void</span> <span class="nf">Update</span><span class="p">(){</span>
    <span class="c1">//if the wave is active, make it move away, otherwise reset it</span>
    <span class="k">if</span><span class="p">(</span><span class="n">waveActive</span><span class="p">){</span>
        <span class="n">waveDistance</span> <span class="p">=</span> <span class="n">waveDistance</span> <span class="p">+</span> <span class="n">waveSpeed</span> <span class="p">*</span> <span class="n">Time</span><span class="p">.</span><span class="n">deltaTime</span><span class="p">;</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="n">waveDistance</span> <span class="p">=</span> <span class="m">0</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>And then to use the wavedistance variable in our shader we set it. We do the setting in the OnRenderImage just before the method is used, that way we can make sure that when it’s used it’s set to the correct value.</p>

<div class="language-cs highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">//method which is automatically called by unity after the camera is done rendering</span>
<span class="k">private</span> <span class="k">void</span> <span class="nf">OnRenderImage</span><span class="p">(</span><span class="n">RenderTexture</span> <span class="n">source</span><span class="p">,</span> <span class="n">RenderTexture</span> <span class="n">destination</span><span class="p">){</span>
    <span class="c1">//sync the distance from the script to the shader</span>
    <span class="n">postprocessMaterial</span><span class="p">.</span><span class="nf">SetFloat</span><span class="p">(</span><span class="s">"_WaveDistance"</span><span class="p">,</span> <span class="n">waveDistance</span><span class="p">);</span>
    <span class="c1">//draws the pixels from the source texture to the destination texture</span>
    <span class="n">Graphics</span><span class="p">.</span><span class="nf">Blit</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="n">destination</span><span class="p">,</span> <span class="n">postprocessMaterial</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div></div>

<p><img src="/assets/images/posts/017/AutoWave.gif" alt="a wave travelling automatically while a bool is true" /></p>

<div class="language-glsl highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">Shader</span> <span class="s">"Tutorial/017_Depth_Postprocessing"</span><span class="p">{</span>
    <span class="c1">//show values to edit in inspector</span>
    <span class="n">Properties</span><span class="p">{</span>
        <span class="p">[</span><span class="n">HideInInspector</span><span class="p">]</span><span class="n">_MainTex</span> <span class="p">(</span><span class="s">"Texture"</span><span class="p">,</span> <span class="mi">2</span><span class="n">D</span><span class="p">)</span> <span class="o">=</span> <span class="s">"white"</span> <span class="p">{}</span>
        <span class="p">[</span><span class="n">Header</span><span class="p">(</span><span class="n">Wave</span><span class="p">)]</span>
        <span class="n">_WaveDistance</span> <span class="p">(</span><span class="s">"Distance from player"</span><span class="p">,</span> <span class="kt">float</span><span class="p">)</span> <span class="o">=</span> <span class="mi">10</span>
        <span class="n">_WaveTrail</span> <span class="p">(</span><span class="s">"Length of the trail"</span><span class="p">,</span> <span class="n">Range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">5</span><span class="p">))</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="n">_WaveColor</span> <span class="p">(</span><span class="s">"Color"</span><span class="p">,</span> <span class="n">Color</span><span class="p">)</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
    <span class="p">}</span>

    <span class="n">SubShader</span><span class="p">{</span>
        <span class="c1">// markers that specify that we don't need culling</span>
        <span class="c1">// or comparing/writing to the depth buffer</span>
        <span class="n">Cull</span> <span class="n">Off</span>
        <span class="n">ZWrite</span> <span class="n">Off</span>
        <span class="n">ZTest</span> <span class="n">Always</span>

        <span class="n">Pass</span><span class="p">{</span>
            <span class="n">CGPROGRAM</span>
            <span class="c1">//include useful shader functions</span>
            <span class="cp">#include "UnityCG.cginc"
</span>
            <span class="c1">//define vertex and fragment shader</span>
            <span class="cp">#pragma vertex vert
</span>            <span class="cp">#pragma fragment frag
</span>
            <span class="c1">//the rendered screen so far</span>
            <span class="kt">sampler2D</span> <span class="n">_MainTex</span><span class="p">;</span>

            <span class="c1">//the depth texture</span>
            <span class="kt">sampler2D</span> <span class="n">_CameraDepthTexture</span><span class="p">;</span>

            <span class="c1">//variables to control the wave</span>
            <span class="kt">float</span> <span class="n">_WaveDistance</span><span class="p">;</span>
            <span class="kt">float</span> <span class="n">_WaveTrail</span><span class="p">;</span>
            <span class="n">float4</span> <span class="n">_WaveColor</span><span class="p">;</span>


            <span class="c1">//the object data that's put into the vertex shader</span>
            <span class="k">struct</span> <span class="n">appdata</span><span class="p">{</span>
                <span class="n">float4</span> <span class="n">vertex</span> <span class="o">:</span> <span class="n">POSITION</span><span class="p">;</span>
                <span class="n">float2</span> <span class="n">uv</span> <span class="o">:</span> <span class="n">TEXCOORD0</span><span class="p">;</span>
            <span class="p">};</span>

            <span class="c1">//the data that's used to generate fragments and can be read by the fragment shader</span>
            <span class="k">struct</span> <span class="n">v2f</span><span class="p">{</span>
                <span class="n">float4</span> <span class="n">position</span> <span class="o">:</span> <span class="n">SV_POSITION</span><span class="p">;</span>
                <span class="n">float2</span> <span class="n">uv</span> <span class="o">:</span> <span class="n">TEXCOORD0</span><span class="p">;</span>
            <span class="p">};</span>

            <span class="c1">//the vertex shader</span>
            <span class="n">v2f</span> <span class="n">vert</span><span class="p">(</span><span class="n">appdata</span> <span class="n">v</span><span class="p">){</span>
                <span class="n">v2f</span> <span class="n">o</span><span class="p">;</span>
                <span class="c1">//convert the vertex positions from object space to clip space so they can be rendered</span>
                <span class="n">o</span><span class="p">.</span><span class="n">position</span> <span class="o">=</span> <span class="n">UnityObjectToClipPos</span><span class="p">(</span><span class="n">v</span><span class="p">.</span><span class="n">vertex</span><span class="p">);</span>
                <span class="n">o</span><span class="p">.</span><span class="n">uv</span> <span class="o">=</span> <span class="n">v</span><span class="p">.</span><span class="n">uv</span><span class="p">;</span>
                <span class="k">return</span> <span class="n">o</span><span class="p">;</span>
            <span class="p">}</span>

            <span class="c1">//the fragment shader</span>
            <span class="n">fixed4</span> <span class="n">frag</span><span class="p">(</span><span class="n">v2f</span> <span class="n">i</span><span class="p">)</span> <span class="o">:</span> <span class="n">SV_TARGET</span><span class="p">{</span>
                <span class="c1">//get depth from depth texture</span>
                <span class="kt">float</span> <span class="n">depth</span> <span class="o">=</span> <span class="n">tex2D</span><span class="p">(</span><span class="n">_CameraDepthTexture</span><span class="p">,</span> <span class="n">i</span><span class="p">.</span><span class="n">uv</span><span class="p">).</span><span class="n">r</span><span class="p">;</span>
                <span class="c1">//linear depth between camera and far clipping plane</span>
                <span class="n">depth</span> <span class="o">=</span> <span class="n">Linear01Depth</span><span class="p">(</span><span class="n">depth</span><span class="p">);</span>
                <span class="c1">//depth as distance from camera in units</span>
                <span class="n">depth</span> <span class="o">=</span> <span class="n">depth</span> <span class="o">*</span> <span class="n">_ProjectionParams</span><span class="p">.</span><span class="n">z</span><span class="p">;</span>

                <span class="c1">//get source color</span>
                <span class="n">fixed4</span> <span class="n">source</span> <span class="o">=</span> <span class="n">tex2D</span><span class="p">(</span><span class="n">_MainTex</span><span class="p">,</span> <span class="n">i</span><span class="p">.</span><span class="n">uv</span><span class="p">);</span>
                <span class="c1">//skip wave and return source color if we're at the skybox</span>
                <span class="k">if</span><span class="p">(</span><span class="n">depth</span> <span class="o">&gt;=</span> <span class="n">_ProjectionParams</span><span class="p">.</span><span class="n">z</span><span class="p">)</span>
                    <span class="k">return</span> <span class="n">source</span><span class="p">;</span>

                <span class="c1">//calculate wave</span>
                <span class="kt">float</span> <span class="n">waveFront</span> <span class="o">=</span> <span class="n">step</span><span class="p">(</span><span class="n">depth</span><span class="p">,</span> <span class="n">_WaveDistance</span><span class="p">);</span>
                <span class="kt">float</span> <span class="n">waveTrail</span> <span class="o">=</span> <span class="n">smoothstep</span><span class="p">(</span><span class="n">_WaveDistance</span> <span class="o">-</span> <span class="n">_WaveTrail</span><span class="p">,</span> <span class="n">_WaveDistance</span><span class="p">,</span> <span class="n">depth</span><span class="p">);</span>
                <span class="kt">float</span> <span class="n">wave</span> <span class="o">=</span> <span class="n">waveFront</span> <span class="o">*</span> <span class="n">waveTrail</span><span class="p">;</span>

                <span class="c1">//mix wave into source color</span>
                <span class="n">fixed4</span> <span class="n">col</span> <span class="o">=</span> <span class="n">lerp</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="n">_WaveColor</span><span class="p">,</span> <span class="n">wave</span><span class="p">);</span>

                <span class="k">return</span> <span class="n">col</span><span class="p">;</span>
            <span class="p">}</span>
            <span class="n">ENDCG</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<div class="language-cs highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">using</span> <span class="nn">UnityEngine</span><span class="p">;</span>

<span class="c1">//behaviour which should lie on the same gameobject as the main camera</span>
<span class="k">public</span> <span class="k">class</span> <span class="nc">DepthPostprocessing</span> <span class="p">:</span> <span class="n">MonoBehaviour</span> <span class="p">{</span>
    <span class="c1">//material that's applied when doing postprocessing</span>
    <span class="p">[</span><span class="n">SerializeField</span><span class="p">]</span>
    <span class="k">private</span> <span class="n">Material</span> <span class="n">postprocessMaterial</span><span class="p">;</span>
    <span class="p">[</span><span class="n">SerializeField</span><span class="p">]</span>
    <span class="k">private</span> <span class="kt">float</span> <span class="n">waveSpeed</span><span class="p">;</span>
    <span class="p">[</span><span class="n">SerializeField</span><span class="p">]</span>
    <span class="k">private</span> <span class="kt">bool</span> <span class="n">waveActive</span><span class="p">;</span>

    <span class="k">private</span> <span class="kt">float</span> <span class="n">waveDistance</span><span class="p">;</span>

    <span class="k">private</span> <span class="k">void</span> <span class="nf">Start</span><span class="p">(){</span>
        <span class="c1">//get the camera and tell it to render a depth texture</span>
        <span class="n">Camera</span> <span class="n">cam</span> <span class="p">=</span> <span class="n">GetComponent</span><span class="p">&lt;</span><span class="n">Camera</span><span class="p">&gt;();</span>
        <span class="n">cam</span><span class="p">.</span><span class="n">depthTextureMode</span> <span class="p">=</span> <span class="n">cam</span><span class="p">.</span><span class="n">depthTextureMode</span> <span class="p">|</span> <span class="n">DepthTextureMode</span><span class="p">.</span><span class="n">Depth</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">private</span> <span class="k">void</span> <span class="nf">Update</span><span class="p">(){</span>
        <span class="c1">//if the wave is active, make it move away, otherwise reset it</span>
        <span class="k">if</span><span class="p">(</span><span class="n">waveActive</span><span class="p">){</span>
            <span class="n">waveDistance</span> <span class="p">=</span> <span class="n">waveDistance</span> <span class="p">+</span> <span class="n">waveSpeed</span> <span class="p">*</span> <span class="n">Time</span><span class="p">.</span><span class="n">deltaTime</span><span class="p">;</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="n">waveDistance</span> <span class="p">=</span> <span class="m">0</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="c1">//method which is automatically called by unity after the camera is done rendering</span>
    <span class="k">private</span> <span class="k">void</span> <span class="nf">OnRenderImage</span><span class="p">(</span><span class="n">RenderTexture</span> <span class="n">source</span><span class="p">,</span> <span class="n">RenderTexture</span> <span class="n">destination</span><span class="p">){</span>
        <span class="c1">//sync the distance from the script to the shader</span>
        <span class="n">postprocessMaterial</span><span class="p">.</span><span class="nf">SetFloat</span><span class="p">(</span><span class="s">"_WaveDistance"</span><span class="p">,</span> <span class="n">waveDistance</span><span class="p">);</span>
        <span class="c1">//draws the pixels from the source texture to the destination texture</span>
        <span class="n">Graphics</span><span class="p">.</span><span class="nf">Blit</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="n">destination</span><span class="p">,</span> <span class="n">postprocessMaterial</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>You can also find the source code for this tutorial here:<br />
<a href="https://github.com/ronja-tutorials/ShaderTutorials/blob/master/Assets/017_DepthPostprocessing/DepthPostprocessing.shader">https://github.com/ronja-tutorials/ShaderTutorials/blob/master/Assets/017_DepthPostprocessing/DepthPostprocessing.shader</a><br />
<a href="https://github.com/ronja-tutorials/ShaderTutorials/blob/master/Assets/017_DepthPostprocessing/DepthPostprocessing.cs">https://github.com/ronja-tutorials/ShaderTutorials/blob/master/Assets/017_DepthPostprocessing/DepthPostprocessing.cs</a><br /></p>

<p>I hope I was able to explain how to use the depth buffer for postprocessing effects and you’ll be able to make your own effects now.</p>


    <p>
        You can also find me on twitter at <a href="https://www.twitter.com/totallyRonja">@totallyRonja</a>. If you liked my tutorial and want to support me you can do that on Patreon (<a href="https://www.patreon.com/RonjaTutorials">patreon.com/RonjaTutorials</a>) or Ko-Fi (<a href="https://ko-fi.com/RonjaTutorials">ko-fi.com/RonjaTutorials</a>).
    </p>
  </div>

  
    <div id="disqus_thread"></div>
<script>

/**
*  RECOMMENDED CONFIGURATION VARIABLES: EDIT AND UNCOMMENT THE SECTION BELOW TO INSERT DYNAMIC VALUES FROM YOUR PLATFORM OR CMS.
*  LEARN WHY DEFINING THESE VARIABLES IS IMPORTANT: https://disqus.com/admin/universalcode/#configuration-variables*/
/*
var disqus_config = function () {
this.page.url = PAGE_URL;  // Replace PAGE_URL with your page's canonical URL variable
this.page.identifier = PAGE_IDENTIFIER; // Replace PAGE_IDENTIFIER with your page's unique identifier variable
};
*/
(function() { // DON'T EDIT BELOW THIS LINE
var d = document, s = d.createElement('script');
s.src = 'https://ronja-tutorials.disqus.com/embed.js';
s.setAttribute('data-timestamp', +new Date());
(d.head || d.body).appendChild(s);
})();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
                            
  
</article>


      <!-- SVG icons from https://iconmonstr.com -->

      <!-- Twitter icon -->
      <span class="my-span-icon">
          <a href="https://twitter.com/TotallyRonja" aria-label="'s Twitter" title="'s Twitter">
            <svg class="my-svg-icon" xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24" style="margin-top: 12px;margin-left: 13px;"><path d="M12 0c-6.627 0-12 5.373-12 12s5.373 12 12 12 12-5.373 12-12-5.373-12-12-12zm6.066 9.645c.183 4.04-2.83 8.544-8.164 8.544-1.622 0-3.131-.476-4.402-1.291 1.524.18 3.045-.244 4.252-1.189-1.256-.023-2.317-.854-2.684-1.995.451.086.895.061 1.298-.049-1.381-.278-2.335-1.522-2.304-2.853.388.215.83.344 1.301.359-1.279-.855-1.641-2.544-.889-3.835 1.416 1.738 3.533 2.881 5.92 3.001-.419-1.796.944-3.527 2.799-3.527.825 0 1.572.349 2.096.907.654-.128 1.27-.368 1.824-.697-.215.671-.67 1.233-1.263 1.589.581-.07 1.135-.224 1.649-.453-.384.578-.87 1.084-1.433 1.489z"/></svg>
          </a>
        </span>

        <!-- RSS icon -->
        
          <span class="my-span-icon">
            <a href="/feed.xml" aria-label="RSS feed" title="'s RSS feed">
              <svg class="my-svg-icon" xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24"><path d="M12 0c-6.627 0-12 5.373-12 12s5.373 12 12 12 12-5.373 12-12-5.373-12-12-12zm-3.374 17c-.897 0-1.626-.727-1.626-1.624s.729-1.624 1.626-1.624 1.626.727 1.626 1.624-.729 1.624-1.626 1.624zm3.885 0c-.03-3.022-2.485-5.474-5.511-5.504v-2.406c4.361.03 7.889 3.555 7.92 7.91h-2.409zm4.081 0c-.016-5.297-4.303-9.571-9.592-9.594v-2.406c6.623.023 11.985 5.384 12 12h-2.408z"/></svg>
            </a>
          </span>
        
        <!-- Contact icon -->
        
        
          <span class="my-span-icon">
            <a href="/about.html" aria-label="Contact" title="Contact ">
              <svg class="my-svg-icon" xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24"><path d="M12 .02c-6.627 0-12 5.373-12 12s5.373 12 12 12 12-5.373 12-12-5.373-12-12-12zm6.99 6.98l-6.99 5.666-6.991-5.666h13.981zm.01 10h-14v-8.505l7 5.673 7-5.672v8.504z"/></svg>
            </a>
          </span>
        
    </section>

    
      <script type="text/javascript">
        (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
        (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
        m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
        })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

        ga('create', 'UA-124040112-1', 'auto');
        ga('send', 'pageview');
      </script>
    
  </body>
</html>
