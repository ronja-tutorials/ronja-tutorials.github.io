<!DOCTYPE html>
<html lang="en">

  <head>

    <!-- Non social metatags -->
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <meta name="theme-color" content="#157878">

    

    <title>Postprocessing with Normal Texture</title>

    
      <!-- Update your html tag to include the itemscope and itemtype attributes. -->
<html itemscope itemtype="http://schema.org/Article">












<!-- Place this data between the <head> tags of your website -->

  <meta name="author" content="Ronja Böhringer">

<meta name="description" content="Summary Another piece of information we can easily get our hands on thats very useful for postprocessing is the normals of the scene. They show in wh..." />





<!-- Schema.org markup for Google+ -->
<meta itemprop="name" content="Postprocessing with Normal Texture">
<meta itemprop="description" content="Summary Another piece of information we can easily get our hands on thats very useful for postprocessing is the normals of the scene. They show in wh...">

  <meta itemprop="image" content="https://www.ronja-tutorials.com/assets/images/posts/018/Result.png">


<!-- Twitter Card data -->
<meta name="twitter:card" content="summary_large_image">



<meta name="twitter:title" content="Postprocessing with Normal Texture">
<meta name="twitter:description" content="Summary Another piece of information we can easily get our hands on thats very useful for postprocessing is the normals of the scene. They show in wh...">


  <meta name="twitter:creator" content="@TotallyRonja">


<!-- Twitter summary card with large image must be at least 280x150px -->

  <meta name="twitter:image:src" content="https://www.ronja-tutorials.com/assets/images/posts/018/Result.png">
  <meta property="twitter:image" content="https://www.ronja-tutorials.com/assets/images/posts/018/Result.png">

<meta property="twitter:url" content="https://www.ronja-tutorials.com/2018/07/08/postprocessing-normal.html">

<!-- Open Graph data -->
<meta property="og:title" content="Postprocessing with Normal Texture" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://www.ronja-tutorials.com/2018/07/08/postprocessing-normal.html" />

  <meta property="og:image" content="https://www.ronja-tutorials.com/assets/images/posts/018/Result.png" />

<meta property="og:description" content="Summary Another piece of information we can easily get our hands on thats very useful for postprocessing is the normals of the scene. They show in wh..." />
<meta property="og:site_name" content="Ronja's Shader Tutorials" />

  <meta property="article:published_time" content="2018-07-08T00:00:00+02:00" />














  





  




    

    <link rel="canonical" href="https://www.ronja-tutorials.com/2018/07/08/postprocessing-normal.html">

    

    <!-- <link rel="shortcut icon" href="https://www.ronja-tutorials.com/favicon.ico"> -->
    <meta name="robots" content="noarchive">

    <!-- <link rel="alternate" media="only screen and (max-width: 640px)" href="">
    <link rel="alternate" media="handheld" href=""> -->


    <link href='https://fonts.googleapis.com/css?family=Open+Sans:400,700' rel='stylesheet' type='text/css'>
    <script async defer data-website-id="fb34d410-ef67-4a3a-8fdc-01a05f5e22b2" src="https://stats.ruby0x1.ca/umami.js" ></script>
    <link rel="stylesheet" href="/assets/css/style.css?v=">
  </head>
  <body>

    <header class="site-header" role="banner">

  <div class="wrapper">
    
    

    
      <a class="site-title" href="/">Ronja&#39;s Shader Tutorials</a>
    
    <!-- SVG icons from https://iconmonstr.com -->

    <!-- Twitter icon -->
    <span class="my-span-icon">
        <a href="https://twitter.com/TotallyRonja" aria-label="'s Twitter" title="'s Twitter">
          <svg class="my-svg-icon" xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24" style="margin-top: 12px;margin-left: 13px;"><path d="M12 0c-6.627 0-12 5.373-12 12s5.373 12 12 12 12-5.373 12-12-5.373-12-12-12zm6.066 9.645c.183 4.04-2.83 8.544-8.164 8.544-1.622 0-3.131-.476-4.402-1.291 1.524.18 3.045-.244 4.252-1.189-1.256-.023-2.317-.854-2.684-1.995.451.086.895.061 1.298-.049-1.381-.278-2.335-1.522-2.304-2.853.388.215.83.344 1.301.359-1.279-.855-1.641-2.544-.889-3.835 1.416 1.738 3.533 2.881 5.92 3.001-.419-1.796.944-3.527 2.799-3.527.825 0 1.572.349 2.096.907.654-.128 1.27-.368 1.824-.697-.215.671-.67 1.233-1.263 1.589.581-.07 1.135-.224 1.649-.453-.384.578-.87 1.084-1.433 1.489z"/></svg>
        </a>
      </span>

      <!-- RSS icon -->
      
        <span class="my-span-icon">
          <a href="/feed.xml" aria-label="RSS feed" title="'s RSS feed">
            <svg class="my-svg-icon" xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24"><path d="M12 0c-6.627 0-12 5.373-12 12s5.373 12 12 12 12-5.373 12-12-5.373-12-12-12zm-3.374 17c-.897 0-1.626-.727-1.626-1.624s.729-1.624 1.626-1.624 1.626.727 1.626 1.624-.729 1.624-1.626 1.624zm3.885 0c-.03-3.022-2.485-5.474-5.511-5.504v-2.406c4.361.03 7.889 3.555 7.92 7.91h-2.409zm4.081 0c-.016-5.297-4.303-9.571-9.592-9.594v-2.406c6.623.023 11.985 5.384 12 12h-2.408z"/></svg>
          </a>
        </span>
      
      <!-- Contact icon -->
      
      
        <span class="my-span-icon">
          <a href="/about.html" aria-label="Contact" title="Contact ">
            <svg class="my-svg-icon" xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24"><path d="M12 .02c-6.627 0-12 5.373-12 12s5.373 12 12 12 12-5.373 12-12-5.373-12-12-12zm6.99 6.98l-6.99 5.666-6.991-5.666h13.981zm.01 10h-14v-8.505l7 5.673 7-5.672v8.504z"/></svg>
          </a>
        </span>
      

    
      <nav class="site-nav">
        <input type="checkbox" id="nav-trigger" class="nav-trigger" />
        <label for="nav-trigger">
          <span class="menu-icon">
            <svg viewBox="0 0 18 15" width="18px" height="15px">
              <path fill="#424242" d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.031C17.335,0,18,0.665,18,1.484L18,1.484z"/>
              <path fill="#424242" d="M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0c0-0.82,0.665-1.484,1.484-1.484 h15.031C17.335,6.031,18,6.696,18,7.516L18,7.516z"/>
              <path fill="#424242" d="M18,13.516C18,14.335,17.335,15,16.516,15H1.484C0.665,15,0,14.335,0,13.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.031C17.335,12.031,18,12.696,18,13.516L18,13.516z"/>
            </svg>
          </span>
        </label>

        <div class="trigger">
          
            
            
              
              
            
          
            
            
          
            
            
              
                <a class="page-link" href="/about.html">About</a>
              
            
          
            
            
          
            
            
          
            
            
          
            
            
          
            
            
              
                <a class="page-link" href="/2018/03/20/hlsl-basics.html"></a>
              
            
          
            
            
              
                <a class="page-link" href="/2018/03/20/hlsl-basics.html"></a>
              
            
          
            
            
              
                <a class="page-link" href="/2018/03/20/hlsl-basics.html"></a>
              
            
          
            
            
              
                <a class="page-link" href="/2018/03/20/hlsl-basics.html"></a>
              
            
          
            
            
          
            
            
          
        </div>
      </nav>
    
  </div>
</header>


    
    
    

    <section class="page-header">
      <h1 class="project-name">Postprocessing with Normal Texture</h1>
      <h2 class="project-tagline"></h2>
      
      <!-- Post tagline -->
      
        <h2 class="project-date">
        <time datetime="2018-07-08T00:00:00+02:00" itemprop="datePublished">
          
          Jul 8, 2018
        </time>
        
        
          • <span itemprop="author" itemscope itemtype="http://schema.org/Person"><span itemprop="name">Ronja Böhringer</span></span>
        
        </h2>
      
      <!-- End: Post tagline -->
    </section>

    <section class="main-content">

      <article itemscope itemtype="http://schema.org/BlogPosting">

  <!-- <header class="post-header">
    <h1 class="post-title" itemprop="name headline">Postprocessing with Normal Texture</h1>
    <p class="post-meta">
      <time datetime="2018-07-08T00:00:00+02:00" itemprop="datePublished">
        
        Jul 8, 2018
      </time>
      </p>
  </header> -->

  
<ul>
  <li><a href="#summary">Summary</a></li>
  <li><a href="#read-depth-and-normals">Read Depth and Normals</a></li>
  <li><a href="#color-the-top">Color the Top</a></li>
  <li><a href="#source">Source</a></li>
</ul>

  <div itemprop="articleBody">
    <h2 id="summary">Summary</h2>
<p>Another piece of information we can easily get our hands on thats very useful for postprocessing is the normals of the scene. They show in which direction the surface at any given pixel is pointing.</p>

<p>To understand how to get and use the normals of the scene it’s best to know how to access the scene depth first, I made a tutorial on how to do that <a href="/2018/07/08/postprocessing-normal.html">here</a>.</p>

<p><img src="/assets/images/posts/018/Result.png" alt="Result" /></p>

<h2 id="read-depth-and-normals">Read Depth and Normals</h2>
<p>We start this tutorials with the files from the depth postprocessing tutorial and expand them as we need.</p>

<p>The first change is to remove all of the code from the c# script which we used to drive the wave in the previous tutorial.
Then, we don‘t tell the camera to render the depth of objects anymore - instead we tell it to render a texture which includes the depth as well as the normals.</p>

<div class="language-cs highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">private</span> <span class="k">void</span> <span class="nf">Start</span><span class="p">(){</span>
    <span class="c1">//get the camera and tell it to render a depthnormals texture</span>
    <span class="n">cam</span> <span class="p">=</span> <span class="n">GetComponent</span><span class="p">&lt;</span><span class="n">Camera</span><span class="p">&gt;();</span>
    <span class="n">cam</span><span class="p">.</span><span class="n">depthTextureMode</span> <span class="p">=</span> <span class="n">cam</span><span class="p">.</span><span class="n">depthTextureMode</span> <span class="p">|</span> <span class="n">DepthTextureMode</span><span class="p">.</span><span class="n">DepthNormals</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>

<p>And that’s already all of the setup we need to access the normals. Next we edit our shader.</p>

<p>We also remove the all of the code used for the wave function here. Then we rename the _CameraDepthTexture to _CameraDepthNormalsTexture, so it’s written in by unity.</p>

<div class="language-glsl highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">//show values to edit in inspector</span>
<span class="n">Properties</span><span class="p">{</span>
    <span class="p">[</span><span class="n">HideInInspector</span><span class="p">]</span><span class="n">_MainTex</span> <span class="p">(</span><span class="s">"Texture"</span><span class="p">,</span> <span class="mi">2</span><span class="n">D</span><span class="p">)</span> <span class="o">=</span> <span class="s">"white"</span> <span class="p">{}</span>
<span class="p">}</span>
</code></pre></div></div>
<div class="language-glsl highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">//the depth normals texture</span>
<span class="kt">sampler2D</span> <span class="n">_CameraDepthNormalsTexture</span><span class="p">;</span>
</code></pre></div></div>

<p>With this setup we can now read from the depthnormals texture in our fragment shader. If we just do that and just draw the texture to the screen, we can already see something interresting.</p>

<div class="language-glsl highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">//the fragment shader</span>
<span class="n">fixed4</span> <span class="nf">frag</span><span class="p">(</span><span class="n">v2f</span> <span class="n">i</span><span class="p">)</span> <span class="o">:</span> <span class="n">SV_TARGET</span><span class="p">{</span>
    <span class="c1">//read depthnormal</span>
    <span class="n">float4</span> <span class="n">depthnormal</span> <span class="o">=</span> <span class="n">tex2D</span><span class="p">(</span><span class="n">_CameraDepthNormalsTexture</span><span class="p">,</span> <span class="n">i</span><span class="p">.</span><span class="n">uv</span><span class="p">);</span>

    <span class="k">return</span> <span class="n">depthnormal</span><span class="p">;</span>
<span class="err">}</span>
</code></pre></div></div>
<p><img src="/assets/images/posts/018/EncodedNormals.png" alt="a image where we can see depth and normals, but they are encoded so it looks kinda matte" /></p>

<p>But what we can see isn’t what we really want, we only see red and green values and some blue in the distance. That’s because as it’s name suggests, this texture holds the normals as well as the depth texture, so we have to decode it first. Luckily unity provides us a method that does exactly that. We have to give it the depthnormal value as well as two other values the function will write the depth and the normals in.</p>

<p>Unlike the depth texture, the depth value we have now is already linear between the camera and the far plane, so we can easily adapt the code from the previous tutorial to get the distance from the camera again.</p>

<div class="language-glsl highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">//the fragment shader</span>
<span class="n">fixed4</span> <span class="nf">frag</span><span class="p">(</span><span class="n">v2f</span> <span class="n">i</span><span class="p">)</span> <span class="o">:</span> <span class="n">SV_TARGET</span><span class="p">{</span>
    <span class="c1">//read depthnormal</span>
    <span class="n">float4</span> <span class="n">depthnormal</span> <span class="o">=</span> <span class="n">tex2D</span><span class="p">(</span><span class="n">_CameraDepthNormalsTexture</span><span class="p">,</span> <span class="n">i</span><span class="p">.</span><span class="n">uv</span><span class="p">);</span>

    <span class="c1">//decode depthnormal</span>
    <span class="n">float3</span> <span class="n">normal</span><span class="p">;</span>
    <span class="kt">float</span> <span class="n">depth</span><span class="p">;</span>
    <span class="n">DecodeDepthNormal</span><span class="p">(</span><span class="n">depthnormal</span><span class="p">,</span> <span class="n">depth</span><span class="p">,</span> <span class="n">normal</span><span class="p">);</span>

    <span class="c1">//get depth as distance from camera in units </span>
    <span class="n">depth</span> <span class="o">=</span> <span class="n">depth</span> <span class="o">*</span> <span class="n">_ProjectionParams</span><span class="p">.</span><span class="n">z</span><span class="p">;</span>

    <span class="k">return</span> <span class="n">depth</span><span class="p">;</span>
<span class="err">}</span>
</code></pre></div></div>
<p><img src="/assets/images/posts/018/Depth.png" alt="Depth texture" /></p>

<p>But let’s go back to using the normals. When we just print the normals as colors to the screen we already get a pretty good result.</p>

<div class="language-glsl highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">//the fragment shader</span>
<span class="n">fixed4</span> <span class="nf">frag</span><span class="p">(</span><span class="n">v2f</span> <span class="n">i</span><span class="p">)</span> <span class="o">:</span> <span class="n">SV_TARGET</span><span class="p">{</span>
    <span class="c1">//read depthnormal</span>
    <span class="n">float4</span> <span class="n">depthnormal</span> <span class="o">=</span> <span class="n">tex2D</span><span class="p">(</span><span class="n">_CameraDepthNormalsTexture</span><span class="p">,</span> <span class="n">i</span><span class="p">.</span><span class="n">uv</span><span class="p">);</span>

    <span class="c1">//decode depthnormal</span>
    <span class="n">float3</span> <span class="n">normal</span><span class="p">;</span>
    <span class="kt">float</span> <span class="n">depth</span><span class="p">;</span>
    <span class="n">DecodeDepthNormal</span><span class="p">(</span><span class="n">depthnormal</span><span class="p">,</span> <span class="n">depth</span><span class="p">,</span> <span class="n">normal</span><span class="p">);</span>

    <span class="c1">//get depth as distance from camera in units </span>
    <span class="n">depth</span> <span class="o">=</span> <span class="n">depth</span> <span class="o">*</span> <span class="n">_ProjectionParams</span><span class="p">.</span><span class="n">z</span><span class="p">;</span>

    <span class="k">return</span> <span class="nf">float4</span><span class="p">(</span><span class="n">normal</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
<span class="err">}</span>
</code></pre></div></div>
<p><img src="/assets/images/posts/018/DecodedNormals.gif" alt="" /></p>

<p>But if we rotate the camera, we can can see that one point on a surface doesn’t always have the same normal, that’s because the normals are stored relative to the camera. So if we want the normal in the world we have to go additional steps.</p>

<p>We can easily convert our viewspace normals to world space, but sadly unity doesn’t provide us a function for that so we have to pass it to our shader ourselves. So we go back to our C# script and implement that.</p>

<p>First we get a reference to our camera, we already get the camera in our start method, so we can directly save it to a class variable right there. Then in the OnRenderImage method we get the viewspace to worldspace matrix from the camera and then pass it to our shader. The reason we can’t pass the matrix to our shader once in the start method is that we want to move and rotate our camera after starting the effect and the matrix changes when we do that.</p>

<div class="language-glsl highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kr">using</span> <span class="n">UnityEngine</span><span class="p">;</span>

<span class="c1">//behaviour which should lie on the same gameobject as the main camera</span>
<span class="kr">public</span> <span class="kr">class</span> <span class="n">NormalPostprocessing</span> <span class="o">:</span> <span class="n">MonoBehaviour</span> <span class="p">{</span>
	<span class="c1">//material that's applied when doing postprocessing</span>
	<span class="p">[</span><span class="n">SerializeField</span><span class="p">]</span>
	<span class="n">private</span> <span class="n">Material</span> <span class="n">postprocessMaterial</span><span class="p">;</span>

	<span class="n">private</span> <span class="n">Camera</span> <span class="n">cam</span><span class="p">;</span>

	<span class="n">private</span> <span class="kt">void</span> <span class="n">Start</span><span class="p">(){</span>
		<span class="c1">//get the camera and tell it to render a depthnormals texture</span>
		<span class="n">cam</span> <span class="o">=</span> <span class="n">GetComponent</span><span class="o">&lt;</span><span class="n">Camera</span><span class="o">&gt;</span><span class="p">();</span>
		<span class="n">cam</span><span class="p">.</span><span class="n">depthTextureMode</span> <span class="o">=</span> <span class="n">cam</span><span class="p">.</span><span class="n">depthTextureMode</span> <span class="o">|</span> <span class="n">DepthTextureMode</span><span class="p">.</span><span class="n">DepthNormals</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="c1">//method which is automatically called by unity after the camera is done rendering</span>
	<span class="n">private</span> <span class="kt">void</span> <span class="n">OnRenderImage</span><span class="p">(</span><span class="n">RenderTexture</span> <span class="n">source</span><span class="p">,</span> <span class="n">RenderTexture</span> <span class="n">destination</span><span class="p">){</span>
		<span class="c1">//get viewspace to worldspace matrix and pass it to shader</span>
		<span class="n">Matrix4x4</span> <span class="n">viewToWorld</span> <span class="o">=</span> <span class="n">cam</span><span class="p">.</span><span class="n">cameraToWorldMatrix</span><span class="p">;</span>
		<span class="n">postprocessMaterial</span><span class="p">.</span><span class="n">SetMatrix</span><span class="p">(</span><span class="s">"_viewToWorld"</span><span class="p">,</span> <span class="n">viewToWorld</span><span class="p">);</span>
		<span class="c1">//draws the pixels from the source texture to the destination texture</span>
		<span class="n">Graphics</span><span class="p">.</span><span class="n">Blit</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="n">destination</span><span class="p">,</span> <span class="n">postprocessMaterial</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>Next we can use that matrix in our shader. we add a new variable for it and then multiply it with the normal before using it. We cast it to a 3x3 matrix before the multiplication so the position change doesn’t get applied only the rotation, that’s all we need for normals.</p>

<div class="language-glsl highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">//matrix to convert from view space to world space</span>
<span class="n">float4x4</span> <span class="n">_viewToWorld</span><span class="p">;</span>
</code></pre></div></div>
<div class="language-glsl highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    <span class="n">normal</span> <span class="o">=</span> <span class="n">normal</span> <span class="o">=</span> <span class="n">mul</span><span class="p">((</span><span class="n">float3x3</span><span class="p">)</span><span class="n">_viewToWorld</span><span class="p">,</span> <span class="n">normal</span><span class="p">);</span>
    <span class="k">return</span> <span class="nf">float4</span><span class="p">(</span><span class="n">normal</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
<span class="err">}</span>
</code></pre></div></div>
<p><img src="/assets/images/posts/018/WorldspaceNormals.gif" alt="" /></p>

<h2 id="color-the-top">Color the Top</h2>
<p>Now that we have the worldspace normals, we can do a simple effect to get comfortable with them. We can color the top of all objects in the scene in a color.</p>

<p>To do this, we simply compare the normal to the up vector. We do this via a dot product which returns 1 when both normalized vectors point in the same direction(when the surface is flat), 0 when they’re orthogonal (in our case on walls) and -1 when they’re opposite to each other(in our case that would mean a roof over the camera).</p>

<div class="language-glsl highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    <span class="kt">float</span> <span class="n">up</span> <span class="o">=</span> <span class="n">dot</span><span class="p">(</span><span class="n">float3</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">),</span> <span class="n">normal</span><span class="p">);</span>
    <span class="k">return</span> <span class="n">up</span><span class="p">;</span>
<span class="err">}</span>
</code></pre></div></div>
<p><img src="/assets/images/posts/018/Topness.png" alt="" /></p>

<p>To make it more obvious what’s on top and what doesn’t count as on top, we can now take this smooth value and do a step to differentiate between top and not on top. If the second value is smaller, it will return 0 and we will see black, if it’s bigger, we will see white.</p>

<div class="language-glsl highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">float</span> <span class="n">up</span> <span class="o">=</span> <span class="n">dot</span><span class="p">(</span><span class="n">float3</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">),</span> <span class="n">normal</span><span class="p">);</span>
<span class="n">up</span> <span class="o">=</span> <span class="n">step</span><span class="p">(</span><span class="mi">0</span><span class="p">.</span><span class="mi">5</span><span class="p">,</span> <span class="n">up</span><span class="p">);</span>
<span class="k">return</span> <span class="n">up</span><span class="p">;</span>
</code></pre></div></div>
<p><img src="/assets/images/posts/018/TopCutoff.png" alt="" /></p>

<p>The next step is to bring back the original colors where we don’t define the surface to be on top. For that we just read from the main texture and then do a linear interpolation between that color and the color we define to be on top (white at the moment).</p>

<div class="language-glsl highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">float</span> <span class="n">up</span> <span class="o">=</span> <span class="n">dot</span><span class="p">(</span><span class="n">float3</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">),</span> <span class="n">normal</span><span class="p">);</span>
<span class="n">up</span> <span class="o">=</span> <span class="n">step</span><span class="p">(</span><span class="mi">0</span><span class="p">.</span><span class="mi">5</span><span class="p">,</span> <span class="n">up</span><span class="p">);</span>
<span class="n">float4</span> <span class="n">source</span> <span class="o">=</span> <span class="n">tex2D</span><span class="p">(</span><span class="n">_MainTex</span><span class="p">,</span> <span class="n">i</span><span class="p">.</span><span class="n">uv</span><span class="p">);</span>
<span class="n">float4</span> <span class="n">col</span> <span class="o">=</span> <span class="n">lerp</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="n">float4</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span> <span class="n">up</span><span class="p">);</span>
<span class="k">return</span> <span class="n">col</span><span class="p">;</span>
</code></pre></div></div>
<p><img src="/assets/images/posts/018/WhiteTop.png" alt="" /></p>

<p>And as a last step we’re going to add some customizability. So we add a property and a global variable for the up cutoff value and the top color.</p>

<div class="language-glsl highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">_upCutoff</span> <span class="p">(</span><span class="s">"up cutoff"</span><span class="p">,</span> <span class="n">Range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">))</span> <span class="o">=</span> <span class="mi">0</span><span class="p">.</span><span class="mi">7</span>
<span class="n">_topColor</span> <span class="p">(</span><span class="s">"top color"</span><span class="p">,</span> <span class="n">Color</span><span class="p">)</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
</code></pre></div></div>
<div class="language-glsl highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">//effect customisation</span>
<span class="kt">float</span> <span class="n">_upCutoff</span><span class="p">;</span>
<span class="n">float4</span> <span class="n">_topColor</span><span class="p">;</span>
</code></pre></div></div>

<p>Then we replace the fixed 0.5 we used previously for our cutoff value with the new cutoff variable and linearly interpolate to the top color instead of the fix white color. We can then also multiply the up color with the alpha value of the top color, that way when we lower the alpha value the top will let some of the original color through.</p>

<div class="language-glsl highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    <span class="kt">float</span> <span class="n">up</span> <span class="o">=</span> <span class="n">dot</span><span class="p">(</span><span class="n">float3</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">),</span> <span class="n">normal</span><span class="p">);</span>
    <span class="n">up</span> <span class="o">=</span> <span class="n">step</span><span class="p">(</span><span class="n">_upCutoff</span><span class="p">,</span> <span class="n">up</span><span class="p">);</span>
    <span class="n">float4</span> <span class="n">source</span> <span class="o">=</span> <span class="n">tex2D</span><span class="p">(</span><span class="n">_MainTex</span><span class="p">,</span> <span class="n">i</span><span class="p">.</span><span class="n">uv</span><span class="p">);</span>
    <span class="n">float4</span> <span class="n">col</span> <span class="o">=</span> <span class="n">lerp</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="n">_topColor</span><span class="p">,</span> <span class="n">up</span> <span class="o">*</span> <span class="n">_topColor</span><span class="p">.</span><span class="n">a</span><span class="p">);</span>
    <span class="k">return</span> <span class="n">col</span><span class="p">;</span>
<span class="err">}</span>
</code></pre></div></div>
<p><img src="/assets/images/posts/018/Result.png" alt="" /></p>

<p>This effect was mainly made to show how the depthnormals texture works. If you want a snow effect it’s probably better to just do it in the shader for the object the snow is on instead of a postprocessing effect. I’m sorry I didn’t come up with a better example.</p>

<h2 id="source">Source</h2>
<div class="language-glsl highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kr">using</span> <span class="n">UnityEngine</span><span class="p">;</span>

<span class="c1">//behaviour which should lie on the same gameobject as the main camera</span>
<span class="kr">public</span> <span class="kr">class</span> <span class="n">NormalPostprocessing</span> <span class="o">:</span> <span class="n">MonoBehaviour</span> <span class="p">{</span>
    <span class="c1">//material that's applied when doing postprocessing</span>
    <span class="p">[</span><span class="n">SerializeField</span><span class="p">]</span>
    <span class="n">private</span> <span class="n">Material</span> <span class="n">postprocessMaterial</span><span class="p">;</span>

    <span class="n">private</span> <span class="n">Camera</span> <span class="n">cam</span><span class="p">;</span>

    <span class="n">private</span> <span class="kt">void</span> <span class="n">Start</span><span class="p">(){</span>
        <span class="c1">//get the camera and tell it to render a depthnormals texture</span>
        <span class="n">cam</span> <span class="o">=</span> <span class="n">GetComponent</span><span class="o">&lt;</span><span class="n">Camera</span><span class="o">&gt;</span><span class="p">();</span>
        <span class="n">cam</span><span class="p">.</span><span class="n">depthTextureMode</span> <span class="o">=</span> <span class="n">cam</span><span class="p">.</span><span class="n">depthTextureMode</span> <span class="o">|</span> <span class="n">DepthTextureMode</span><span class="p">.</span><span class="n">DepthNormals</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="c1">//method which is automatically called by unity after the camera is done rendering</span>
    <span class="n">private</span> <span class="kt">void</span> <span class="n">OnRenderImage</span><span class="p">(</span><span class="n">RenderTexture</span> <span class="n">source</span><span class="p">,</span> <span class="n">RenderTexture</span> <span class="n">destination</span><span class="p">){</span>
        <span class="c1">//get viewspace to worldspace matrix and pass it to shader</span>
        <span class="n">Matrix4x4</span> <span class="n">viewToWorld</span> <span class="o">=</span> <span class="n">cam</span><span class="p">.</span><span class="n">cameraToWorldMatrix</span><span class="p">;</span>
        <span class="n">postprocessMaterial</span><span class="p">.</span><span class="n">SetMatrix</span><span class="p">(</span><span class="s">"_viewToWorld"</span><span class="p">,</span> <span class="n">viewToWorld</span><span class="p">);</span>
        <span class="c1">//draws the pixels from the source texture to the destination texture</span>
        <span class="n">Graphics</span><span class="p">.</span><span class="n">Blit</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="n">destination</span><span class="p">,</span> <span class="n">postprocessMaterial</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>
<div class="language-glsl highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">Shader</span> <span class="s">"Tutorial/018_Normal_Postprocessing"</span><span class="p">{</span>
    <span class="c1">//show values to edit in inspector</span>
    <span class="n">Properties</span><span class="p">{</span>
        <span class="p">[</span><span class="n">HideInInspector</span><span class="p">]</span><span class="n">_MainTex</span> <span class="p">(</span><span class="s">"Texture"</span><span class="p">,</span> <span class="mi">2</span><span class="n">D</span><span class="p">)</span> <span class="o">=</span> <span class="s">"white"</span> <span class="p">{}</span>
        <span class="n">_upCutoff</span> <span class="p">(</span><span class="s">"up cutoff"</span><span class="p">,</span> <span class="n">Range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">))</span> <span class="o">=</span> <span class="mi">0</span><span class="p">.</span><span class="mi">7</span>
        <span class="n">_topColor</span> <span class="p">(</span><span class="s">"top color"</span><span class="p">,</span> <span class="n">Color</span><span class="p">)</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
    <span class="p">}</span>

    <span class="n">SubShader</span><span class="p">{</span>
        <span class="c1">// markers that specify that we don't need culling </span>
        <span class="c1">// or comparing/writing to the depth buffer</span>
        <span class="n">Cull</span> <span class="n">Off</span>
        <span class="n">ZWrite</span> <span class="n">Off</span> 
        <span class="n">ZTest</span> <span class="n">Always</span>

        <span class="n">Pass</span><span class="p">{</span>
            <span class="n">CGPROGRAM</span>
            <span class="c1">//include useful shader functions</span>
            <span class="cp">#include "UnityCG.cginc"
</span>
            <span class="c1">//define vertex and fragment shader</span>
            <span class="cp">#pragma vertex vert
</span>            <span class="cp">#pragma fragment frag
</span>
            <span class="c1">//the rendered screen so far</span>
            <span class="kt">sampler2D</span> <span class="n">_MainTex</span><span class="p">;</span>
            <span class="c1">//matrix to convert from view space to world space</span>
            <span class="n">float4x4</span> <span class="n">_viewToWorld</span><span class="p">;</span>
            <span class="c1">//the depth normals texture</span>
            <span class="kt">sampler2D</span> <span class="n">_CameraDepthNormalsTexture</span><span class="p">;</span>

            <span class="c1">//effect customisation</span>
            <span class="kt">float</span> <span class="n">_upCutoff</span><span class="p">;</span>
            <span class="n">float4</span> <span class="n">_topColor</span><span class="p">;</span>


            <span class="c1">//the object data that's put into the vertex shader</span>
            <span class="k">struct</span> <span class="n">appdata</span><span class="p">{</span>
                <span class="n">float4</span> <span class="n">vertex</span> <span class="o">:</span> <span class="n">POSITION</span><span class="p">;</span>
                <span class="n">float2</span> <span class="n">uv</span> <span class="o">:</span> <span class="n">TEXCOORD0</span><span class="p">;</span>
            <span class="p">};</span>

            <span class="c1">//the data that's used to generate fragments and can be read by the fragment shader</span>
            <span class="k">struct</span> <span class="n">v2f</span><span class="p">{</span>
                <span class="n">float4</span> <span class="n">position</span> <span class="o">:</span> <span class="n">SV_POSITION</span><span class="p">;</span>
                <span class="n">float2</span> <span class="n">uv</span> <span class="o">:</span> <span class="n">TEXCOORD0</span><span class="p">;</span>
            <span class="p">};</span>

            <span class="c1">//the vertex shader</span>
            <span class="n">v2f</span> <span class="n">vert</span><span class="p">(</span><span class="n">appdata</span> <span class="n">v</span><span class="p">){</span>
                <span class="n">v2f</span> <span class="n">o</span><span class="p">;</span>
                <span class="c1">//convert the vertex positions from object space to clip space so they can be rendered</span>
                <span class="n">o</span><span class="p">.</span><span class="n">position</span> <span class="o">=</span> <span class="n">UnityObjectToClipPos</span><span class="p">(</span><span class="n">v</span><span class="p">.</span><span class="n">vertex</span><span class="p">);</span>
                <span class="n">o</span><span class="p">.</span><span class="n">uv</span> <span class="o">=</span> <span class="n">v</span><span class="p">.</span><span class="n">uv</span><span class="p">;</span>
                <span class="k">return</span> <span class="n">o</span><span class="p">;</span>
            <span class="p">}</span>

            <span class="c1">//the fragment shader</span>
            <span class="n">fixed4</span> <span class="n">frag</span><span class="p">(</span><span class="n">v2f</span> <span class="n">i</span><span class="p">)</span> <span class="o">:</span> <span class="n">SV_TARGET</span><span class="p">{</span>
                <span class="c1">//read depthnormal</span>
                <span class="n">float4</span> <span class="n">depthnormal</span> <span class="o">=</span> <span class="n">tex2D</span><span class="p">(</span><span class="n">_CameraDepthNormalsTexture</span><span class="p">,</span> <span class="n">i</span><span class="p">.</span><span class="n">uv</span><span class="p">);</span>

                <span class="c1">//decode depthnormal</span>
                <span class="n">float3</span> <span class="n">normal</span><span class="p">;</span>
                <span class="kt">float</span> <span class="n">depth</span><span class="p">;</span>
                <span class="n">DecodeDepthNormal</span><span class="p">(</span><span class="n">depthnormal</span><span class="p">,</span> <span class="n">depth</span><span class="p">,</span> <span class="n">normal</span><span class="p">);</span>

                <span class="c1">//get depth as distance from camera in units </span>
                <span class="n">depth</span> <span class="o">=</span> <span class="n">depth</span> <span class="o">*</span> <span class="n">_ProjectionParams</span><span class="p">.</span><span class="n">z</span><span class="p">;</span>

                <span class="n">normal</span> <span class="o">=</span> <span class="n">mul</span><span class="p">((</span><span class="n">float3x3</span><span class="p">)</span><span class="n">_viewToWorld</span><span class="p">,</span> <span class="n">normal</span><span class="p">);</span>

                <span class="kt">float</span> <span class="n">up</span> <span class="o">=</span> <span class="n">dot</span><span class="p">(</span><span class="n">float3</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">),</span> <span class="n">normal</span><span class="p">);</span>
                <span class="n">up</span> <span class="o">=</span> <span class="n">step</span><span class="p">(</span><span class="n">_upCutoff</span><span class="p">,</span> <span class="n">up</span><span class="p">);</span>
                <span class="n">float4</span> <span class="n">source</span> <span class="o">=</span> <span class="n">tex2D</span><span class="p">(</span><span class="n">_MainTex</span><span class="p">,</span> <span class="n">i</span><span class="p">.</span><span class="n">uv</span><span class="p">);</span>
                <span class="n">float4</span> <span class="n">col</span> <span class="o">=</span> <span class="n">lerp</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="n">_topColor</span><span class="p">,</span> <span class="n">up</span> <span class="o">*</span> <span class="n">_topColor</span><span class="p">.</span><span class="n">a</span><span class="p">);</span>
                <span class="k">return</span> <span class="n">col</span><span class="p">;</span>
            <span class="p">}</span>
            <span class="n">ENDCG</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>You can also find the source here:<br />
<a href="https://github.com/ronja-tutorials/ShaderTutorials/blob/master/Assets/018_NormalPostprocessing/NormalPostprocessing.cs">https://github.com/ronja-tutorials/ShaderTutorials/blob/master/Assets/018_NormalPostprocessing/NormalPostprocessing.cs</a>
<a href="https://github.com/ronja-tutorials/ShaderTutorials/blob/master/Assets/018_NormalPostprocessing/NormalPostprocessing.shader">https://github.com/ronja-tutorials/ShaderTutorials/blob/master/Assets/018_NormalPostprocessing/NormalPostprocessing.shader</a></p>

<p>I hope that I was able to convey how to access normal textures and that this will be a solid foundation for future effects.</p>


    <p>
        You can also find me on twitter at <a href="https://www.twitter.com/totallyRonja">@totallyRonja</a>. If you liked my tutorial and want to support me you can do that on Patreon (<a href="https://www.patreon.com/RonjaTutorials">patreon.com/RonjaTutorials</a>) or Ko-Fi (<a href="https://ko-fi.com/RonjaTutorials">ko-fi.com/RonjaTutorials</a>).
    </p>
  </div>

  
    <div id="disqus_thread"></div>
<script>

/**
*  RECOMMENDED CONFIGURATION VARIABLES: EDIT AND UNCOMMENT THE SECTION BELOW TO INSERT DYNAMIC VALUES FROM YOUR PLATFORM OR CMS.
*  LEARN WHY DEFINING THESE VARIABLES IS IMPORTANT: https://disqus.com/admin/universalcode/#configuration-variables*/
/*
var disqus_config = function () {
this.page.url = PAGE_URL;  // Replace PAGE_URL with your page's canonical URL variable
this.page.identifier = PAGE_IDENTIFIER; // Replace PAGE_IDENTIFIER with your page's unique identifier variable
};
*/
(function() { // DON'T EDIT BELOW THIS LINE
var d = document, s = d.createElement('script');
s.src = 'https://ronja-tutorials.disqus.com/embed.js';
s.setAttribute('data-timestamp', +new Date());
(d.head || d.body).appendChild(s);
})();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
                            
  
</article>


      <!-- SVG icons from https://iconmonstr.com -->

      <!-- Twitter icon -->
      <span class="my-span-icon">
          <a href="https://twitter.com/TotallyRonja" aria-label="'s Twitter" title="'s Twitter">
            <svg class="my-svg-icon" xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24" style="margin-top: 12px;margin-left: 13px;"><path d="M12 0c-6.627 0-12 5.373-12 12s5.373 12 12 12 12-5.373 12-12-5.373-12-12-12zm6.066 9.645c.183 4.04-2.83 8.544-8.164 8.544-1.622 0-3.131-.476-4.402-1.291 1.524.18 3.045-.244 4.252-1.189-1.256-.023-2.317-.854-2.684-1.995.451.086.895.061 1.298-.049-1.381-.278-2.335-1.522-2.304-2.853.388.215.83.344 1.301.359-1.279-.855-1.641-2.544-.889-3.835 1.416 1.738 3.533 2.881 5.92 3.001-.419-1.796.944-3.527 2.799-3.527.825 0 1.572.349 2.096.907.654-.128 1.27-.368 1.824-.697-.215.671-.67 1.233-1.263 1.589.581-.07 1.135-.224 1.649-.453-.384.578-.87 1.084-1.433 1.489z"/></svg>
          </a>
        </span>

        <!-- RSS icon -->
        
          <span class="my-span-icon">
            <a href="/feed.xml" aria-label="RSS feed" title="'s RSS feed">
              <svg class="my-svg-icon" xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24"><path d="M12 0c-6.627 0-12 5.373-12 12s5.373 12 12 12 12-5.373 12-12-5.373-12-12-12zm-3.374 17c-.897 0-1.626-.727-1.626-1.624s.729-1.624 1.626-1.624 1.626.727 1.626 1.624-.729 1.624-1.626 1.624zm3.885 0c-.03-3.022-2.485-5.474-5.511-5.504v-2.406c4.361.03 7.889 3.555 7.92 7.91h-2.409zm4.081 0c-.016-5.297-4.303-9.571-9.592-9.594v-2.406c6.623.023 11.985 5.384 12 12h-2.408z"/></svg>
            </a>
          </span>
        
        <!-- Contact icon -->
        
        
          <span class="my-span-icon">
            <a href="/about.html" aria-label="Contact" title="Contact ">
              <svg class="my-svg-icon" xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24"><path d="M12 .02c-6.627 0-12 5.373-12 12s5.373 12 12 12 12-5.373 12-12-5.373-12-12-12zm6.99 6.98l-6.99 5.666-6.991-5.666h13.981zm.01 10h-14v-8.505l7 5.673 7-5.672v8.504z"/></svg>
            </a>
          </span>
        
    </section>

    
      <script type="text/javascript">
        (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
        (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
        m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
        })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

        ga('create', 'UA-124040112-1', 'auto');
        ga('send', 'pageview');
      </script>
    
  </body>
</html>
